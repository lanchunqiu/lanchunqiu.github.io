<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>序列化和反序列化一个二叉树</title>
      <link href="/2019/03/23/SerializeAndDeserializeBinaryTree/"/>
      <url>/2019/03/23/SerializeAndDeserializeBinaryTree/</url>
      
        <content type="html"><![CDATA[<h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>序列化是将一个数据结构或者对象转换为连续的比特位的操作，进而可以将转换后的数据存储在一个文件或者内存中，同时也可以通过网络传输到另一个计算机环境，采取相反方式重构得到原数据。</p><p>请设计一个算法来实现二叉树的序列化与反序列化。这里不限定你的序列 / 反序列化算法执行逻辑，你只需要保证一个二叉树可以被序列化为一个字符串并且将这个字符串反序列化为原始的树结构。</p><p><strong>示例：</strong></p><pre><code>你可以将以下二叉树：    1   / \  2   3     / \    4   5序列化为 &quot;[1,2,3,null,null,4,5]&quot;</code></pre><p><strong>提示:</strong> 这与 LeetCode 目前使用的方式一致，详情请参阅 <a href="https://leetcode-cn.com/faq/#binary-tree" target="_blank" rel="noopener">LeetCode 序列化二叉树的格式</a>。你并非必须采取这种方式，你也可以采用其他的方法解决这个问题。</p><p><strong>说明:</strong> 不要使用类的成员 / 全局 / 静态变量来存储状态，你的序列化和反序列化算法应该是无状态的。</p><h2 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h2><p>通过二叉树先序遍历实现序列化和反序列化：通过先序遍历把二叉树输出为指定格式的字符串。</p><p>具体的序列化步骤为：初识时treeStr=””，先序遍历二叉树，遇到节点为null时，就拼上字符<code>#</code>，每个节点之间使用字符<code>!</code>来分割，示例中的二叉树的序列化结果为<code>1!2!#!#!3!4!#!#!5!#!#!</code>。</p><p>二叉树的节点结构</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TreeNode</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    T data<span class="token punctuation">;</span>    TreeNode left<span class="token punctuation">;</span>    TreeNode right<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">TreeNode</span><span class="token punctuation">(</span>T data<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>二叉树的序列化</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 序列化</span><span class="token keyword">public</span> String <span class="token function">serialize</span><span class="token punctuation">(</span>TreeNode root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> String split <span class="token operator">=</span> <span class="token string">"!"</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> String emptyNode <span class="token operator">=</span> <span class="token string">"#"</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> emptyNode <span class="token operator">+</span> split<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 先序遍历（递归）</span>    StringBuilder treeStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    treeStr<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span><span class="token punctuation">;</span>    treeStr<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    treeStr<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> treeStr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>二叉树的反序列化</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 反序列化</span><span class="token keyword">public</span> TreeNode <span class="token function">deserialize</span><span class="token punctuation">(</span>String data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> String split <span class="token operator">=</span> <span class="token string">"!"</span><span class="token punctuation">;</span>    String<span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span><span class="token punctuation">;</span>    Queue<span class="token operator">&lt;</span>String<span class="token operator">></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>a<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 递归构建二叉树</span>    <span class="token keyword">return</span> <span class="token function">buildBinaryTree</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">private</span> TreeNode <span class="token function">buildBinaryTree</span><span class="token punctuation">(</span>Queue<span class="token operator">&lt;</span>String<span class="token operator">></span> queue<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">final</span> String emptyNode <span class="token operator">=</span> <span class="token string">"#"</span><span class="token punctuation">;</span>    String value <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    TreeNode node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    node<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token function">buildBinaryTree</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>    node<span class="token punctuation">.</span>right<span class="token operator">=</span> <span class="token function">buildBinaryTree</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> node<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>测试</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 二叉树的序列化和反序列化 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Codec</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        TreeNode node1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TreeNode node2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TreeNode node3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TreeNode node4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TreeNode node5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        node1<span class="token punctuation">.</span>left <span class="token operator">=</span> node2<span class="token punctuation">;</span>        node1<span class="token punctuation">.</span>right <span class="token operator">=</span> node3<span class="token punctuation">;</span>        node3<span class="token punctuation">.</span>left <span class="token operator">=</span> node4<span class="token punctuation">;</span>        node3<span class="token punctuation">.</span>right <span class="token operator">=</span> node5<span class="token punctuation">;</span>        Codec test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Codec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String treeStr <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>node1<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>treeStr<span class="token punctuation">)</span><span class="token punctuation">;</span>        TreeNode head <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>treeStr<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 序列化</span>    <span class="token keyword">public</span> String <span class="token function">serialize</span><span class="token punctuation">(</span>TreeNode root<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> String split <span class="token operator">=</span> <span class="token string">"!"</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> String emptyNode <span class="token operator">=</span> <span class="token string">"#"</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>root <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> emptyNode <span class="token operator">+</span> split<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 先序遍历（递归）</span>        StringBuilder treeStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        treeStr<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span><span class="token punctuation">;</span>        treeStr<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        treeStr<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> treeStr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 反序列化</span>    <span class="token keyword">public</span> TreeNode <span class="token function">deserialize</span><span class="token punctuation">(</span>String data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> String split <span class="token operator">=</span> <span class="token string">"!"</span><span class="token punctuation">;</span>        String<span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span><span class="token punctuation">;</span>        Queue<span class="token operator">&lt;</span>String<span class="token operator">></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>a<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 递归构建二叉树</span>        <span class="token keyword">return</span> <span class="token function">buildBinaryTree</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> TreeNode <span class="token function">buildBinaryTree</span><span class="token punctuation">(</span>Queue<span class="token operator">&lt;</span>String<span class="token operator">></span> queue<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">final</span> String emptyNode <span class="token operator">=</span> <span class="token string">"#"</span><span class="token punctuation">;</span>        String value <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        TreeNode node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        node<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token function">buildBinaryTree</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>        node<span class="token punctuation">.</span>right<span class="token operator">=</span> <span class="token function">buildBinaryTree</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> node<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：<span class="token number">1</span><span class="token operator">!</span><span class="token number">2</span><span class="token operator">!</span>#<span class="token operator">!</span>#<span class="token operator">!</span><span class="token number">3</span><span class="token operator">!</span><span class="token number">4</span><span class="token operator">!</span>#<span class="token operator">!</span>#<span class="token operator">!</span><span class="token number">5</span><span class="token operator">!</span>#<span class="token operator">!</span>#<span class="token operator">!</span><span class="token number">1</span><span class="token operator">!</span><span class="token number">2</span><span class="token operator">!</span>#<span class="token operator">!</span>#<span class="token operator">!</span><span class="token number">3</span><span class="token operator">!</span><span class="token number">4</span><span class="token operator">!</span>#<span class="token operator">!</span>#<span class="token operator">!</span><span class="token number">5</span><span class="token operator">!</span>#<span class="token operator">!</span>#<span class="token operator">!</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 二叉树 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> LeetCode </tag>
            
            <tag> 二叉树 </tag>
            
            <tag> 序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis实战</title>
      <link href="/2019/03/20/RedisInAction/"/>
      <url>/2019/03/20/RedisInAction/</url>
      
        <content type="html"><![CDATA[<h2 id="初识Redis"><a href="#初识Redis" class="headerlink" title="初识Redis"></a>初识Redis</h2><p>一般来说，缓存可以分为两大类：</p><ul><li>应用内缓存，比如Java的Map、Set等简单数据结构，以及Ehcache等三方库；</li><li>独立的缓存服务（组件），比如Memcached、Redis；</li></ul><p>Redis（Remote Dictionary Server）远程字典服务器，它是一种基于key-value的高性能的存储系统，它提供了5种键值数据类型来适应不同场景下的缓存与存储需求。Redis是一种速度非常快的非关系数据库，它除了性能强劲之外还具有复制、持久化、分片、事物等特性，用户可以很方便地将Redis扩展成一个能够包含数百G数据、每秒处理上百万次请求的系统。</p><p>如下表Redis和其他一些非关系数据库的比较。</p><table><thead><tr><th>名称</th><th>类型</th><th>数据存储</th><th>特性</th></tr></thead><tbody><tr><td>Redis</td><td>内存存储非关系键值数据库</td><td>字符串、列表、散列、集合、有序集合</td><td>主从复制、持久化、分片、发布与订阅，Lua脚本</td></tr><tr><td>Memcached</td><td>内存存储键值缓存</td><td>键值关系映射</td><td></td></tr><tr><td>MongoDB</td><td>硬盘存储非关系文档型数据库</td><td>BSON文档（类似json格式）</td><td>支持Map-Reduce操作、主从复制、分片、空间索引</td></tr></tbody></table><h2 id="Redis的安装"><a href="#Redis的安装" class="headerlink" title="Redis的安装"></a>Redis的安装</h2><p>Redis约定次版本号（第一个小数点后的数字）为偶数是稳定版本，例如2.8、3.0、3.2，次版本号为基数时是非稳定版本。</p><h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><ol><li>下载Redis安装包，<a href="http://download.redis.io/releases/" target="_blank" rel="noopener">http://download.redis.io/releases/</a></li><li>tar -zxvf解压安装包;</li><li>cd到解压后的目录;</li><li>执行make编译;</li><li>测试编译状态， make test;</li><li>make install {prefix=/path/…/…}  安装;</li></ol><h3 id="启动和停止"><a href="#启动和停止" class="headerlink" title="启动和停止"></a>启动和停止</h3><p>Redis安装完成之后，会自动生成一些可执行文件：</p><ul><li><p><strong>redis-server</strong>：redis服务端</p></li><li><p><strong>redis-cli</strong>：redis命令行客户端</p></li><li><p><strong>redis-sentinel</strong>：sentinel服务（2.8以后）</p></li><li><p><strong>redis-check-rdb</strong>：rdb文件检查工具</p></li><li><p><strong>redis-check-aof</strong>：aof文件修复工具</p></li><li><p><strong>redis-benchmark</strong>：redis性能测试工具</p></li></ul><p>常用的命令是redis-server和redis-cli</p><p>1.启动服务</p><pre><code>redis-server /path/redis.conf</code></pre><p>服务器启动后默认端口是6379，可以–port自定义端口。（6379在手机键盘上与MERZ对应，MERZ是一名意大利歌女的名字）如果想以守护进程的方式启动，需要修改redis.conf配置文件，把daemonize设置为yes。</p><p>2.停止服务</p><pre><code>redis-cli shutdown</code></pre><p>考虑到Redis服务有可能正在将内存的数据同步到磁盘中，强行终止Redis进程可能会导致数据丢失，正确停止Redis的方式是向Redis发送shutdown命令。当Redis服务收到shutdown命令后，会先断开所有客户端连接，然后根据配置进行持久化，最终完成退出。</p><h2 id="数据结构类型"><a href="#数据结构类型" class="headerlink" title="数据结构类型"></a>数据结构类型</h2><p>Redis可以存储键与5种不同数据结构类型之间的映射，这5种数据结构类型分别为字符串（string），列表（list），集合（set），有序集合（zset），哈希（hash）。</p><p><strong>Redis提供的5种数据结构类型</strong></p><table><thead><tr><th>结构类型</th><th>结构存储的值</th><th>结构的读写能力</th></tr></thead><tbody><tr><td>STRING</td><td>可以是字符串、整数或浮点数</td><td>对整个字符串或字符串的一部分支线操作；对整数和浮点数执行自增（increment）或自减（decrement）操作</td></tr><tr><td>LIST</td><td>一个链表，链表上的每个节点都包含了一个字符串</td><td>从链表的两端推入或者弹出元素；根据偏移量对链表进行修剪(trim)；读取单个或者多个元素；根据值查找或者移除元素</td></tr><tr><td>SET</td><td>包含字符串的无序收集器，并且被字符串不能重复，各不相同</td><td>添加、获取、移除单个元素；检查一个元素是否存在于集合中；计算交集、并集、差集；从集合里面随机取元素</td></tr><tr><td>ZSET</td><td>字符成员与浮点数分值之间的有序映射，元素的排列顺序由分值的大小决定</td><td>添加、获取、删除单个元素；根据分值范围或者成员来获取元素</td></tr><tr><td>HASH</td><td>包含键值对的无序散列表</td><td>添加、获取、移除单个键值对；获取所以键值对</td></tr></tbody></table><h3 id="字符串-String"><a href="#字符串-String" class="headerlink" title="字符串(String)"></a>字符串(String)</h3><p>字符串(string)类型是redis中最基本的数据类型，它能存储任何形式的字符串，包括二进制数据。可以用它来存储用户的邮箱、json化对象、甚至是图片。一个字符串类型键允许存储的最大容量是512M。</p><h4 id="内部数据结构"><a href="#内部数据结构" class="headerlink" title="内部数据结构"></a>内部数据结构</h4><p>在Redis内部，String类型通过int、sds(simple dynamic string)作为存储结构，int用来存放整型数据，sds存放字节、字符串、浮点型数据。在C的标准字符串结构下进行了封装，用来提升基本操作的性能，同时也充分利用已有的C标准库，简化实现逻辑。可以在Redis的源码中[sds.h]中看到的结构如下：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">char</span> <span class="token operator">*</span>sds<span class="token punctuation">;</span></code></pre><p>redis3.2版本之后引入了5种sdshdr类型，目的是为了满足不同长度字符串可以使用不同大小的sdshdr，从而节省内存，每次创建一个sds时根据sds的实际长度判断应该选择什么类型的sdshdr。sdshdr的5中结构定义如下：</p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Note: sdshdr5 is never used, we just access the flags byte directly. * However is here to document the layout of type 5 SDS strings. */</span><span class="token keyword">struct</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span> sdshdr5 <span class="token punctuation">{</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flags<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* 3 lsb of type, and 5 msb of string length */</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span> sdshdr8 <span class="token punctuation">{</span>    uint8_t len<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* used */</span>    uint8_t alloc<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* excluding the header and null terminator */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flags<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* 3 lsb of type, 5 unused bits */</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span> sdshdr16 <span class="token punctuation">{</span>    uint16_t len<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* used */</span>    uint16_t alloc<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* excluding the header and null terminator */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flags<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* 3 lsb of type, 5 unused bits */</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span> sdshdr32 <span class="token punctuation">{</span>    uint32_t len<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* used */</span>    uint32_t alloc<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* excluding the header and null terminator */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flags<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* 3 lsb of type, 5 unused bits */</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span> sdshdr64 <span class="token punctuation">{</span>    uint64_t len<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* used */</span>    uint64_t alloc<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* excluding the header and null terminator */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flags<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* 3 lsb of type, 5 unused bits */</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>以sdshdr8为例，来解释一下，8表示字符串最大长度是<code>2^8-1</code>即255</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span> sdshdr8 <span class="token punctuation">{</span>    uint8_t len<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//表示当前sds的长度(单位是字节)</span>    uint8_t alloc<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//表示sds已分配内存大小(单位是字节)</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flags<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//用一个字节表示当前sdshdr的类型，应为sdshdr有5种类型，所以至少需要3位来表示：000--sdshdr5、001--shshdr8、010--sdshdr16、011--sdshdr32、100--sdshdr64，高5位用不到所以都是0</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//字节数据，用于保存字符串</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><img src="/2019/03/20/RedisInAction/sdshdr8.png" alt></p><p>SDS遵循C字符串以空字符结尾的惯例。</p><h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><ol><li><p><strong>append</strong>： append key value； 如果key已经存在并且是一个字符串，append命令将value追加到原理值得末尾。可用版本&gt;=2.0.0。</p></li><li><p><strong>bitcount</strong>：bitcount key [start end]； 统计字符串中，被设置为1的比特位的数量。可用版本&gt;=2.6.0。</p></li><li><p><strong>bitop</strong>：bitop operation destkey key [key …] ；对一个或多个保存二进制位的字符串key进行位元操作，并将结果保存到destkey上。operation可以是AND、OR、NOT、XOR这四种操作中的任意一种。可用版本&gt;=2.6.0。</p></li><li><p><strong>decr</strong>：decr key ；将key中存储的数据值减1。可用版本&gt;=1.0.0。</p></li><li><p><strong>decrby</strong>：decrby key decrement；将key所存储的值减去decrement。可用版本&gt;=1.0.0。</p></li><li><p><strong>get</strong>：get key；返回Key所对应的支付串的值。如果 key不存在那么返回特殊值 nil 。可用版本&gt;=1.0.0。</p></li><li><p><strong>getbit</strong>：getbit key offset；对key所存储的字符串值，获取指定偏移量上的位(bit)。可用版本&gt;=2.2.0。</p></li><li><p><strong>getrange</strong>：getrange key start end；截取得出子字符串。可用版本&gt;=2.4.0</p></li><li><p><strong>getset</strong>：getset key value；将给定key的值设为value，并返回key的旧值。可用版本&gt;=1.0.0。</p></li><li><p><strong>incr</strong>：incr key；将key中存储的数字值增一。可用版本&gt;=1.0.0</p></li><li><p><strong>incrby</strong>：incrby key increment；将key所存储的值加上增量increment。可用版本&gt;=1.0.0。</p></li><li><p><strong>incrbyfloat</strong>：incrbyfloat key increment；为key中所存储的值加上浮点数增量increment。可用版本&gt;=2.6.0</p></li><li><p><strong>mget</strong>：mget key [key …] ；返回所有(一个或多个)给定key的值。可用版本&gt;=1.0.0。</p></li><li><p><strong>mset</strong>：mset key value [key value …] ；同时设置一个或多个key-value对。可用版本&gt;=1.0.1</p></li><li><p><strong>msetnx</strong>：msetnx key value [key value …]； 同时设置一个或多个key-value对，当且仅当所有给定的key都不存在。可用版本&gt;=1.0.1。</p></li><li><p><strong>psetnx</strong>：psetnx key milliseconds value； 这个命令和setex命令相识，但它以毫秒为单位设置key的生存时间，而不是像setex命令那样，以秒为单位。可用版本&gt;=2.6.0。</p></li><li><p><strong>set</strong>：set key value [EX seconds] [PX milliseconds] [NX|XX]；将字符串value关联到key。可用版本&gt;=1.0.0。</p><p>从版本2.6.12开始，set命令的行为可以通过一系列参数来修改：</p><ul><li><p>EX seconds:设置键的过期时间为second秒，set key value ex second 效果等同于setex key second value；</p></li><li><p>PX milliseconds:设置键的过期时间为millisecond毫秒。set key value px millisecond效果等同于psetex key millisecond value；</p></li><li>NX:只有键不存在时，才对键进行设置操作，set key value nx 效果等同于setnx key value；</li><li>XX:只在键已经存在时，才对键进行设置操作。</li></ul></li><li><p><strong>setbit</strong>：setbit key offset value；对key所存储的字符串值，设置或清除指定偏移量上的位(bit)。可用版本&gt;=2.2.0。</p></li><li><p><strong>setex</strong>：setex key seconds value；将值value关联到key，并将key的生存时间设置为seconds秒。可用版本&gt;=2.0.0。</p></li><li><p><strong>setnx</strong>：setnx key value；将key的值设为value，当且仅当key不存在。设置成功，返回1；设置失败，返回0。可用版本&gt;=1.0.0。</p></li><li><p><strong>setrange</strong>：setrange key offset value；用value覆盖给定key所存在的字符串值，从偏移量offset开始。可用版本&gt;=2.2.0。</p></li><li><p><strong>strlen</strong>：strlen key；返回key所存储的字符串值得长度。可用版本&gt;=2.2.0。</p></li></ol><h3 id="列表-List"><a href="#列表-List" class="headerlink" title="列表(List)"></a>列表(List)</h3><p>列表(list)类型可以存储一个有序的字符串列表，常用的操作是向列表的两端添加元素或者获取列表的某个片段。</p><p> 列表类型使用双向链表实现的，所以向列表两端添加元素的时间复制度为O(1)，获取越接近两端的元素就越快。</p><h4 id="内部数据结构-1"><a href="#内部数据结构-1" class="headerlink" title="内部数据结构"></a>内部数据结构</h4><p>在redis3.2之前的版本，列表类型的value对象内部是以linkedlist或ziplist来实现，当列表只包含少量元素，并且每个元素要么是小整数值，要么是长度📒短的字符串时，Redis就会使用压缩链表(zpilist)来存储来节省内存，否则将会采用双向链表（linkedlist）存储。双向链表的节点结构可以在redis源码的<code>adlist.h</code>看到，listNode具体结构定义如下：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> listNode <span class="token punctuation">{</span>    <span class="token keyword">struct</span> listNode <span class="token operator">*</span>prev<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//前置节点</span>    <span class="token keyword">struct</span> listNode <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//后置节点</span>    <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//节点的值</span><span class="token punctuation">}</span> listNode<span class="token punctuation">;</span></code></pre><p>虽然可以使用多个listNode结构就能组成链表，但是使用一个list来持有链表的化，操作会更方便，list具体结构定义如下：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> list <span class="token punctuation">{</span>    listNode <span class="token operator">*</span>head<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//链表头节点</span>    listNode <span class="token operator">*</span>tail<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//链表尾节点</span>    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>dup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//节点复制函数</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>free<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//节点释放函数</span>    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>match<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//节点对比函数</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//链表包含的节点数量</span><span class="token punctuation">}</span> list<span class="token punctuation">;</span></code></pre><p>列表的这两种存储方式各有优缺点：</p><ul><li>双向链表在链表的两端进行添加和删除操作，时间复查度低，但内存开销大；</li><li>压缩链表存储在一段连续的内存上，所以存储效率高，但是插入和删除都要频繁申请和释放内存；</li></ul><p>在redis3.2之后的版本，采用了一种叫quicklist的数据结构来存储列表类型的value值，quicklist结构参见Redis源码<code>quicklist.h</code>，quicklistNode的结构定义如下：</p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* quicklistNode is a 32 byte struct describing a ziplist for a quicklist. * We use bit fields keep the quicklistNode at 32 bytes. * count: 16 bits, max 65536 (max zl bytes is 65k, so max count actually &lt; 32k). * encoding: 2 bits, RAW=1, LZF=2. * container: 2 bits, NONE=1, ZIPLIST=2. * recompress: 1 bit, bool, true if node is temporarry decompressed for usage. * attempted_compress: 1 bit, boolean, used for verifying during testing. * extra: 12 bits, free for future use; pads out the remainder of 32 bits */</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> quicklistNode <span class="token punctuation">{</span>    <span class="token keyword">struct</span> quicklistNode <span class="token operator">*</span>prev<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//前置节点</span>    <span class="token keyword">struct</span> quicklistNode <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//后置节点</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>zl<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ziplist节点</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> sz<span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">/* ziplist size in bytes */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count <span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">/* count of items in ziplist */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> encoding <span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/* RAW==1 or LZF==2 */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> container <span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/* NONE==1 or ZIPLIST==2 */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> recompress <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* was this node previous compressed? */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> attempted_compress <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* node can't compress; too small */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> extra <span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* more bits to steal for future usage */</span><span class="token punctuation">}</span> quicklistNode<span class="token punctuation">;</span></code></pre><p>可以从上面的结构定义看出，quicklist本质任然是一个双向链表，只是在列表的每个节点都是一个ziplist,其实就是linkedlist和ziplist的结合，quicklist中每个节点ziplist都能够存储多个数据元素，在源码中的文件为<code>quicklist.c</code>的第一行就有这样的描述：quicklist.c - A doubly linked list of ziplists意思是quicklist就是有ziplist组成的双向链表。</p><p><img src="/2019/03/20/RedisInAction/quicklist.png" alt></p><h4 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h4><ol><li><p><strong>blpop</strong>：blpop key [key …] timeout；blpop是列表阻塞式(blocking)弹出原语。它是lpop命令的阻塞版本，当给定列表没有任何元素可供弹出的时候，连接将被blpop命令阻塞，直到等待超时或发现可弹元素为止。超时参数 <code>timeout</code> 接受一个以秒为单位的数字作为值。超时参数设为 <code>0</code> 表示阻塞时间可以无限期延长(block indefinitely) 。可用版本&gt;=2.0.0。</p></li><li><p><strong>brpop</strong>：brpop key [key …] timeout；brpop是列表的阻塞式(blocking)弹出原语。它是 rpop命令的阻塞版本，当给定列表内没有任何元素可供弹出的时候，连接将被brpop命令阻塞，直到等待超时或发现可弹出元素为止。可用版本&gt;2.0.0。</p></li><li><p><strong>brpoplpush</strong>：brpoplpush source destination timeout；brpoplpush是rpoplpush的阻塞版本，当给定列表source不为空时，brpoplpush的表现和rpoplpush一样。当列表source为空时brpoplpush命令将阻塞连接，直到等待超时，或有另一个客户端多source执行lpush或rpush命令为止。可用版本&gt;=2.2.0。</p></li><li><p><strong>lindex</strong>：lindex key index；返回列表key中，下标为index的元素。可用版本&gt;=1.0.0。</p></li><li><p><strong>linsert</strong>：linsert key before|after pivot value；将值value插入到列表key中，位于值prvot之前或之后。可用版本&gt;2.2.0。</p></li><li><p><strong>llen</strong>：llen key；返回列表key的长度。  如果key不存在，则key被解释为一个空列表，返回0。可用版本&gt;=1.0.0。</p></li><li><p><strong>lpop</strong>：lpop key；移除并返回列表key的头元素。可用版本&gt;=1.0.0。</p></li><li><p><strong>lpush</strong>：lpush key value [value …]；将一个或多个value插入到列表key的表头。如果有多个value值，那么各个value值按从左到右的顺序依次插入到表头。执行lpush后返回列表的长度。可用版本&gt;=1.0.0。</p></li><li><p><strong>lpushx</strong>：lpushx key value；将值value插入到列表key的表头，当且仅当key存在并且是一个列表。当key不存在时，lpushx命令什么也不做。lpushx命令执行后，返回列表的长度。可用版本&gt;=2.2.0。</p></li><li><p>lrange：lrange key start stop；返回列表key中指定区间内的元素，区间以偏移量start和stop指定。下标参数start和end都是以0开始，也就是说，以0表示列表的第一个元素，以1表示列表的第二个元素，以此类推。也可以使用负数下标，以-1表示列表的最后一个元素，-2表示列表的倒数第二个元素，以此类推。可用版本&gt;=1.0.0。</p></li><li><p>lrem：lrem key count value；依据参数count的值，移除列表中与参数value相等的元素。返回被移除元素的数量。可用版本&gt;=1.0.0。</p><p>count的值可以是以下几种情况：</p><ul><li>count &gt; 0：从表头开始向表尾搜索，移除与value相等的元素，数量为count；</li><li>count &lt; 0：从表尾向表头搜索，移除与value相等的元素，数量为count的绝对值。</li><li>count = 0：移除表中所有与value相等的值。</li></ul></li><li><p>lset：lset key index value；将列表key下标为index的元素的值设置为value。当index参数超出范围，或对一个空列表(key不存在)进行lset时，返回一个错误。操作成功返回ok，否则返回错误信息。可用版本&gt;=1.0.0。</p></li><li><p>ltrim：ltrim key start stop；对一个列表进行修剪(trim)，就是说，让列表只保留指定区间内的元素，不在指定区间内的元素都将被删除。命令执行成功返回ok。可用版本&gt;=1.0.0。</p></li><li><p>rpop：rpop key；移除并返回列表key的尾元素。当key不存在时，返回nil。</p></li><li><p>rpoplpush：rpoplpush source destination；该命令在一个原子时间内执行两个操作：</p><ul><li>将列表source中的最后一个元素(尾元素)弹出，返回给客户端。</li><li>将source弹出的元素插入到列表destination，作为列表destination的头元素。</li></ul><p>如果source不存在，返回nil，并不执行其他动作。如果source和destination相同，则列表中的表尾元素被移动到表头，并返回该元素，可以把这种特殊情况视作列表的反转。可用版本&gt;=1.2.0。</p></li><li><p>rpush：rpush key value [value …]；将一个或多个值value插入列表key的表尾(最右边)。如果有多个value值，那么各个value值按从左到右的顺序依次插入到表尾。rpush执行后，返回列表的长度。可用版本&gt;=1.0.0。</p></li><li><p>rpushx：rpushx key value；将值value插入列表key的表尾，当且仅当key存在并且是一个列表。当key不存在时，rpushx命令什么也不做。rpushx执行成功后，返回列表的长度。可用版本&gt;=2.2.0。</p></li></ol><h3 id="哈希-Hash"><a href="#哈希-Hash" class="headerlink" title="哈希(Hash)"></a>哈希(Hash)</h3><p>哈希可以存储多个键值对之间的映射，和字符串一样，哈希存储的值既可以是字符串又可以是数字值。</p><h4 id="内部数据结构-2"><a href="#内部数据结构-2" class="headerlink" title="内部数据结构"></a>内部数据结构</h4><p>哈希类型的内部数据结构可以是ziplist或者hashtable。当哈希保存的所有键值对的键和值得字符串大小都小于64字节，并且键值对的数量小于512个时，底层将会采用ziplist存储结构，否则将采用hashtable存储结构。在redis中，hashtable有3层结构，dict -&gt; dictht -&gt; dictEntry，源码在<code>dict.h</code>中。</p><p><strong>dictEntry（哈希节点）</strong></p><p>管理一个key-value，同时保留同一个桶中相邻元素的指针，用户维护哈希桶的内部链表，结构定义如下：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dictEntry <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>    <span class="token keyword">union</span> <span class="token punctuation">{</span>        <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">;</span>        uint64_t u64<span class="token punctuation">;</span>        int64_t s64<span class="token punctuation">;</span>        <span class="token keyword">double</span> d<span class="token punctuation">;</span>    <span class="token punctuation">}</span> v<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 因为value有多种类型，所以value用了union来存储</span>    <span class="token keyword">struct</span> dictEntry <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//下一个节点的地址，用来处理冲突，所以分配到同一个索引的元素通过next指针链接起来形成链表</span><span class="token punctuation">}</span> dictEntry<span class="token punctuation">;</span></code></pre><p><strong>dictht（哈希表）</strong> </p><p>实现一个hashtable会用一个buckers存放dictEntry地址，一般情况下通过hash(key) % len得到的值就是buckers的索引，这个值决定了dictEntry节点的存放位置，<code>dict.h</code>中的dictht结构中table就是buckers的地址。</p><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* This is our hash table structure. Every dictionary has two of this as we * implement incremental rehashing, for the old to the new table. */</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dictht <span class="token punctuation">{</span>    dictEntry <span class="token operator">*</span><span class="token operator">*</span>table<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//buckets的地址</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//buckerts的大小，总保持为2^n</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sizemask<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//掩码，用来技术hash值对应的buckers索引</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> used<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//当前dictht有多少个dictEntry节点</span><span class="token punctuation">}</span> dictht<span class="token punctuation">;</span></code></pre><p><strong>dict（字典）</strong>                                                                           </p><p>dictht实际上就是hash表的核心，但是只有一个dictht还不够，比如rehash、遍历hash等操作，所以redis定义了 一个叫dict的结构以支持字典的各种操作，当dictht需要扩容/缩容时，用来管理dictht的迁移，以下是它的数据结构:</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dict <span class="token punctuation">{</span>    dictType <span class="token operator">*</span>type<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//dictType里存放的是工具函数的指针</span>    <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//保存type中某些函数需要作为参数的数据</span>    dictht ht<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//维护两个dictht，ht[0]平时用，ht[1]rehash时用</span>    <span class="token keyword">long</span> rehashidx<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//当前rehash到buckerts的哪个索引位置，-1表示非rehash状态</span>    <span class="token keyword">int</span> iterators<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//安全迭代器的计数</span><span class="token punctuation">}</span> dict<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//工具函数</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dictType <span class="token punctuation">{</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>hashFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>keyDup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>valDup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>keyCompare<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>keyDestructor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>valDestructor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> dictType<span class="token punctuation">;</span></code></pre><p><strong>dict的结构图</strong>：</p><p><img src="/2019/03/20/RedisInAction/dict.png" alt></p><p><strong>哈希算法</strong></p><p>当要讲一个新的键值对添加到dict里面时，程序需要先根据键计算出哈希值和索引值，然后在根据索引值将键值对的哈希表节点放到哈希数组的指定索引上面。</p><pre class=" language-tex"><code class="language-tex">#使用dict设置的哈希函数，计算key的哈希值hash = dict -> type -> hashFunction(key);#使用哈希表的sizemask属性和哈希值，计算出索引值；根据情况不同，ht[x]可以是ht[0]或ht[1]index = hash & dict -> hx[x].sizemask;</code></pre><p>Redis使用<strong>MurmurHash2</strong>算法来计算键的哈希值。<strong>MurmuhHash算法</strong>最初由Austin Appleby于2008年发明，这个算法的优点在于即使输入的键是由规律的，算法仍能给出一个很好的随机分布行，并且算法的计算速度也很快。</p><p><strong>解决哈希冲突</strong></p><p>当有两个或两个以上的键被分配到哈希表数组的同一个索引上面时，就称这些键发生了冲突（conllision）。Redis的哈希类型使用<strong>链地址法</strong>来解决冲突，每个哈希节点都有一个next指针，多个哈希节点可以用next指针构成一个单向链表，被分配到同一个索引上的多个节点可以用这个单向链表连接起来，这就解决了键冲突问题。</p><p><strong>Rehash</strong></p><p>随着操作的不断执行，哈希表保存的键值对会逐渐地增多或减少，为了让哈希表的负载因子维持在一个合理的范围之内，当哈希表保存的键值对数量大多或太少时，都需要对哈希表的大小进行相应的扩展或缩小。</p><p>扩展和缩小哈希表的工作可以通过执行rehash(重新散列)操作来完成，Redis对字典的哈希表执行rehash的步骤如下：</p><ul><li><p>为字典的ht[1]哈希表分配内存空间，这个哈希表的空间大小取决于要执行的操作依据ht[0]哈希表包含的键值对的数量(即ht[0].used属性的值)。</p><ul><li>如果执行的是扩展操作，那么ht[1]的大小为第一个大于等于ht[0].used*2的2^n（2的n次方）；</li><li>如果执行的是收缩操作，那么ht[1]的大小为第一个大于等于ht[0].used的2^n；</li></ul></li><li><p>将保存在ht[0]中的所有键值对rehash到ht[1]上面。</p></li><li>当ht[0]包含的所有键值对都迁移到了ht[1]之后，就把ht[0]置为空表，释放ht[0]，然后将ht[1]设置为ht[0]，并为ht[1]新建一个空的哈希表，为下次rehash做准备。</li></ul><h4 id="常用命令-2"><a href="#常用命令-2" class="headerlink" title="常用命令"></a>常用命令</h4><ol><li><strong>hdel</strong>：hdel key field [field …]；删除哈希表的一个或多个指定域，不存在的域将被忽略。返回被成功删除的域的数量。可用版本&gt;=2.0.0。</li><li><strong>hexists</strong>：hexists key field；查看哈些表key中，给定的field是否存在。如果存在，返回1；如果哈希表不含有给定域，或key不存在，返回0。可用版本&gt;=2.0.0。</li><li><strong>hget</strong>：hget key field；返回哈希表key中给定域field的值。如果给定的域不存在或是给定key不存在时，返回nil。可用版本&gt;=2.0.0。</li><li><strong>hgetall</strong>：hgetall key；返回哈希表中所有的域和值。若key不存在，返回空列表。可用版本&gt;=2.0.0。</li><li><strong>hincrby</strong>：hincrby key field increment；为哈希表key中的域field的值加上增量increment。增量也可以是负数，相当于对给定域进行减法操作。如果key不存在，一个新的哈希表被创建并执行hincrby命令。如果域field不存在，那么在执行命令前，域的值被初始化为0。对一个存储字符串值得域field执行hincrby命令，会返回错误。可用版本&gt;=2.0.0。</li><li><strong>hincrbyfloat</strong>：hincrbyfloat key field increment；为哈希表key中的field加上浮点数增量Increment。如果哈希表中没有域field，那么hincrbyfloat会先将域field的值设为0，然后再执行加法操作。可用版本&gt;=2.6.0。</li><li><strong>hkeys</strong>：hkeys key；返回哈希表key中的所有域。可用版本&gt;=2.0.0。</li><li><strong>hlen</strong>：hlen key；返回哈希表key中域的数量。当key 不存在时返回0。可用版本&gt;=1.0.0。</li><li><strong>hmget</strong>：hmget key field [field …]；返回哈希表key中，一个或多个给定域的值。如果给定的域不存在于哈希表，那么返回一个nil值。可用版本&gt;=2.0.0。</li><li><strong>hmset</strong>：hmset key field value [field value …]；同时将多个field-value设置到哈希表key中。可用版本&gt;=2.0.0。</li><li><strong>hset</strong>：hset key field value；将哈希表key中的域field的值设为value。如果key不存在，一个新的哈希表被创建并进行hset操作。可用版本&gt;=2.0.0。</li><li><strong>hsetnx</strong>：hsetnx key field value；将哈希表key中的域field的值设置为value，当且仅当域field不存在。设置成功，返回1；如果给定域已经存在斌别没有操作被执行，返回0。可用版本&gt;=2.0.0。</li><li><strong>hvals</strong>：hvals key；返回哈希表key中所有域的值。返回一个包含哈希表中所有值的表；如果key不存在，返回一个空表。可用版本&gt;=2.0.0。</li><li><strong>hscan</strong>：hsan key cursor [match pattern] [count count]；</li></ol><h3 id="集合-Set"><a href="#集合-Set" class="headerlink" title="集合(Set)"></a>集合(Set)</h3><p>集合类型中，每个元素都是不同的，也就是不能有重复的数据，痛死集合类型中的数据是无序的。一个集合类型可以存储至多2^32 -1个元素。集合类型和列表类型的最大区别是有序性和唯一性。</p><p>集合类型的常用操作是向集合中加入或删除元素，判断某个元素是否存在。</p><h4 id="内部数据结构-3"><a href="#内部数据结构-3" class="headerlink" title="内部数据结构"></a>内部数据结构</h4><p>集合(Set)的底层数据结果是intset或者hashtable。当集合只包含整数型元素并且元素的数量不超过512个时，采用intset来存储，否则采用hashtable来存储，但对于set来说，该hashtable的value值均为NULL。</p><p>inset的结构在源码<code>intset.h</code>中有定义如下：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> intset <span class="token punctuation">{</span>    uint32_t encoding<span class="token punctuation">;</span>    uint32_t length<span class="token punctuation">;</span>    int8_t contents<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span> intset<span class="token punctuation">;</span></code></pre><p>hashtable的结构其实就是前面章节介绍过的字典(dict)，这里不再重复介绍。</p><h4 id="常用命令-3"><a href="#常用命令-3" class="headerlink" title="常用命令"></a>常用命令</h4><ol><li><p><strong>sadd</strong>：sadd key member [member …]；将一个或多个member元素加入到集合key当中，已经存在于集合的member元素将被忽略。可用版本&gt;=1.0.0。</p></li><li><p><strong>scard</strong>：scard key；返回集合key中元素的数量。当key不存在时返回0。可用版本&gt;=1.0.0。</p></li><li><p><strong>sdiff</strong>：sdiff key [key …]；返回一个集合的全部成员，该集合时所用给定集合之间的差集。可用版本&gt;=1.0.0。</p></li><li><p><strong>sdiffstore</strong>：sdiffstore destination key [key …]；这个命令和sdiff类似，但它将结果保存到destination集合中，而不是简单地返回结果集。可用版本&gt;=1.0.0。</p></li><li><p><strong>sinter</strong>：sinter key [key …]；返回集合的交集。可用版本&gt;1.0.0。</p></li><li><p><strong>sinterstore</strong>：sinter destination key [key …]；这个命令和sinter类型，但它将结果保存到destination集合中，而不是简单地返回结果集。可用版本&gt;=1.0.0。</p></li><li><p><strong>sismember</strong>：sismember key memeber；判断memeber元素是否为集合key的成员。如果member元素时集合key的成员，返回1;如果集合member元素不是集合的成员，或key不存在，返回0。可用版本&gt;=1.0.0。</p></li><li><p><strong>smembers</strong>：smembers key；返回集合key中的所有成员。可用版本&gt;=1.0.0。</p></li><li><p><strong>smove</strong>：smove source destination member；将member元素从source集合移动到destination集合。smove是原子性操作。可用版本&gt;=1.0.0。</p></li><li><p><strong>spop</strong>：spop key；移除并返回集合中的一个随机元素。当key不存在或者key是空集时，返回nil。可用版本&gt;=1.0.0。</p></li><li><p><strong>srandmember</strong>：srandmember key [count]；若命令执行时，只提供了key参数，那么返回集合中的一个随机元素。从Redis2.6开始，srandmember命令接受可选参数count:</p><ul><li>如果count为正数，且小于集合基数，那么命令返回一个包含count个元素的数组，数组中的元素各不相同。如果count大于等于集合基数，那么返回整个集合。</li><li>如果count为负数，那么命令返回一个数组，数组中的元素会重复多次出现，而数组的长度为count的绝对值。</li></ul><p>可用版本&gt;=1.0.0。</p></li><li><p><strong>srem</strong>：srem key member [member …]；移除集合key中的一个或多个member元素，不存在的元素会被忽略。可用版本&gt;1.0.0。</p></li><li><p><strong>sunion</strong>：sunion key [key …]；返回所有给定集合的并集。可用版本&gt;=1.0.0。</p></li><li><p><strong>sunionstore</strong>：sunionstore destination key [key …]；这个命令类似于sunion命令，但它将结果保存到destination集合，而不是简单地返回结果集。可用版本&gt;=1.0.0。</p></li><li><p><strong>sscan</strong>：sscan key cursor [match pattern] [count count]。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>二维数组中的查找</title>
      <link href="/2019/03/17/SearchIn2DArray/"/>
      <url>/2019/03/17/SearchIn2DArray/</url>
      
        <content type="html"><![CDATA[<h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>在一个二维数组中（每个一维数组的长度相同），每一行都按照从左到右递增的顺序排列，每一列都按照从上到下递增的顺序排列。请完成一个函数，输入这样的一个二维数组和一个整数，判断整数是否在二维数组中。</p><p><img src="/2019/03/17/SearchIn2DArray/2DArray-1.png" alt></p><h3 id="解法一：暴力解法"><a href="#解法一：暴力解法" class="headerlink" title="解法一：暴力解法"></a>解法一：暴力解法</h3><p>暴力解法是最容易想到的解决此问题的方法，即遍历二维数组中的每一个元素，时间复杂度为O(n*n)。这种处理方式虽然能够解决问题，但是没有利用上题目中给出的数组从左到右、从上到下都是递增有序的特点。</p><h3 id="解法二：二分查找"><a href="#解法二：二分查找" class="headerlink" title="解法二：二分查找"></a>解法二：二分查找</h3><p>在一维数组中进行二分查找很容易，那么可以对二维数组中的每一行进行二分查找，一个n行m列的二维数组的时间复杂度为O(nlogm)。二分查找的时间复杂度为O(logm)，一共n行，故总体时间复杂度是O(nlogm)。</p><h3 id="解法三：规律查找法"><a href="#解法三：规律查找法" class="headerlink" title="解法三：规律查找法"></a>解法三：规律查找法</h3><p>题目中给的二维数组具有从左到右、从上到下递增的规律，可以从左下角（或右上角）的元素开始查找，如果元素a[row] [col] 比target小，就往右查找（col++）；如果元素a[row] [col] 比target大，就往上查找（row—）。例如查找12的过程如下图：</p><p><img src="/2019/03/17/SearchIn2DArray/2DArray-2.png" alt></p><p>从左下角开始查找</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     *     * 规律法：     * 根据二维数组由上到下，由左至由递增的规律，从左下角开始查找，     * 如果target小于a[i][j]则往右找，如果target大于a[i][j]则往上找，如果数字存在，必然可以找到。     * 如果是n*m的数组时间复杂度2n即为O(n+m)     * @param target     * @param matrix     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">findLB2RT</span><span class="token punctuation">(</span><span class="token keyword">int</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>matrix<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>matrix <span class="token operator">==</span> null <span class="token operator">||</span> matrix<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> h <span class="token operator">=</span> matrix<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> w <span class="token operator">=</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">&lt;</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> target <span class="token operator">></span> matrix<span class="token punctuation">[</span>h<span class="token punctuation">]</span><span class="token punctuation">[</span>w<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> row <span class="token operator">=</span> h<span class="token punctuation">;</span>        <span class="token keyword">int</span> col <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 从右下角向左上角的方向搜索</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>row <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> col  <span class="token operator">&lt;=</span> w<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">></span> matrix<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// target比matrix[row][col]大，则向右移动</span>                col<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&lt;</span> matrix<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// target比matrix[row][col]小，则向上移动</span>                row<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>从右上角开始查找</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     *     * 一、规律法：     * 根据二维数组由上到下，由左至由递增的规律，从右上角开始查找，     * 如果target小于a[i][j]则往左找，如果target大于a[i][j]则往下找，如果数字存在，必然可以找到。     * 如果是n*m的数组时间复杂度2n即为O(n+m)     * @param target     * @param matrix     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">findRT2LB</span><span class="token punctuation">(</span><span class="token keyword">int</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>matrix<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>matrix <span class="token operator">==</span> null <span class="token operator">||</span> matrix<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> h <span class="token operator">=</span> matrix<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> w <span class="token operator">=</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">&lt;</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> target <span class="token operator">></span> matrix<span class="token punctuation">[</span>h<span class="token punctuation">]</span><span class="token punctuation">[</span>w<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> col <span class="token operator">=</span> w<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 从右上角向左下角的方向搜索</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>row <span class="token operator">&lt;=</span> h <span class="token operator">&amp;&amp;</span> col  <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">&lt;</span> matrix<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// target比matrix[row][col]小，则向左移动</span>                col<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">></span> matrix<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// target比matrix[row][col]大，则向下移动</span>                row<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="解法四：规律二分查找"><a href="#解法四：规律二分查找" class="headerlink" title="解法四：规律二分查找"></a>解法四：规律二分查找</h3><p>将解法二和解法三结合：对每行每列都进行二分查找，时间复杂度为O(logn * logm)。</p><p>例如查找<strong>目标数字7</strong>，首先使用二分查找出中间行，共5行，那么中间行为(0+4)/ 2 = 2，即第三行。接下来对这一行进行进行二分查找，找出这一行中最后一个比目标值小的元素，这里是6。数字6可以把二维数组划分为4个部分，如下图，<strong>左上区域</strong>的元素值都比目标值7小，<strong>右下区域</strong>的元素值都比目标值大，所以只需要在<strong>左下区域</strong>和<strong>右上区域</strong>中查找就行了。</p><p><img src="/2019/03/17/SearchIn2DArray/2DArray-3.png" alt></p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * 二、二分规律法：     * 对每行、每列都使用二分查找，时间复杂度为O(logn * logm)     * @param target     * @param matrix     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">find2</span><span class="token punctuation">(</span><span class="token keyword">int</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>matrix<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>matrix <span class="token operator">==</span> null <span class="token operator">||</span> matrix<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> h <span class="token operator">=</span> matrix<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> w <span class="token operator">=</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">&lt;</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> target <span class="token operator">></span> matrix<span class="token punctuation">[</span>h<span class="token punctuation">]</span><span class="token punctuation">[</span>w<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 二维数组的二分查找     * @param target     * @param array     * @param startX     * @param startY     * @param endX     * @param endY     * @return     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">binarySearchIn2DArray</span><span class="token punctuation">(</span><span class="token keyword">int</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">,</span> <span class="token keyword">int</span> startX<span class="token punctuation">,</span> <span class="token keyword">int</span> startY<span class="token punctuation">,</span> <span class="token keyword">int</span> endX<span class="token punctuation">,</span> <span class="token keyword">int</span> endY<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> startX <span class="token operator">></span> endX <span class="token operator">||</span> startY <span class="token operator">></span> endY<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 首先，找中间行</span>        <span class="token keyword">int</span> midRow <span class="token operator">=</span> <span class="token punctuation">(</span>startX <span class="token operator">+</span> endX<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 对一维数组进行二分查找</span>        <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> array<span class="token punctuation">[</span>midRow<span class="token punctuation">]</span><span class="token punctuation">,</span> startY<span class="token punctuation">,</span> endY<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>midRow<span class="token punctuation">]</span><span class="token punctuation">[</span>r<span class="token punctuation">]</span> <span class="token operator">==</span> target<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 由坐标r分割出的4个部分</span>        <span class="token comment" spellcheck="true">// 左上部分的值都比目标值小，右下部分的值都比目标值大</span>        <span class="token comment" spellcheck="true">// 所以，只需对中的左下部分和右上部分进行递归查找</span>        <span class="token keyword">return</span> <span class="token function">binarySearchIn2DArray</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> array<span class="token punctuation">,</span> midRow <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> startY<span class="token punctuation">,</span> endX<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//坐下区域</span>                <span class="token operator">||</span> <span class="token function">binarySearchIn2DArray</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> array<span class="token punctuation">,</span> startX<span class="token punctuation">,</span> r <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> midRow <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> endY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//右上区域</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 一维数组的二分查找: 找出与目标值相同的下标或最后一个比目标值小的下标     * @param target     * @param array     * @param start     * @param end     * @return     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span><span class="token keyword">int</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">int</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>start <span class="token operator">+</span> end<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">==</span> array<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">||</span> start <span class="token operator">></span> end<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> mid<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&lt;</span> array<span class="token punctuation">[</span>mid<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            end <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> array<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            start <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> array<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>lancq<span class="token punctuation">.</span>array<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchIn2DArray</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     *     * 在一个二维数组中（每个一维数组的长度相同），每一行都按照从左到右递增的顺序排列，每一列都按照从上到下递增的顺序排列。     * 请完成一个函数，输入这样的一个二维数组和一个整数，判断整数是否在二维数组中。     * [     * [1,2,4,8,10]     * [3,8,9,10,11]     * [5,9,11,13,16]     * [7,10,13,15,19]     * ]     */</span>    <span class="token comment" spellcheck="true">/**     *     * 一、规律法：     * 根据二维数组由上到下，由左至由递增的规律，从右上角开始查找，     * 如果target小于a[i][j]则往左找，如果target大于a[i][j]则往下找，如果数字存在，必然可以找到。     * 如果是n*m的数组时间复杂度2n即为O(n+m)     * @param target     * @param matrix     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">findRT2LB</span><span class="token punctuation">(</span><span class="token keyword">int</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>matrix<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>matrix <span class="token operator">==</span> null <span class="token operator">||</span> matrix<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> h <span class="token operator">=</span> matrix<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> w <span class="token operator">=</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">&lt;</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> target <span class="token operator">></span> matrix<span class="token punctuation">[</span>h<span class="token punctuation">]</span><span class="token punctuation">[</span>w<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> col <span class="token operator">=</span> w<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 从右上角向左下角的方向搜索</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>row <span class="token operator">&lt;=</span> h <span class="token operator">&amp;&amp;</span> col  <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">&lt;</span> matrix<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// target比matrix[row][col]小，则向左移动</span>                col<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">></span> matrix<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// target比matrix[row][col]大，则向下移动</span>                row<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     *     * 一、规律法：     * 根据二维数组由上到下，由左至由递增的规律，从左下角开始查找，     * 如果target小于a[i][j]则往右找，如果target大于a[i][j]则往上找，如果数字存在，必然可以找到。     * 如果是n*m的数组时间复杂度2n即为O(n+m)     * @param target     * @param matrix     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">findLB2RT</span><span class="token punctuation">(</span><span class="token keyword">int</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>matrix<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>matrix <span class="token operator">==</span> null <span class="token operator">||</span> matrix<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> h <span class="token operator">=</span> matrix<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> w <span class="token operator">=</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">&lt;</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> target <span class="token operator">></span> matrix<span class="token punctuation">[</span>h<span class="token punctuation">]</span><span class="token punctuation">[</span>w<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> row <span class="token operator">=</span> h<span class="token punctuation">;</span>        <span class="token keyword">int</span> col <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 从右下角向左上角的方向搜索</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>row <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> col  <span class="token operator">&lt;=</span> w<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">></span> matrix<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// target比matrix[row][col]大，则向右移动</span>                col<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&lt;</span> matrix<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// target比matrix[row][col]小，则向上移动</span>                row<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 二、二分规律法：     * 对每行、每列都使用二分查找，时间复杂度为O(logn * logm)     * @param target     * @param matrix     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">find2</span><span class="token punctuation">(</span><span class="token keyword">int</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>matrix<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>matrix <span class="token operator">==</span> null <span class="token operator">||</span> matrix<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> h <span class="token operator">=</span> matrix<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> w <span class="token operator">=</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">&lt;</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> target <span class="token operator">></span> matrix<span class="token punctuation">[</span>h<span class="token punctuation">]</span><span class="token punctuation">[</span>w<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">binarySearchIn2DArray</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> matrix<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 二维数组的二分查找     * @param target     * @param array     * @param startX     * @param startY     * @param endX     * @param endY     * @return     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">binarySearchIn2DArray</span><span class="token punctuation">(</span><span class="token keyword">int</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">,</span> <span class="token keyword">int</span> startX<span class="token punctuation">,</span> <span class="token keyword">int</span> startY<span class="token punctuation">,</span> <span class="token keyword">int</span> endX<span class="token punctuation">,</span> <span class="token keyword">int</span> endY<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> startX <span class="token operator">></span> endX <span class="token operator">||</span> startY <span class="token operator">></span> endY<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 首先，找中间行</span>        <span class="token keyword">int</span> midRow <span class="token operator">=</span> <span class="token punctuation">(</span>startX <span class="token operator">+</span> endX<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 对一维数组进行二分查找</span>        <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> array<span class="token punctuation">[</span>midRow<span class="token punctuation">]</span><span class="token punctuation">,</span> startY<span class="token punctuation">,</span> endY<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>midRow<span class="token punctuation">]</span><span class="token punctuation">[</span>r<span class="token punctuation">]</span> <span class="token operator">==</span> target<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 由坐标r分割出的4个部分</span>        <span class="token comment" spellcheck="true">// 左上部分的值都比目标值小，右下部分的值都比目标值大</span>        <span class="token comment" spellcheck="true">// 所以，只需对中的左下部分和右上部分进行递归查找</span>        <span class="token keyword">return</span> <span class="token function">binarySearchIn2DArray</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> array<span class="token punctuation">,</span> midRow <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> startY<span class="token punctuation">,</span> endX<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//坐下区域</span>                <span class="token operator">||</span> <span class="token function">binarySearchIn2DArray</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> array<span class="token punctuation">,</span> startX<span class="token punctuation">,</span> r <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> midRow <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> endY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//右上区域</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 一维数组的二分查找: 找出与目标值相同的下标或最后一个比目标值小的下标     * @param target     * @param array     * @param start     * @param end     * @return     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span><span class="token keyword">int</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">int</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>start <span class="token operator">+</span> end<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">==</span> array<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">||</span> start <span class="token operator">></span> end<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> mid<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&lt;</span> array<span class="token punctuation">[</span>mid<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            end <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> array<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            start <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> array<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>                <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">findRT2LB</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">findLB2RT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">binarySearch</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">binarySearch</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> c<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>                <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">binarySearchIn2DArray</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>length<span class="token punctuation">,</span> c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">find2</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">find2</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">find2</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">find2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">find2</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：<span class="token boolean">true</span><span class="token boolean">true</span><span class="token number">1</span><span class="token number">1</span><span class="token boolean">true</span><span class="token boolean">true</span><span class="token boolean">true</span><span class="token boolean">true</span><span class="token boolean">false</span><span class="token boolean">false</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>跳跃游戏II</title>
      <link href="/2019/03/16/JumpGame2/"/>
      <url>/2019/03/16/JumpGame2/</url>
      
        <content type="html"><![CDATA[<p>给定一个非负整数数组，你最初位于数组的第一个位置。数组中的每个元素代表你在该位置可以跳跃的最大长度。你的目标是使用最少的跳跃次数到达数组的最后一个位置。<a href="https://leetcode-cn.com/problems/jump-game-ii/" target="_blank" rel="noopener">LeetCode</a></p><p>示例</p><pre><code>输入: [2,3,1,1,4]输出: 2解释: 跳到最后一个位置的最小跳跃数是 2。     从下标为 0 跳到下标为 1 的位置，跳 1 步，然后跳 3 步到达数组的最后一个位置。</code></pre><p><strong>说明:</strong></p><p>假设你总是可以到达数组的最后一个位置。</p><p><strong>贪心算法：</strong></p><p>这里贪心的意思，不是说当前位置最大可以跳多少步就跳多少步，而是在当前位置可以跳的步数的范围内，选择下一跳可以跳的最远的那个步数，来决定当前跳多少步。</p><p>解题思路：</p><ul><li>另L、R均表示数组的下标位置；<ul><li>在[L,R]范围内找出最大的数作为下一个跳跃的位置，所以关键是怎么找出下一个跳跃的位置；</li><li>例子a=[2,3,1,1,4]</li><li>开始,第a[0]=2，则【L,R】=【0,2】，在此区间内可以到达的位置为{a[0]+0, a[1]+1, a[2]+2} = {2+0, 3+1, 1+2}，最大值为a[1]+1=3+1，所以下一个跳跃的位置就为a[1];</li><li>L=1,R=a[1]=3，则【L,R】=【1,4】，在此区间内可到达的位置{a[1]+1, a[2]+2, a[3]+3, a[4]+4}={3+1,1+2,1+3,4+4}={4,3,4,8},最大值为a[4]+4=8,所以下一次跳跃的位置为a[4]，即跳到最后一个位置至少要2步。</li></ul></li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">jump</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//不用跳的情况</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> a <span class="token operator">==</span> null <span class="token operator">||</span> a<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> step <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * 另L、R均表示数组的下标位置         * 在[L,R]范围内找出最大的数作为下一个跳跃的位置，所以关键是怎么找出下一个跳跃的位置         * 例子a=[2,3,1,1,4]         * 开始,第a[0]=2，则【L,R】=【0,2】，在此区间内可以到达的位置为{a[0]+0,a[1]+1,a[2]+2}={2+0,3+1,1+2},最大值为a[1]+1=3+1，所以下一个跳跃的位置就为a[1];         * L=1,R=a[1]=3,则【L,R】=【1,4】，在此区间内可到达的位置{a[1]+1,a[2]+2,a[3]+3,a[4]+4}={3+1,1+2,1+3,4+4}={4,3,4,8},最大值为a[4]+4=8,所以下一次跳跃的位置为a[4]，即跳到最后一个位置至少要2步。         */</span>        <span class="token keyword">int</span> L <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> R <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>R <span class="token operator">&lt;</span> a<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 区间中可以跳跃的最大位置</span>            <span class="token keyword">int</span> maxIndex <span class="token operator">=</span> a<span class="token punctuation">[</span>L<span class="token punctuation">]</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// 取区间内a[i]+i最大值</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span> L<span class="token punctuation">;</span> i<span class="token operator">&lt;=</span>R<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                maxIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> maxIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            L <span class="token operator">=</span> R <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            R <span class="token operator">=</span> maxIndex<span class="token punctuation">;</span>            step<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> step<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>    </code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>输出正整数N以内的所有质数（素数）</title>
      <link href="/2019/03/06/GetPrimes/"/>
      <url>/2019/03/06/GetPrimes/</url>
      
        <content type="html"><![CDATA[<h3 id="输出N以内的所有质数（素数）"><a href="#输出N以内的所有质数（素数）" class="headerlink" title="输出N以内的所有质数（素数）"></a>输出N以内的所有质数（素数）</h3><p>例如：输入20，输出[2,3,5,7,11,13,17,19]</p><h3 id="方法1：贪心算法"><a href="#方法1：贪心算法" class="headerlink" title="方法1：贪心算法"></a>方法1：贪心算法</h3><p>看到这到题时，立刻就能想到用嵌套循环，对于任意的n对【2，n-1】之间每个数取余，如果余数0，说明能除尽，则不是素数（质数）。</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * 贪心算法     * @param num     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> <span class="token function">getPrimes</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>num <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">int</span> n <span class="token operator">=</span> num<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span>n <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>num <span class="token operator">%</span> n <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    n<span class="token operator">--</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span>                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            num<span class="token operator">--</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> list<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="方法2：算法改进"><a href="#方法2：算法改进" class="headerlink" title="方法2：算法改进"></a>方法2：算法改进</h3><p>其实，贪心算法中右一些多余的判断，比如，偶数肯定不是质数；对于一个正整数n只需要判断【2，n的平方根】之间的有没有整数能被n整除，如果有就不是质数。</p><pre class=" language-java"><code class="language-java">   <span class="token comment" spellcheck="true">/**     * 算法优化：每个数n只比较[2 ~ sqrt(n)]之内的奇数     * @param num     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> <span class="token function">getPrimes2</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> list<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">int</span> sqrt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span>j <span class="token operator">&lt;=</span> sqrt<span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">%</span> j <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    j <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//只判断奇数</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span>                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//只判断奇数</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> list<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>跳跃游戏</title>
      <link href="/2019/03/02/JumpGame/"/>
      <url>/2019/03/02/JumpGame/</url>
      
        <content type="html"><![CDATA[<p>给定一个非负整数数组，你最初位于数组的第一个位置。数组中的每个元素代表你在该位置可以跳跃的最大长度。判断你是否能够到达最后一个位置。<a href="https://leetcode-cn.com/problems/jump-game/" target="_blank" rel="noopener">LeetCode</a></p><p>示例1</p><pre class=" language-txt"><code class="language-txt">输入: [2,3,1,1,4]输出: true解释: 从位置 0 到 1 跳 1 步, 然后跳 3 步到达最后一个位置。</code></pre><p>示例2</p><pre class=" language-txt"><code class="language-txt">输入: [3,2,1,0,4]输出: false解释: 无论怎样，你总会到达索引为 3 的位置。但该位置的最大跳跃长度是 0 ， 所以你永远不可能到达最后一个位置。</code></pre><p>暴力解法</p><p>处理思路：令reach=0,然后遍历数组元素比较a[i]+i与reach的大小，如果比reach值大就和reach的值交换，否则reach不变，最后如果reach大于等于数组的长度，返回true，否则返回false。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canJump</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> reach <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;</span> a<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> reach<span class="token punctuation">)</span><span class="token punctuation">{</span>            reach <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>reach<span class="token punctuation">,</span> i <span class="token operator">+</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>reach <span class="token operator">>=</span> a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            i<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 算法 </tag>
            
            <tag> LeetCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式</title>
      <link href="/2019/03/02/DesignPattern/"/>
      <url>/2019/03/02/DesignPattern/</url>
      
        <content type="html"><![CDATA[<p>电商、社交网络、移动互联网……这一个个名称成为近几年来互联网发展的代名词，而在背后推动者中高数发展的就是技术。敏捷开发是互联网企业进行产品开发时常用的一种模式，一个产品从制定需求到上线甚至在一周之内就要王朝，毕竟快竞争对手一步才能抓住更多的用户。在这种情况下，一些久经考验的架构模式被广泛的使用起来，当确定一个产品的架构方案时，”设计模式“一词被越来越多的提出来，甚至一些公司既定的框架就是某一个或几个设计模式的体现。</p><p>设计模式（Design Pattern）是一套面向对象的代码设计经验的总结，是在编程领域被反复使用、被多人知晓、而且巾帼分类整理的代码设计方法。最经典的设计模式是由GOF（“四人帮”）在1995年提出的23种设计模式。设计模式有23种单不仅仅限于23种，<a href="https://en.wikipedia.org/wiki/Design_Patterns" target="_blank" rel="noopener">维基百科</a>中对软件的各种设计模式有很详细的介绍。</p><h2 id="设计模式六大原则"><a href="#设计模式六大原则" class="headerlink" title="设计模式六大原则"></a>设计模式六大原则</h2><h3 id="单一职责原则"><a href="#单一职责原则" class="headerlink" title="单一职责原则"></a>单一职责原则</h3><p>单一职责原则也被称作接口隔离原则，其定义：对于一个类，应该只有一个引起它变化的原因。</p><p>单一职责的本质是使用多个隔离的接口，比使用单个接口要好。还是一个降低类之间的耦合度的意思，从这儿我们看出，其实设计模式就是一个软件的设计思想，从大型软件架构出发，为了升级和维护方便。</p><h3 id="里氏代换原则"><a href="#里氏代换原则" class="headerlink" title="里氏代换原则"></a>里氏代换原则</h3><p>里氏代换原则的定义：子类必须能够替换掉它们的父类型。</p><h3 id="开闭原则"><a href="#开闭原则" class="headerlink" title="开闭原则"></a>开闭原则</h3><p>开闭原则的定义 ：程序的实体对象（模块、类、函数）应该可以进行扩展，但不应该可以修改。</p><p>开闭原则有两个特征：</p><ul><li><p>对于扩展是开放的；</p></li><li><p>对于修改是封闭的；</p></li></ul><h3 id="依赖倒转原则"><a href="#依赖倒转原则" class="headerlink" title="依赖倒转原则"></a>依赖倒转原则</h3><p>依赖倒转原则的定义：程序的高层模块不应该依赖于底层模块，但两者都应该依赖于抽象；抽象不应该依赖于具体细节，而细节应该依赖于抽象。通俗的讲就是面向对象应该针对接口编程，而不是针对实现编程。</p><p>依赖倒转原则的本质是通过抽象（接口或抽象类）使各个类或模块的实现彼此独立，互不影响，从而实现模块间的松耦合。</p><h3 id="合成复用原则"><a href="#合成复用原则" class="headerlink" title="合成复用原则"></a>合成复用原则</h3><p>合成复用原则的定义：尽量不使用继承，而尽量使用合成/聚合。</p><p>合成于聚和都是类之间特殊的关联关系。聚合表示比较“弱”的拥有关系，具体体现是甲对象中可以包含乙对象，但乙对象不不是甲对象的一部分；合成则是一种比较“强”的拥有关系，体现的是严格的整体与部分之间的关系，并且整体与部分拥有相同的生命周期。比如鱼和鱼群是聚合关系，手臂和人体之间是部分与整体的合成关系。</p><h3 id="迪米特法则"><a href="#迪米特法则" class="headerlink" title="迪米特法则"></a>迪米特法则</h3><p>迪米特法则也被称作最少知道原则，就是说一个对象应当尽可能少地了解其他对象——不和陌生人说话。</p><p>迪米特法则的定义：如果两个类之间不必直接通信，则这两个类不应该发生直接的相互作用。如果其中的一个类需要调用另一个类的某个方法，可以通过第三者来转发这个调用。</p><h2 id="23种经典设计模式"><a href="#23种经典设计模式" class="headerlink" title="23种经典设计模式"></a>23种经典设计模式</h2><h3 id="设计模式的分类"><a href="#设计模式的分类" class="headerlink" title="设计模式的分类"></a>设计模式的分类</h3><p>根据各种设计模式的特点，可以将设计模式简单分为三类：创建型模式、结构型模式、行为模式。</p><ul><li>创建型模式，有5种：工厂方法模式、抽象工厂模式、单例模式、建造者模式、原型模式；</li><li>结构型模式，有7种：桥接模式、适配器模式、装饰模式、组合模式、享元模式、外观模式、代理模式；</li><li>行为模式，有11种：模版方法模式、策略模式、状态模式、观察者模式、备忘录模式、中介者模式、命令模式、访问者模式、责任链模式、迭代器模式、解释器模式；</li></ul><h3 id="一、创建型模式"><a href="#一、创建型模式" class="headerlink" title="一、创建型模式"></a>一、创建型模式</h3><h4 id="1-工厂方法模式"><a href="#1-工厂方法模式" class="headerlink" title="1.工厂方法模式"></a>1.工厂方法模式</h4><p>工厂方法模式的定义：定义一个用于创建对象的接口，让子类决定实例化哪一个类。工厂方法是一个类的实例化延迟到其子类。</p><p>工厂方法模式由抽象工厂、具体工厂、抽象产品和具体产品等4个要素构成。</p><p>工厂方法模式的主要角色如下：</p><ol><li>抽象工厂（Abstract Factory）：提供了创建产品的接口，调用者通过它访问具体工厂的工厂方法 newProduct() 来创建产品。</li><li>具体工厂（ConcreteFactory）：主要是实现抽象工厂中的抽象方法，完成具体产品的创建。</li><li>抽象产品（Product）：定义了产品的规范，描述了产品的主要特性和功能。</li><li>具体产品（ConcreteProduct）：实现了抽象产品角色所定义的接口，由具体工厂来创建，它同具体工厂之间一一对应。</li></ol><p>结构图：</p><p><img src="/2019/03/02/DesignPattern/FactoryMethodPattern.png" alt></p><p>示例（电视工厂生产电视）：</p><p>创建电视接口类：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TV</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>创建电视的实现类：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HairTV</span> <span class="token keyword">implements</span> <span class="token class-name">TV</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"海尔电视播放..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TCLTV</span> <span class="token keyword">implements</span> <span class="token class-name">TV</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TCL电视播放..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XiaoMiTV</span> <span class="token keyword">implements</span> <span class="token class-name">TV</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"小米电视播放..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>创建工厂接口：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TVFactory</span> <span class="token punctuation">{</span>    TV <span class="token function">produceTV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>创建工厂的实现类：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HairTVFactory</span> <span class="token keyword">implements</span> <span class="token class-name">TVFactory</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> TV <span class="token function">produceTV</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"海尔电视工厂 生产 海尔电视"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HairTV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TCLTVFactory</span> <span class="token keyword">implements</span> <span class="token class-name">TVFactory</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> TV <span class="token function">produceTV</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TCL电视工厂 生产 TCL电视"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TCLTV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XiaoMiTVFactory</span> <span class="token keyword">implements</span> <span class="token class-name">TVFactory</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> TV <span class="token function">produceTV</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"小米电视工厂 生产 小米电视"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">XiaoMiTV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>测试</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        TV haierTV <span class="token operator">=</span>  null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 定义tv对象</span>        TVFactory hairTVFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HairTVFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 定义工厂</span>        haierTV <span class="token operator">=</span> hairTVFactory<span class="token punctuation">.</span><span class="token function">produceTV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 创建电视对象</span>        haierTV<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 播放电视</span>        TV tclTV <span class="token operator">=</span>  null<span class="token punctuation">;</span>        TVFactory tclTVFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TCLTVFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tclTV <span class="token operator">=</span> tclTVFactory<span class="token punctuation">.</span><span class="token function">produceTV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tclTV<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TV xiaomiTV <span class="token operator">=</span>  null<span class="token punctuation">;</span>        TVFactory xiaomiTVFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XiaoMiTVFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        xiaomiTV <span class="token operator">=</span> xiaomiTVFactory<span class="token punctuation">.</span><span class="token function">produceTV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        xiaomiTV<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：海尔电视工厂 生产 海尔电视海尔电视播放<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>TCL电视工厂 生产 TCL电视TCL电视播放<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>小米电视工厂 生产 小米电视小米电视播放<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>工厂方法模式总结</p><p>优点有：</p><ul><li>用户只需要知道具体工厂的名称就可得到所要的产品，无须知道产品的具体创建过程；</li><li>在系统增加新的产品时只需要添加具体产品类和对应的具体工厂类，无须对原工厂进行任何修改，满足开闭原则；</li></ul><p>缺点是：每增加一个产品就要增加一个具体产品类和一个对应的具体工厂类，这增加了系统的复杂度。</p><p>适用性：</p><ul><li><p>当客户端类不知道它所创建的对象的具体类时，例如需要创建一个电视，但是并不知道创建的是哪种电视；</p></li><li><p>当一个类希望有它的子类来来确定它所创建的对象时；</p></li><li><p>当类间创建对象的职责委托给多个子类中的某一个，并且希望将哪一个子类是代理者这一信息局部化时。</p></li></ul><h4 id="2-抽象工厂模式"><a href="#2-抽象工厂模式" class="headerlink" title="2.抽象工厂模式"></a>2.抽象工厂模式</h4><p>抽象工厂模式的定义：提供一个创建一系列相关或相互依赖对象的接口，而无需指定他们具体的类。</p><p>抽象工厂模式是工厂方法模式的升级版，工厂方法模式只生产一个系列的产品，而抽象工厂模式可生产多个系列的产品，抽象工厂模式为产品系列提供了一个好的解决方案。抽象工厂模式和工厂方法模式相同也是由抽象工厂、具体工厂、抽象产品和具体产品等4个要素构成。</p><p>工厂方法模式的主要角色如下：</p><ol><li>抽象工厂（Abstract Factory）：提供了创建产品的接口，调用者通过它访问具体工厂的工厂方法 newProduct() 来创建产品。</li><li>具体工厂（ConcreteFactory）：主要是实现抽象工厂中的抽象方法，完成具体产品的创建。</li><li>抽象产品（Product）：定义了产品的规范，描述了产品的主要特性和功能。</li><li>具体产品（ConcreteProduct）：实现了抽象产品角色所定义的接口，由具体工厂来创建，它同具体工厂之间一一对应。</li></ol><p>结构图：</p><p><img src="/2019/03/02/DesignPattern/AbstractFactoryPattern.png" alt></p><p>示例：</p><p>创建1个抽象工厂接口</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractFactory</span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">abstract</span> AbstractProductA <span class="token function">produceProductA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> AbstractProductB <span class="token function">produceProductB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>创建2个抽象产品接口</p><pre class=" language-Java"><code class="language-Java">public abstract class AbstractProductA {    //每个产品共有的方法    public void shareMethod(){          System.out.println("A产品的共有方法");    }    //每个产品相同方法，不同实现    public abstract void doSomething(); }</code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractProductB</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//每个产品共有的方法</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shareMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"B产品的共有方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//每个产品相同方法，不同实现</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre><p>抽象工厂AbstractFactory的两个实现类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Factory1</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractFactory</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> AbstractProductA <span class="token function">produceProductA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"【1级产品工厂】：生产1级产品A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ProductA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> AbstractProductB <span class="token function">produceProductB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"【1级产品工厂】：生产1级产品B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ProductB1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Factory2</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractFactory</span><span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> AbstractProductA <span class="token function">produceProductA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"【2级产品工厂】：生产2级产品A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ProductA2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> AbstractProductB <span class="token function">produceProductB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"【2级产品工厂】：生产2级产品B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ProductB2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>抽象产品AbstractProductA的实现类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductA1</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractProductA</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1级产品A的实现方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductA2</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractProductA</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2级产品A的实现方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>抽象产品AbstractProductB的实现类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductB1</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractProductB</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1级产品B的实现方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductB2</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractProductB</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2级产品B的实现方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>测试</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//定义出两个工厂</span>        AbstractFactory factory1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Factory1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         AbstractFactory factory2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Factory2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//产生A1对象</span>        AbstractProductA a1 <span class="token operator">=</span>  factory1<span class="token punctuation">.</span><span class="token function">produceProductA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//产生A2对象</span>        AbstractProductA a2 <span class="token operator">=</span> factory2<span class="token punctuation">.</span><span class="token function">produceProductA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//产生B1对象</span>        AbstractProductB b1 <span class="token operator">=</span> factory1<span class="token punctuation">.</span><span class="token function">produceProductB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//产生B2对象</span>        AbstractProductB b2 <span class="token operator">=</span> factory2<span class="token punctuation">.</span><span class="token function">produceProductB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        a1<span class="token punctuation">.</span><span class="token function">shareMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        a1<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        a2<span class="token punctuation">.</span><span class="token function">shareMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        a2<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        b1<span class="token punctuation">.</span><span class="token function">shareMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        b1<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        b2<span class="token punctuation">.</span><span class="token function">shareMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        b2<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：【<span class="token number">1</span>级产品工厂】：生产<span class="token number">1</span>级产品A【<span class="token number">2</span>级产品工厂】：生产<span class="token number">2</span>级产品A【<span class="token number">1</span>级产品工厂】：生产<span class="token number">1</span>级产品B【<span class="token number">2</span>级产品工厂】：生产<span class="token number">2</span>级产品BA产品的共有方法<span class="token number">1</span>级产品A的实现方法A产品的共有方法<span class="token number">2</span>级产品A的实现方法B产品的共有方法<span class="token number">1</span>级产品B的实现方法B产品的共有方法<span class="token number">2</span>级产品B的实现方法</code></pre><p>抽象工厂模式总结</p><p>主要优点如下：</p><ul><li>分离了具体的类，工厂封装了创建产品对象的责任和过程，将客户端和类的实现分类。客户端通过抽象接口操纵实例。</li><li>易于交换产品系列，一个具体的工厂类在一个应用中仅在初始化时出现一次，改变一个具体工厂变得容易。</li><li>有利于产品的一致性，一个系列中的产品对象被设计在一起工作时，一个应用一次只能使用同一系列中的对象。</li></ul><p>其缺点是：难以支持新种类的产品，抽象工厂已经确定了可以被创建的产品集合。当产品族中需要增加一个新的产品时，所有的工厂类都需要进行修改。</p><h4 id="3-单例模式"><a href="#3-单例模式" class="headerlink" title="3.单例模式"></a>3.单例模式</h4><p>单例模式的定义：保证一个类仅有一个实例，并提供一个访问它的全局访问点。</p><p>在计算机系统中，还有 Windows 的回收站、操作系统中的文件系统、多线程中的线程池、显卡的驱动程序对象、打印机的后台处理服务、应用程序的日志对象、数据库的连接池、网站的计数器、Web 应用的配置对象、应用程序中的对话框、系统中的缓存等常常被设计成单例。</p><p>单例模式有 3 个特点：</p><ul><li><p>单例类只有一个实例对象；</p></li><li><p>该单例对象必须由单例类自行创建；</p></li><li><p>单例类对外提供一个访问该单例的全局访问点；</p></li></ul><p>结构图：</p><p><img src="/2019/03/02/DesignPattern/SingletonPattern.png" alt></p><p>示例，创建单例的几种方式：</p><ul><li><p>简单的懒汉单例模式</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazySingleton</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//私有静态变量</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> LazySingleton singleton <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//私有构造方法</span>    <span class="token keyword">private</span> <span class="token function">LazySingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//获取实例</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> LazySingleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>singleton <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//方便线程测试，休眠一定时间</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这是最简单的创建单例的方式，这种方式在并发的情况下存在线程安全问题，因为<code>singleton = new LazySingleton();</code>并非原子操纵。</p><p>接着，验证线程安全性：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazySingletonTest</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        LazySingletonTest<span class="token punctuation">[</span><span class="token punctuation">]</span> mts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySingletonTest</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mts<span class="token punctuation">.</span>length <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>              mts<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySingletonTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> mts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              mts<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>     <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>LazySingleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token punctuation">}</span>输出结果：<span class="token number">815626842</span><span class="token number">1798433653</span><span class="token number">1865535330</span><span class="token number">880021412</span><span class="token number">218506352</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>结果很明显，实例的hashcode值不同，故是不同的对象。</p></li><li><p>线程安全的懒汉单例模式</p></li><li><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazySingleton2</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> LazySingleton2 lazySingleton2 <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">LazySingleton2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> LazySingleton2 <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> lazySingleton2 <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//方便线程测试，休眠一定时间</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            lazySingleton2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySingleton2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> lazySingleton2 <span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>虽然方法getInstance()通过synchronized加同步控制，能保证线程安全，但是在高并发是会出现严重的性问 题，因为每次执行方法getInstance()都需要先获取锁很消耗系统资源，只需要在第一次创建实例时加锁。为了解决上面的问题，在JDK1.5以后可以使用双校验锁单例模式，既能保持线程安全又兼顾的性能。</p><p>接着，验证线程安全性：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazySingleton2Test</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        LazySingleton2Test<span class="token punctuation">[</span><span class="token punctuation">]</span> mts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySingleton2Test</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mts<span class="token punctuation">.</span>length <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>              mts<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySingleton2Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> mts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              mts<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>     <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>LazySingleton2<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token punctuation">}</span>输出结果：<span class="token number">42265496</span><span class="token number">42265496</span><span class="token number">42265496</span><span class="token number">42265496</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></li></ul><p>​      很明显是线程安全的。</p><ul><li><p>双校验锁单例模式（DCL）</p></li><li><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DuplicationCheckSingleton</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//volatile屏蔽指令重排的语义在JDK1.5中才被修复</span>    <span class="token comment" spellcheck="true">//在此前的JDK中即使变量被声明为volatile也不能完全避免指令重排所导致的问题，这也是在JDK1.5之前的Java中无法安全的使用DCL来实现单例的原因！！</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> DuplicationCheckSingleton singleton <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">DuplicationCheckSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> DuplicationCheckSingleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>singleton <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">//1</span>            <span class="token comment" spellcheck="true">//线程测试，休眠一定时间</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>DuplicationCheckSingleton<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>singleton <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">//2</span>                    singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DuplicationCheckSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>说明：标记1处的判断是为了防止不必要的重复创建对象和加锁；在极端的情况，有多个线程同时通过了1的判断，但是当他们执行到<code>synchronized (DuplicationCheckSingleton.class)</code>时就需要先获得锁，才能执行后面的代码，如果线程没有拿到锁就会被阻塞直到其他线程把锁释放，执行到标记2处发现对象已经存在，直接返回已经存在的对象。</p><p>接着，验证线程安全性：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DuplicationCheckSingletonTest</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        DuplicationCheckSingletonTest<span class="token punctuation">[</span><span class="token punctuation">]</span> mts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DuplicationCheckSingletonTest</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mts<span class="token punctuation">.</span>length <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            mts<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DuplicationCheckSingletonTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> mts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            mts<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>DuplicationCheckSingleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：<span class="token number">1710248273</span><span class="token number">1710248273</span><span class="token number">1710248273</span><span class="token number">1710248273</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>很明显也是线程安全的，具体和前一周方式的性能差异，可以自己进行验证。</p></li><li><p>静态内部类单例模式</p></li><li><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StaticFinalInnerClassSingleton</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//静态内部类</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SingletonHolder</span><span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> StaticFinalInnerClassSingleton INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StaticFinalInnerClassSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//私有构造方法</span>    <span class="token keyword">private</span> <span class="token function">StaticFinalInnerClassSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> StaticFinalInnerClassSingleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> SingletonHolder<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>静态内部类单例模式也是线程安全的，因为在类<code>StaticFinalInnerClassSingleton</code>加载时已经完成了静态内部类<code>SingletonHolder</code>的初始化，并且只初始化一次，故是线程安全的。如下的验证：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StaticFinalInnerClassSingletonTest</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        StaticFinalInnerClassSingletonTest<span class="token punctuation">[</span><span class="token punctuation">]</span> mts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StaticFinalInnerClassSingletonTest</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mts<span class="token punctuation">.</span>length <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>              mts<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StaticFinalInnerClassSingletonTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> mts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              mts<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>     <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>StaticFinalInnerClassSingleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token punctuation">}</span>输出结果：<span class="token number">2075741586</span><span class="token number">2075741586</span><span class="token number">2075741586</span><span class="token number">2075741586</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></li></ul><h4 id="4-建造者模式"><a href="#4-建造者模式" class="headerlink" title="4.建造者模式"></a>4.建造者模式</h4><p>建造者模式的定义：将一个复杂对象的构建与它的表示分离，使得同样的构建过程可以穿就不同的表示。</p><p>建造者模式将一个复杂的对象分解为多个简单的对象，然后一步一步构建而成。它将变与不变相分离，即产品的组成部分是不变的，但每一部分是可以灵活选择的。</p><p>建造者（Builder）模式由产品、抽象建造者、具体建造者、指挥者等 4 个要素构成。</p><p>建造者（Builder）模式的主要角色如下：</p><ul><li><p>产品角色（Product）：它是包含多个组成部件的复杂对象，由具体建造者来创建其各个滅部件。</p></li><li><p>抽象建造者（Builder）：它是一个包含创建产品各个子部件的抽象方法的接口，通常还包含一个返回复杂产品的方法 getResult()。</p></li><li><p>具体建造者(Concrete Builder）：实现 Builder 接口，完成复杂产品的各个部件的具体创建方法。</p></li><li><p>指挥者（Director）：它调用建造者对象中的部件构造与装配方法完成复杂对象的创建，在指挥者中不涉及具体产品的信息。</p></li></ul><p>结构图：</p><p><img src="/2019/03/02/DesignPattern/BuilderPattern.png" alt></p><p>示例</p><p>产品Product</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> parts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPart</span><span class="token punctuation">(</span>String part<span class="token punctuation">)</span><span class="token punctuation">{</span>        parts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>part<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Product:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> parts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            String part <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>part<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>抽象建造者</p><pre><code>public interface Builder {    void buildPartA();    void buildPartB();    Product getResult();}</code></pre><p>具体建造者</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteBuilder1</span> <span class="token keyword">implements</span> <span class="token class-name">Builder</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Product product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">buildPartA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        product<span class="token punctuation">.</span><span class="token function">addPart</span><span class="token punctuation">(</span><span class="token string">"Part A1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">buildPartB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        product<span class="token punctuation">.</span><span class="token function">addPart</span><span class="token punctuation">(</span><span class="token string">"Part B1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Product <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> product<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteBuilder2</span> <span class="token keyword">implements</span> <span class="token class-name">Builder</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Product product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">buildPartA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        product<span class="token punctuation">.</span><span class="token function">addPart</span><span class="token punctuation">(</span><span class="token string">"Part A2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">buildPartB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        product<span class="token punctuation">.</span><span class="token function">addPart</span><span class="token punctuation">(</span><span class="token string">"Part B2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Product <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> product<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>指导者：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Director</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Builder builder <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Director</span><span class="token punctuation">(</span>Builder builder<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>builder <span class="token operator">=</span> builder<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Product <span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        builder<span class="token punctuation">.</span><span class="token function">buildPartA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        builder<span class="token punctuation">.</span><span class="token function">buildPartB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>测试</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Builder builder1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteBuilder1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Director director <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Director</span><span class="token punctuation">(</span>builder1<span class="token punctuation">)</span><span class="token punctuation">;</span>        Product product1 <span class="token operator">=</span> director<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        product1<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Builder builder2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteBuilder2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        director <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Director</span><span class="token punctuation">(</span>builder2<span class="token punctuation">)</span><span class="token punctuation">;</span>        Product product2 <span class="token operator">=</span> director<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        product2<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：Product<span class="token operator">:</span>Part A1Part B1Product<span class="token operator">:</span>Part A2Part B2</code></pre><p>建造者模式总结</p><p>该模式的主要优点如下：</p><ul><li><p>各个具体的建造者相互独立，有利于系统的扩展；</p></li><li><p>客户端不必知道产品内部组成的细节，便于控制细节风险；</p></li></ul><p>其缺点如下：</p><ul><li><p>产品的组成部分必须相同，这限制了其使用范围；</p></li><li><p>如果产品的内部变化复杂，该模式会增加很多的建造者类；</p></li></ul><p>适用性：</p><ul><li>建造者模式可以说是对流程的抽象，当创建复杂对象的算法应该独立于该对象的组成部分以及他们的组装方式时；</li><li>当构造过程必须允许被构造的对象有不同的表示时；</li></ul><p>建造者（Builder）模式和工厂模式的关注点不同：建造者模式注重零部件的组装过程，而工厂方法模式更注重零部件的创建过程，但两者可以结合使用。</p><h4 id="5-原型模式"><a href="#5-原型模式" class="headerlink" title="5.原型模式"></a>5.原型模式</h4><p>原型模式的定义：用原型示例指定创建对象的种类，并且通过拷贝这些原型创建新对象。</p><p>所谓原型模式，其实就是依托一个已经实例化的对象去创建另外一个可以进行定制的对象，而不需要知道创建过程中的具体细节。</p><p>原型模式包含以下主要角色。</p><ul><li><p>抽象原型类：规定了具体原型对象必须实现的接口；</p></li><li><p>具体原型类：实现抽象原型类的 clone() 方法，它是可被复制的对象；</p></li><li><p>访问类：使用具体原型类中的 clone() 方法来复制新的对象；</p></li></ul><p>结构图</p><p><img src="/2019/03/02/DesignPattern/PrototypePattern.png" alt></p><p>示例</p><p>在Java中，复制对象是通过clone()方法实现的，Java的clone()方法是浅拷贝。创建原型类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RobotPrototype</span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span>Serializable<span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> rid<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//机器人序列号，每个机器人序列号均不相同</span>    <span class="token keyword">private</span> CPU cpu<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//使用的CPU，每个机器人的CPU均不相同</span>    <span class="token keyword">private</span> String birthday<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//生产日期</span>    <span class="token keyword">private</span> String factory<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//生产工厂</span>    <span class="token keyword">public</span> <span class="token function">RobotPrototype</span><span class="token punctuation">(</span><span class="token keyword">long</span> rid<span class="token punctuation">,</span> String birthday<span class="token punctuation">,</span> String factory<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>rid <span class="token operator">=</span> rid<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>birthday <span class="token operator">=</span> birthday<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>factory <span class="token operator">=</span> factory<span class="token punctuation">;</span>        cpu <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getRid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> rid<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRid</span><span class="token punctuation">(</span><span class="token keyword">long</span> rid<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>rid <span class="token operator">=</span> rid<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCpu</span><span class="token punctuation">(</span><span class="token keyword">long</span> cpu_no<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>cpu<span class="token punctuation">.</span><span class="token function">setCpu_no</span><span class="token punctuation">(</span>cpu_no<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getBirthday</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> birthday<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBirthday</span><span class="token punctuation">(</span>String birthday<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>birthday <span class="token operator">=</span> birthday<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> factory<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFactory</span><span class="token punctuation">(</span>String factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>factory <span class="token operator">=</span> factory<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 浅拷贝     * @return     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> Object <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CloneNotSupportedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 深拷贝     * @return     */</span>    <span class="token keyword">protected</span> Object <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            ByteArrayOutputStream bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ObjectOutputStream oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>bos<span class="token punctuation">)</span><span class="token punctuation">;</span>            oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ByteArrayInputStream bis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ObjectInputStream ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>bis<span class="token punctuation">)</span><span class="token punctuation">;</span>            RobotPrototype robot <span class="token operator">=</span> <span class="token punctuation">(</span>RobotPrototype<span class="token punctuation">)</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            robot<span class="token punctuation">.</span><span class="token function">setCpu</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            robot<span class="token punctuation">.</span><span class="token function">setRid</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> robot<span class="token punctuation">.</span>cpu<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> robot<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"机器人序列号："</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rid <span class="token operator">+</span> <span class="token string">"\n\t"</span> <span class="token operator">+</span>                <span class="token string">"生产日期："</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>birthday  <span class="token operator">+</span> <span class="token string">"\n\t"</span> <span class="token operator">+</span>                <span class="token string">"生产工程："</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factory <span class="token operator">+</span> <span class="token string">"\n\t"</span> <span class="token operator">+</span>                <span class="token string">"使用的CPU信息："</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cpu<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n\t"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>通过对象的序列化和反序列化来实现深拷贝。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CPU</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> cpu_no<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//cpu序列号，每个CPU序列号均不相同</span>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getCpu_no</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> cpu_no<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCpu_no</span><span class="token punctuation">(</span><span class="token keyword">long</span> cpu_no<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>cpu_no <span class="token operator">=</span> cpu_no <span class="token operator">+</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"cpu_no: "</span> <span class="token operator">+</span> cpu_no <span class="token operator">+</span> <span class="token string">", hashCode:"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>测试</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        RobotPrototype protype_robot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RobotPrototype</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"2018-4-26"</span><span class="token punctuation">,</span> <span class="token string">"富士康机器人生产工厂"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        protype_robot<span class="token punctuation">.</span><span class="token function">setCpu</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"原型机 ["</span> <span class="token operator">+</span> protype_robot<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            RobotPrototype robot <span class="token operator">=</span> <span class="token punctuation">(</span>RobotPrototype<span class="token punctuation">)</span> protype_robot<span class="token punctuation">.</span><span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"robot"</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">" ["</span> <span class="token operator">+</span> robot<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：原型机 <span class="token punctuation">[</span>机器人序列号：<span class="token number">1551522612533</span>    生产日期：<span class="token number">2018</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">-</span><span class="token number">26</span>    生产工程：富士康机器人生产工厂    使用的CPU信息：cpu_no<span class="token operator">:</span> <span class="token number">199939540956962</span><span class="token punctuation">,</span> hashCode<span class="token operator">:</span><span class="token number">1826771953</span>    <span class="token punctuation">]</span>robot0 <span class="token punctuation">[</span>机器人序列号：<span class="token number">1552334878300</span>    生产日期：<span class="token number">2018</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">-</span><span class="token number">26</span>    生产工程：富士康机器人生产工厂    使用的CPU信息：cpu_no<span class="token operator">:</span> <span class="token number">199939636725580</span><span class="token punctuation">,</span> hashCode<span class="token operator">:</span><span class="token number">812265671</span>    <span class="token punctuation">]</span>robot1 <span class="token punctuation">[</span>机器人序列号：<span class="token number">1551715676989</span>    生产日期：<span class="token number">2018</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">-</span><span class="token number">26</span>    生产工程：富士康机器人生产工厂    使用的CPU信息：cpu_no<span class="token operator">:</span> <span class="token number">199939637142517</span><span class="token punctuation">,</span> hashCode<span class="token operator">:</span><span class="token number">193064360</span>    <span class="token punctuation">]</span>robot2 <span class="token punctuation">[</span>机器人序列号：<span class="token number">1551632574171</span>    生产日期：<span class="token number">2018</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">-</span><span class="token number">26</span>    生产工程：富士康机器人生产工厂    使用的CPU信息：cpu_no<span class="token operator">:</span> <span class="token number">199939637444134</span><span class="token punctuation">,</span> hashCode<span class="token operator">:</span><span class="token number">109961541</span>    <span class="token punctuation">]</span>robot3 <span class="token punctuation">[</span>机器人序列号：<span class="token number">1552193313008</span>    生产日期：<span class="token number">2018</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">-</span><span class="token number">26</span>    生产工程：富士康机器人生产工厂    使用的CPU信息：cpu_no<span class="token operator">:</span> <span class="token number">199939637755232</span><span class="token punctuation">,</span> hashCode<span class="token operator">:</span><span class="token number">670700378</span>    <span class="token punctuation">]</span>robot4 <span class="token punctuation">[</span>机器人序列号：<span class="token number">1552713267456</span>    生产日期：<span class="token number">2018</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">-</span><span class="token number">26</span>    生产工程：富士康机器人生产工厂    使用的CPU信息：cpu_no<span class="token operator">:</span> <span class="token number">199939638066609</span><span class="token punctuation">,</span> hashCode<span class="token operator">:</span><span class="token number">1190654826</span>    <span class="token punctuation">]</span>robot5 <span class="token punctuation">[</span>机器人序列号：<span class="token number">1552631984200</span>    生产日期：<span class="token number">2018</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">-</span><span class="token number">26</span>    生产工程：富士康机器人生产工厂    使用的CPU信息：cpu_no<span class="token operator">:</span> <span class="token number">199939638432856</span><span class="token punctuation">,</span> hashCode<span class="token operator">:</span><span class="token number">1109371569</span>    <span class="token punctuation">]</span>robot6 <span class="token punctuation">[</span>机器人序列号：<span class="token number">1552251503125</span>    生产日期：<span class="token number">2018</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">-</span><span class="token number">26</span>    生产工程：富士康机器人生产工厂    使用的CPU信息：cpu_no<span class="token operator">:</span> <span class="token number">199939638821939</span><span class="token punctuation">,</span> hashCode<span class="token operator">:</span><span class="token number">728890494</span>    <span class="token punctuation">]</span>robot7 <span class="token punctuation">[</span>机器人序列号：<span class="token number">1553081212960</span>    生产日期：<span class="token number">2018</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">-</span><span class="token number">26</span>    生产工程：富士康机器人生产工厂    使用的CPU信息：cpu_no<span class="token operator">:</span> <span class="token number">199939639177528</span><span class="token punctuation">,</span> hashCode<span class="token operator">:</span><span class="token number">1558600329</span>    <span class="token punctuation">]</span>robot8 <span class="token punctuation">[</span>机器人序列号：<span class="token number">1552159331444</span>    生产日期：<span class="token number">2018</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">-</span><span class="token number">26</span>    生产工程：富士康机器人生产工厂    使用的CPU信息：cpu_no<span class="token operator">:</span> <span class="token number">199939639639177</span><span class="token punctuation">,</span> hashCode<span class="token operator">:</span><span class="token number">636718812</span>    <span class="token punctuation">]</span>robot9 <span class="token punctuation">[</span>机器人序列号：<span class="token number">1551967664265</span>    生产日期：<span class="token number">2018</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">-</span><span class="token number">26</span>    生产工程：富士康机器人生产工厂    使用的CPU信息：cpu_no<span class="token operator">:</span> <span class="token number">199939640067454</span><span class="token punctuation">,</span> hashCode<span class="token operator">:</span><span class="token number">445051633</span>    <span class="token punctuation">]</span></code></pre><p>原型模式总结</p><p>原型模式适用于以下几种情景：</p><ul><li><p>当要实例化的类是在运行时刻指定时；</p></li><li><p>为了避免创建一个与产品类层次平行的工厂类层次时；</p></li><li><p>当一个类的实例只能有几个不同状态组合中的一种时；</p></li></ul><h3 id="二、结构型模式"><a href="#二、结构型模式" class="headerlink" title="二、结构型模式"></a>二、结构型模式</h3><h4 id="1-桥接模式"><a href="#1-桥接模式" class="headerlink" title="1.桥接模式"></a>1.桥接模式</h4><p>桥接模式的定义：将抽象部分与它的的实现部分分离，使它们都可以独立地变化。它是用组合关系代替继承关系来实现，从而降低了抽象和实现这两个可变维度的耦合度。</p><p>桥接（Bridge）模式包含以下主要角色：</p><ol><li><strong>抽象化（Abstraction）</strong>角色：定义抽象类，并包含一个对实现化对象的引用。</li><li><strong>扩展抽象化（Refined Abstraction）</strong>角色：是抽象化角色的子类，实现父类中的业务方法，并通过组合关系调用实现化角色中的业务方法。</li><li><strong>实现化（Implementor）角色</strong>：定义实现化角色的接口，供扩展抽象化角色调用。</li><li><strong>具体实现化（Concrete Implementor）</strong>角色：给出实现化角色接口的具体实现。</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/BridgePattern.png" alt></p><p>示例</p><p>实现化角色</p><pre class=" language-java"><code class="language-java"> <span class="token comment" spellcheck="true">//Implementor</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DrawingAPI</span><span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">drawCircle</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">double</span> y<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">double</span> radius<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>抽象化角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//Abstraction</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Shape</span><span class="token punctuation">{</span>    <span class="token keyword">protected</span> DrawingAPI drawingAPI<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token function">Shape</span><span class="token punctuation">(</span><span class="token keyword">final</span> DrawingAPI drawingAPI<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>drawingAPI <span class="token operator">=</span> drawingAPI<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//low level</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">resizeByPercentage</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">double</span> pct<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//height level</span><span class="token punctuation">}</span></code></pre><p>扩展抽象化</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//RefinedAbstraction</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CircleShape</span> <span class="token keyword">extends</span> <span class="token class-name">Shape</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">double</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> radius<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">CircleShape</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">double</span> y<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">double</span> radius<span class="token punctuation">,</span> <span class="token keyword">final</span> DrawingAPI drawingAPI<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>drawingAPI<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>radius <span class="token operator">=</span> radius<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// low-level Implementation specific</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        drawingAPI<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> radius<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// high-level Abstraction specific</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">resizeByPercentage</span><span class="token punctuation">(</span><span class="token keyword">double</span> pct<span class="token punctuation">)</span> <span class="token punctuation">{</span>        radius <span class="token operator">*=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">+</span> pct<span class="token operator">/</span><span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体实现化角色1</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">//ConcreteImplementor 1</span>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DrawingAPI1</span> <span class="token keyword">implements</span> <span class="token class-name">DrawingAPI</span><span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">drawCircle</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">,</span> <span class="token keyword">double</span> radius<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"API1.circle at %f:%f radius %f\n"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> radius<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>具体实现化角色2</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">//ConcreteImplementor 2</span>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DrawingAPI2</span> <span class="token keyword">implements</span> <span class="token class-name">DrawingAPI</span><span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">drawCircle</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">,</span> <span class="token keyword">double</span> radius<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"API2.circle at %f:%f radius %f\n"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> radius<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Shape<span class="token punctuation">[</span><span class="token punctuation">]</span> shapes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shape</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>          <span class="token keyword">new</span> <span class="token class-name">CircleShape</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">2.0</span><span class="token punctuation">,</span><span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DrawingAPI1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token keyword">new</span> <span class="token class-name">CircleShape</span><span class="token punctuation">(</span><span class="token number">5.0</span><span class="token punctuation">,</span><span class="token number">7.0</span><span class="token punctuation">,</span><span class="token number">11.0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DrawingAPI2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>Shape shape <span class="token operator">:</span> shapes<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//shape.draw();</span>            shape<span class="token punctuation">.</span><span class="token function">resizeByPercentage</span><span class="token punctuation">(</span><span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            shape<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：API1<span class="token punctuation">.</span>circle at <span class="token number">1.000000</span><span class="token operator">:</span><span class="token number">2.000000</span> radius <span class="token number">3.075000</span>API2<span class="token punctuation">.</span>circle at <span class="token number">5.000000</span><span class="token operator">:</span><span class="token number">7.000000</span> radius <span class="token number">11.275000</span></code></pre><p>示例2</p><p>数学课程（实现化角色）</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 数学课程，Implementor */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Math</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>高等数学（具体实现化角色）</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 高等数学类，ConcreteImplementor */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdvanceMath</span> <span class="token keyword">extends</span> <span class="token class-name">Math</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"选择了高等数学"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>数学分析（具体实现化角色）</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 数学分析类，ConcreteImplementor */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MathAnalysis</span> <span class="token keyword">extends</span> <span class="token class-name">Math</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"选择了数学分析"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>学院（抽象化角色）</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 院系类，Abstraction */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Department</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 院系包含的课程</span>    <span class="token keyword">protected</span> Math mathCourse<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCourse</span><span class="token punctuation">(</span>Math math<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>mathCourse <span class="token operator">=</span> math<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//选择课程</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>计算机学院（扩展抽象化角色）</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 计算机学院，RefinedAbstraction */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComputerDpt</span> <span class="token keyword">extends</span> <span class="token class-name">Department</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"计算机学院的同学开始选课了："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mathCourse<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>数学院（扩展抽象化角色）</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 数学院，RefinedAbstraction */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MathematicsDpt</span> <span class="token keyword">extends</span> <span class="token class-name">Department</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"数学院的同学开始选课了："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mathCourse<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Department dp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComputerDpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dp<span class="token punctuation">.</span><span class="token function">setCourse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AdvanceMath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dp<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MathematicsDpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dp<span class="token punctuation">.</span><span class="token function">setCourse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MathAnalysis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dp<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：计算机学院的同学开始选课了：选择了高等数学数学院的同学开始选课了：选择了数学分析</code></pre><p>桥接模式总结</p><p>桥接（Bridge）模式的优点是：</p><ul><li>由于抽象与实现分离，所以扩展能力强；</li><li>其实现细节对客户透明。</li></ul><p>缺点是：由于聚合关系建立在抽象层，要求开发者针对抽象化进行设计与编程，这增加了系统的理解与设计难度。</p><p>桥接模式通常适用于以下场景：</p><ol><li>当一个类存在两个独立变化的维度，且这两个维度都需要进行扩展时；</li><li>当一个系统不希望使用继承或因为多层次继承导致系统类的个数急剧增加时；</li><li>当一个系统需要在构件的抽象化角色和具体化角色之间增加更多的灵活性时。</li></ol><h4 id="2-适配器模式"><a href="#2-适配器模式" class="headerlink" title="2.适配器模式"></a>2.适配器模式</h4><p>适配器模式（AdapterPattern），也称为包装器模式。在实际的软件开发项目中，经常会遇到以前编写的模块的接口跟当前设计的模块接口不吻合以至于无法复用情况，这种情况在项目中就需要使用适配器模式。</p><p>适配器模式定义：将一个类的接口转换成客户所希望的另外一个接口。适配器模式使原本由于接口不兼容而不能再一起工作的那些类可以在一起工作。</p><p>适配器模式有两种类型：<strong>类适配器模式</strong>和<strong>对象适配器模式</strong>，前者类之间的耦合度比后者高，且要求程序员了解现有组件库中的相关组件的内部结构，所以应用相对较少些。类适配器模式可采用多重继承方式实现，如 <a href="http://c.biancheng.net/cplus/" target="_blank" rel="noopener">C++</a> 可定义一个适配器类来同时继承当前系统的业务接口和现有组件库中已经存在的组件接口；<a href="http://c.biancheng.net/java/" target="_blank" rel="noopener">Java</a> 不支持多继承，但可以定义一个适配器类来实现当前系统的业务接口，同时又继承现有组件库中已经存在的组件。</p><p>适配器模式（Adapter）包含以下主要角色：</p><ol><li><strong>目标（Target）接口</strong>：当前系统业务所期待的接口，它可以是抽象类或接口。</li><li><strong>适配者（Adaptee）类</strong>：它是被访问和适配的现存组件库中的组件接口。</li><li><strong>适配器（Adapter）类</strong>：它是一个转换器，通过继承或引用适配者的对象，把适配者接口转换成目标接口，让客户按目标接口的格式访问适配者。</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/AdapterPattern.png" alt></p><p>对象适配器示例</p><p>目标接口</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Target</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//原有方法</span>    <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>适配者</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Adaptee</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">specificRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户发起的特殊请求"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>适配器</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Adapter</span> <span class="token keyword">implements</span> <span class="token class-name">Target</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//包含一个私有的Adaptee对象</span>    <span class="token keyword">private</span> Adaptee adaptee <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Adaptee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//覆盖原有的request方法</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户发起的普通请求"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        adaptee<span class="token punctuation">.</span><span class="token function">specificRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//客户基本请求</span>        Target target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Adapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------开始适配------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//客户的特殊请求，需要调用Adapter的方法</span>        target<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>开始适配<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>客户发起的普通请求客户发起的特殊请求</code></pre><p>类适配器示例</p><p>目标接口</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Target</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//客户端期待得到的接口</span>    <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>适配者</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Adaptee</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">specificRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户发起的特殊请求"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>适配器</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Adapter</span> <span class="token keyword">extends</span> <span class="token class-name">Adaptee</span> <span class="token keyword">implements</span> <span class="token class-name">Target</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 目标接口要求调用request()这个方法名，但源类Adaptee没有方法request()     * 因此适配器补充上这个方法名     * 但实际上request()只是调用源类Adaptee的specificRequest()方法的内容     * 所以适配器只是将specificRequest()方法作了一层封装，封装成Target可以调用的request()而已     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户发起的普通请求"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">specificRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Target mAdapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Adapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mAdapter<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：客户发起的普通请求客户发起的特殊请求</code></pre><p>适配器模式总结</p><p>对象适配器和类适配器的区别：</p><ul><li><p>对象适配器是通过对象组合的方式来实现的；</p></li><li><p>类适配器使通过类继承的方式来实现的；</p></li></ul><p>该模式的主要优点如下：</p><ul><li>客户端通过适配器可以透明地调用目标接口；</li><li>复用了现存的类，程序员不需要修改原有代码而重用现有的适配者类；</li><li>将目标类和适配者类解耦，解决了目标类和适配者类接口不一致的问题；</li></ul><p>其缺点是：对类适配器来说，更换适配器的实现过程比较复杂。</p><p>适配器模式（Adapter）通常适用于以下场景：</p><ul><li>以前开发的系统存在满足新系统功能需求的类，但其接口同新系统的接口不一致；</li><li>使用第三方提供的组件，但组件接口定义和自己要求的接口定义不同；</li></ul><h4 id="3-装饰器模式"><a href="#3-装饰器模式" class="headerlink" title="3.装饰器模式"></a>3.装饰器模式</h4><p>当对一个类的功能进行扩展时，程序员往往会往类里面增加新的方法。但是，有时程序在运行中就需要生成一个具有新的行为的对象，当所增加的行为相当于整个类来说比较微小时，最好可以做到在不改变原有类文件和使用继承的情况下，动态扩展某个对象的功能。此时，就需要使用装饰器模式。</p><p>装饰器模式（Decorator) 定义：动态地给一个对象添加一些额外的职责，就新增加的功能来说，装饰器模式比生成子类更为灵活。</p><p>装饰模式主要包含以下角色：</p><ol><li><strong>抽象构件（Component）</strong>角色：定义一个抽象接口以规范准备接收附加责任的对象。</li><li><strong>具体构件（ConcreteComponent）</strong>角色：实现抽象构件，通过装饰角色为其添加一些职责。</li><li><strong>抽象装饰（Decorator）</strong>角色：继承抽象构件，并包含具体构件的实例，可以通过其子类扩展具体构件的功能。</li><li><strong>具体装饰（ConcreteDecorator）</strong>角色：实现抽象装饰的相关方法，并给具体构件对象添加附加的责任。</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/DecoratorPattern.png" alt></p><p>示例</p><p>抽象组件角色</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 基本操作</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体组件角色</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteComponent</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 基本操作</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"基本操作"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>抽象装饰器角色</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Decorator</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>    <span class="token keyword">protected</span> Component component<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setComponent</span><span class="token punctuation">(</span>Component component<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>component <span class="token operator">=</span> component<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 基本操作</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>null <span class="token operator">!=</span> component<span class="token punctuation">)</span> <span class="token punctuation">{</span>            component<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体装饰器角色A</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteDecoratorA</span> <span class="token keyword">extends</span> <span class="token class-name">Decorator</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String addedState<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        addedState <span class="token operator">=</span> <span class="token string">"新增状态"</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"这个类具有一个状态："</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>addedState<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体装饰器角色B</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteDecoratorB</span> <span class="token keyword">extends</span> <span class="token class-name">Decorator</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addedBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"现在这个对象有一个新方法！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addedBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        Component component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 实例化两个装饰器</span>        ConcreteDecorator decoratorA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteDecoratorA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ConcreteDecorator decoratorB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteDecoratorB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 对component进行装饰</span>        decoratorA<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"经过装饰器A装饰后的操作："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        decoratorA<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 对component进行装饰</span>        decoratorB<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"经过装饰器B装饰后的操作："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        decoratorB<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：经过装饰器A装饰后的操作：基本操作这个类具有一个状态：新增状态经过装饰器B装饰后的操作：基本操作现在这个对象有一个新方法！</code></pre><p>例如Java中的FilterInputStream也是使用的装饰器模式：</p><p><img src="/2019/03/02/DesignPattern/InputStream.png" alt></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DecoratorDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> FileNotFoundException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//FileInputStream被装饰者</span>        InputStream inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//装饰者</span>        <span class="token comment" spellcheck="true">//DataInputStream &lt;- FilterInputStream &lt;- InputStream</span>        FilterInputStream filterInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>装饰器模式总结</p><p>装饰（Decorator）模式的主要优点有：</p><ul><li>采用装饰模式扩展对象的功能比采用继承方式更加灵活。</li><li>可以设计出多个不同的具体装饰类，创造出多个不同行为的组合。</li></ul><p>其主要缺点是：装饰模式增加了许多子类，如果过度使用会使程序变得很复杂。</p><p>装饰器模式主要适用于以下几种情况：</p><ul><li><p>当需要以不影响其他对象为前提实现动态、透明地给单个对象添加职责时；</p></li><li><p>当需要将对象的某些职责进行撤销操作时；</p></li><li><p>当不能使用生成子类的方法进行当前系统的扩充时；</p></li></ul><h4 id="4-组合模式"><a href="#4-组合模式" class="headerlink" title="4.组合模式"></a>4.组合模式</h4><p>在现实生活中有很多部分与整体的关系，比如大学里的一个院系是一个大学的一部分，而院系所设置的学生办公室是院系的一部分。其实这种部分与整体的结构跟我们每天都有见到的树的结构非常相像。这种类型树的结构的设计模式就是组合模式。</p><p><strong>组合模式（Composite）</strong>的定义：将对象组合成树形结构以表示“部分-整体”的层次结构。组合模式使得用户对单个对象和组合对象的使用具有一致性。</p><p>组合模式包含以下主要角色：</p><ol><li><strong>抽象构件（Component）</strong>角色：它的主要作用是为树叶构件和树枝构件声明公共接口，并实现它们的默认行为。在透明式的组合模式中抽象构件还声明访问和管理子类的接口；在安全式的组合模式中不声明访问和管理子类的接口，管理工作由树枝构件完成。</li><li><strong>树叶构件（Leaf）</strong>角色：是组合中的叶节点对象，它没有子节点，用于实现抽象构件角色中 声明的公共接口。</li><li><strong>树枝构件（Composite）</strong>角色：是组合中的分支节点对象，它有子节点。它实现了抽象构件角色中声明的接口，它的主要作用是存储和管理子部件，通常包含 Add()、Remove()、GetChild() 等方法。</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/CompositePattern.png" alt></p><p>组合模式分为<strong>透明式的组合模式</strong>和<strong>安全式的组合模式</strong>：</p><ul><li><p><strong>透明方式</strong>：在该方式中，由于抽象构件声明了所有子类中的全部方法，所以客户端无须区别树叶对象和树枝对象，对客户端来说是透明的。但其缺点是：树叶构件本来没有 Add()、Remove() 及 GetChild() 方法，却要实现它们（空实现或抛异常），这样会带来一些安全性问题。</p></li><li><p><strong>安全方式</strong>：在该方式中，将管理子构件的方法移到树枝构件中，抽象构件和树叶构件没有对子对象的管理方法，这样就避免了上一种方式的安全性问题，但由于叶子和分支有不同的接口，客户端在调用时要知道树叶对象和树枝对象的存在，所以失去了透明性。</p></li></ul><p>透明组合模式示例</p><p>抽象组件</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//抽象组件</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>Component c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>Component c<span class="token punctuation">)</span><span class="token punctuation">;</span>    Component <span class="token function">getChild</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>树枝组件</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//树枝组件</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Composite</span> <span class="token keyword">implements</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>Component<span class="token operator">></span> children<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Component<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>Component c<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        children<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>Component c<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        children<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Component <span class="token function">getChild</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> children<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>Object obj<span class="token operator">:</span>children<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token punctuation">(</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>树叶组件</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//树叶组件</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Leaf</span> <span class="token keyword">implements</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Leaf</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token operator">=</span>name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>Component c<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>Component c<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> Component <span class="token function">getChild</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"树叶"</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">"：被访问！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        Component c0<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Composite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Component c1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Composite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Component leaf1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Leaf</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Component leaf2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Leaf</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Component leaf3<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Leaf</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        c0<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leaf1<span class="token punctuation">)</span><span class="token punctuation">;</span>        c0<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span><span class="token punctuation">;</span>        c1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leaf2<span class="token punctuation">)</span><span class="token punctuation">;</span>        c1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>leaf3<span class="token punctuation">)</span><span class="token punctuation">;</span>        c0<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：树叶<span class="token number">1</span>：被访问！树叶<span class="token number">2</span>：被访问！树叶<span class="token number">3</span>：被访问！</code></pre><p>安全组合模式示例</p><p>抽象组件角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//Component</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Graphic</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>树枝组件角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//Composite</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompositeGraphic</span> <span class="token keyword">implements</span> <span class="token class-name">Graphic</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//Collection of child graphics.</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>Graphic<span class="token operator">></span> childGraphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Graphic<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>Graphic graphic <span class="token operator">:</span> childGraphic<span class="token punctuation">)</span><span class="token punctuation">{</span>            graphic<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>Graphic graphic<span class="token punctuation">)</span><span class="token punctuation">{</span>        childGraphic<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>graphic<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>Graphic graphic<span class="token punctuation">)</span><span class="token punctuation">{</span>        childGraphic<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>graphic<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>树叶组件角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//Leaf</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Ellipse</span> <span class="token keyword">implements</span> <span class="token class-name">Graphic</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Ellipse print"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//Initialize four ellipses</span>        Ellipse ellipse1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ellipse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Ellipse ellipse2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ellipse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Ellipse ellipse3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ellipse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Ellipse ellipse4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ellipse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//Initialize composite graphic</span>        CompositeGraphic graphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompositeGraphic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//Composes the graphics</span>        graphic<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ellipse1<span class="token punctuation">)</span><span class="token punctuation">;</span>        graphic<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ellipse2<span class="token punctuation">)</span><span class="token punctuation">;</span>        graphic<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ellipse3<span class="token punctuation">)</span><span class="token punctuation">;</span>        graphic<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ellipse4<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//Prints the complete graphic (Four times the string "Ellipse").</span>        graphic<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：Ellipse printEllipse printEllipse printEllipse print</code></pre><p>组合模式总结</p><p>组合模式的主要优点有：</p><ul><li><p>组合模式使得客户端代码可以一致地处理单个对象和组合对象，无须关心自己处理的是单个对象，还是组合对象，这简化了客户端代码；</p></li><li><p>更容易在组合体内加入新的对象，客户端不会因为加入了新的对象而更改源代码，满足“开闭原则”；</p></li></ul><p>其主要缺点是：</p><ul><li><p>设计较复杂，客户端需要花更多时间理清类之间的层次关系；</p></li><li><p>不容易限制容器中的构件；</p></li><li><p>不容易用继承的方法来增加构件的新功能；</p></li></ul><p>组合模式适用于以下应用场景：</p><ul><li><p>在需要表示一个对象整体与部分的层次结构的场合。</p></li><li><p>要求对用户隐藏组合对象与单个对象的不同，用户可以用统一的接口使用组合结构中的所有对象的场合。</p></li></ul><h4 id="5-享元模式"><a href="#5-享元模式" class="headerlink" title="5.享元模式"></a>5.享元模式</h4><p>每个大学都有自己的图书馆，一个城市往往也会建造自己的图书馆来收藏一些书籍。图书馆存在的重要价值就是让更多的人共享到图书，当人们需要查阅某本图书室，只需要到图书馆中阅读这本书就可以了。试想如果每次需要某本书时就去买一本的话，那么这笔投入也是很客观的。所以图书馆的存在提供了一种图书的共享模式。在编程的世界中，当一个系统需要大量的小粒度对象时，使用共享的技术可以很好地控制资源的占用。</p><p><strong>享元模式（Flyweight）模式</strong>的定义：运用共享技术有效地支持大量细粒度的对象的复用。它通过共享已经存在的又橡来大幅度减少需要创建的对象数量、避免大量相似类的开销，从而提高系统资源的利用率。</p><p>享元模式的主要角色有如下：</p><ol><li><strong>抽象享元角色（Flyweight）</strong>:是所有的具体享元类的基类，为具体享元规范需要实现的公共接口，非享元的外部状态以参数的形式通过方法传入。</li><li><strong>具体享元（ConcreteFlyweight）角色</strong>：实现抽象享元角色中所规定的接口。</li><li><strong>非享元（UnsharedConcreteFlyweight)角色</strong>：是不可以共享的外部状态，它以参数的形式注入具体享元的相关方法中。</li><li><strong>享元工厂（FlyweightFactory）角色</strong>：负责创建和管理享元角色。当客户对象请求一个享元对象时，享元工厂检査系统中是否存在符合要求的享元对象，如果存在则提供给客户；如果不存在的话，则创建一个新的享元对象。</li></ol><p>上面提到了内部状态和外部状态，所谓内部状态，就是指享元对象内部的不会随着环境而改变的可以共享的部分；反之，随着环境的改变而做出改变的、无法共享的状态就是外部状态。</p><p>结构图</p><p><img src="/2019/03/02/DesignPattern/FlyweightPattern.png" alt></p><p>示例1</p><p>享元类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 享元类的接口</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Flyweight</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token keyword">int</span> extrinsicState<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>共享的具体享元类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 共享的具体享元对象</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteFlyweight</span> <span class="token keyword">extends</span> <span class="token class-name">Flyweight</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token keyword">int</span> extrinsicState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共享的具体享元对象："</span> <span class="token operator">+</span> extrinsicState<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>不被共享的享元对象</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnsharedFlyweight</span> <span class="token keyword">extends</span> <span class="token class-name">Flyweight</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token keyword">int</span> extrinsicState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"不被共享的享元对象："</span> <span class="token operator">+</span> extrinsicState<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>享元工场类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlyweightFactory</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Flyweight<span class="token operator">></span> flyweights <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">FlyweightFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        flyweights<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteFlyweight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        flyweights<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteFlyweight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        flyweights<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteFlyweight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        flyweights<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteFlyweight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Flyweight <span class="token function">getFlyweight</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> flyweights<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        FlyweightFactory factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlyweightFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> state <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>        Flyweight a <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getFlyweight</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        a<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>        Flyweight b <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getFlyweight</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        b<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span>state <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Flyweight c <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getFlyweight</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        c<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span>state <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Flyweight d <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getFlyweight</span><span class="token punctuation">(</span><span class="token string">"D"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        d<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span>state <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Flyweight x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnsharedFlyweight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        x<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span>state<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Flyweight y <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnsharedFlyweight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        y<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span>state<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>测试结果：共享的具体享元对象：<span class="token number">100</span>共享的具体享元对象：<span class="token number">200</span>共享的具体享元对象：<span class="token number">300</span>共享的具体享元对象：<span class="token number">400</span>不被共享的享元对象：<span class="token number">50</span>不被共享的享元对象：<span class="token number">50</span></code></pre><p>示例2</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> Order <span class="token function">of</span><span class="token punctuation">(</span>String flavourName<span class="token punctuation">,</span> <span class="token keyword">int</span> tableNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>        CoffeeFlavour flavour <span class="token operator">=</span> CoffeeFlavour<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span>flavourName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Serving "</span> <span class="token operator">+</span> flavour <span class="token operator">+</span> <span class="token string">" to table "</span> <span class="token operator">+</span> tableNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoffeeShop</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>Order<span class="token operator">></span> orders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">takeOrder</span><span class="token punctuation">(</span>String flavour<span class="token punctuation">,</span> <span class="token keyword">int</span> tableNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>        orders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Order<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>flavour<span class="token punctuation">,</span> tableNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        orders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>Order<span class="token operator">:</span><span class="token operator">:</span>serve<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoffeeFlavour</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> String name<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> WeakHashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> CoffeeFlavour<span class="token operator">></span> CACHE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// only intern() can call this constructor</span>    <span class="token keyword">private</span> <span class="token function">CoffeeFlavour</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> CoffeeFlavour <span class="token function">intern</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>CACHE<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> CACHE<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> CoffeeFlavour<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">flavoursInCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>CACHE<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> CACHE<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        CoffeeShop shop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoffeeShop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shop<span class="token punctuation">.</span><span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token string">"Cappuccino"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shop<span class="token punctuation">.</span><span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token string">"Frappe"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shop<span class="token punctuation">.</span><span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token string">"Espresso"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shop<span class="token punctuation">.</span><span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token string">"Frappe"</span><span class="token punctuation">,</span> <span class="token number">897</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shop<span class="token punctuation">.</span><span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token string">"Cappuccino"</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shop<span class="token punctuation">.</span><span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token string">"Frappe"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shop<span class="token punctuation">.</span><span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token string">"Espresso"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shop<span class="token punctuation">.</span><span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token string">"Cappuccino"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shop<span class="token punctuation">.</span><span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token string">"Espresso"</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shop<span class="token punctuation">.</span><span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token string">"Frappe"</span><span class="token punctuation">,</span> <span class="token number">552</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shop<span class="token punctuation">.</span><span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token string">"Cappuccino"</span><span class="token punctuation">,</span> <span class="token number">121</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shop<span class="token punctuation">.</span><span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token string">"Espresso"</span><span class="token punctuation">,</span> <span class="token number">121</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shop<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CoffeeFlavor objects in cache: "</span> <span class="token operator">+</span> CoffeeFlavour<span class="token punctuation">.</span><span class="token function">flavoursInCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：Serving Cappuccino to table <span class="token number">2</span>Serving Frappe to table <span class="token number">1</span>Serving Espresso to table <span class="token number">1</span>Serving Frappe to table <span class="token number">897</span>Serving Cappuccino to table <span class="token number">97</span>Serving Frappe to table <span class="token number">3</span>Serving Espresso to table <span class="token number">3</span>Serving Cappuccino to table <span class="token number">3</span>Serving Espresso to table <span class="token number">96</span>Serving Frappe to table <span class="token number">552</span>Serving Cappuccino to table <span class="token number">121</span>Serving Espresso to table <span class="token number">121</span>CoffeeFlavor objects in cache<span class="token operator">:</span> <span class="token number">3</span></code></pre><p>享元模式总结</p><p>享元模式的主要优点是：相同对象只要保存一份，这降低了系统中对象的数量，从而降低了系统中细粒度对象给内存带来的压力。</p><p>其主要缺点是：</p><ul><li><p>为了使对象可以共享，需要将一些不能共享的状态外部化，这将增加程序的复杂性。</p></li><li><p>读取享元模式的外部状态会使得运行时间稍微变长。</p></li></ul><p>以下几种情形适合采用享元模式：</p><ul><li><p>系统中存在大量相同或相似的对象，这些对象耗费大量的内存资源。</p></li><li><p>大部分的对象可以按照内部状态进行分组，且可将不同部分外部化，这样每一个组只需保存一个内部状态。</p></li><li><p>由于享元模式需要额外维护一个保存享元的数据结构，所以应当在有足够多的享元实例时才值得使用享元模式。</p></li></ul><h4 id="6-代理模式"><a href="#6-代理模式" class="headerlink" title="6.代理模式"></a>6.代理模式</h4><p>在有些情况下，一个客户不能或者不想直接访问另一个对象，这时需要找一个中介帮忙完成某项任务，这个中介就是代理对象。例如，购买火车票不一定要去火车站买，可以通过 12306 网站或者去火车票代售点买。又如找女朋友、找保姆、找工作等都可以通过找中介完成。</p><p><strong>代理模式（ProxyPattern）</strong>的定义：为其他对象提供一种代理以控制对这个对象的访问。</p><p>代理模式的主要角色如下：</p><ol><li><strong>抽象主题（Subject）类</strong>：通过接口或抽象类声明真实主题和代理对象实现的业务方法。</li><li><strong>真实主题（Real Subject）类</strong>：实现了抽象主题中的具体业务，是代理对象所代表的真实对象，是最终要引用的对象。</li><li><strong>代理（Proxy）类</strong>：提供了与真实主题相同的接口，其内部含有对真实主题的引用，它可以访问、控制或扩展真实主题的功能。</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/ProxyPattern.png" alt></p><p>示例1</p><p>抽象主题</p><pre class=" language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">Subject</span><span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>真实主题</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">RealSubject</span> <span class="token keyword">implements</span> <span class="token class-name">Subject</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"访问真实主题方法..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>代理</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token keyword">implements</span> <span class="token class-name">Subject</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> RealSubject realSubject<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>realSubject<span class="token operator">==</span>null<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            realSubject<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">RealSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">preRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        realSubject<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">postRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">preRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"访问真实主题之前的预处理。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"访问真实主题之后的后续处理。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        Proxy proxy<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        proxy<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结构：访问真实主题之前的预处理。访问真实主题方法<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>访问真实主题之后的后续处理。</code></pre><p>示例2</p><p>抽象主题角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 演员</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Performer</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 表演     */</span>    <span class="token keyword">void</span> <span class="token function">perform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>真实主题</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 明星</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SuperStar</span> <span class="token keyword">implements</span> <span class="token class-name">Performer</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">perform</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"大明星表演"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>代理角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 经济人</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Agent</span> <span class="token keyword">implements</span> <span class="token class-name">Performer</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> SuperStar star<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Agent</span><span class="token punctuation">(</span>SuperStar star<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>star <span class="token operator">=</span> star<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">perform</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"经济人接收到演出邀请"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"经济人向明星确认是否接受邀请"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        star<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        SuperStar star <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuperStar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Agent agent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Agent</span><span class="token punctuation">(</span>star<span class="token punctuation">)</span><span class="token punctuation">;</span>        agent<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：经济人接收到演出邀请经济人向明星确认是否接受邀请大明星表演</code></pre><p>代理模式一般是在不改变原有服务实现代码的基础上添加一些额外操作的一种快速解决方案。代理在Java中分为<strong>静态代理</strong>和<strong>动态代理</strong>。</p><p><strong>静态代理</strong>就是使用“代理模式”来实现的解决方法。生成一个和类相同接口的代理类，用户通过使用代理类来封装某个实现类。其目的是加强实现类的某个方法的功能，而不必改变原有的源代码。</p><p>一般而言，<strong>动态代理</strong>分为两种，一种是JDK反射机制提供的代理，另一种是CGLIB代理。在JDK提供的代理，被代理对象必须是接口，而CGLIB的被代理对象不需要是接口。</p><p><strong>JDK动态代理</strong>和普通的代理模式的区别在于动态代理中的代理类是由java.lang.reflect.Proxy类在运行时根据接口定义，采用Java反射功能动态生成的，和java.lang.reflect.InvocationHandler结合，可以加强现有类的方法实现。自定义Handler需要实现invoke方法，该方法可以使用Java反射调用实现类的实现方法，同时也可以实现其他功能，例如在调用实现类方法前后加入Log等业务。Proxy类根据Handler和需要代理的接口动态生成一个接口实现类的对象。当用户调用这个动态生成的实现类时，实际上是调用了自定义Handler的invoke方法。</p><p>JDK动态代理的实现步骤：</p><ul><li><p>编写服务类和接口，这个是真正的服务提供者，在JDK动态代理中接口是必须的；</p></li><li><p>编写代理类，提供绑定和代理方法；</p></li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 服务接口</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IMath</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">,</span> <span class="token keyword">int</span> n2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">,</span> <span class="token keyword">int</span> n2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> <span class="token function">mut</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">,</span> <span class="token keyword">int</span> n2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> <span class="token function">div</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">,</span> <span class="token keyword">int</span> n2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 实现类</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Math</span> <span class="token keyword">implements</span> <span class="token class-name">IMath</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">,</span> <span class="token keyword">int</span> n2<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>n1 <span class="token operator">+</span> <span class="token string">" + "</span> <span class="token operator">+</span> n2 <span class="token operator">+</span> <span class="token string">" = "</span>  <span class="token operator">+</span> <span class="token punctuation">(</span>n1 <span class="token operator">+</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> n1 <span class="token operator">+</span> n2<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">,</span> <span class="token keyword">int</span> n2<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>n1 <span class="token operator">+</span> <span class="token string">" - "</span> <span class="token operator">+</span> n2 <span class="token operator">+</span> <span class="token string">" = "</span>  <span class="token operator">+</span> <span class="token punctuation">(</span>n1 <span class="token operator">-</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> n1 <span class="token operator">-</span> n2<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">mut</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">,</span> <span class="token keyword">int</span> n2<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>n1 <span class="token operator">+</span> <span class="token string">" * "</span> <span class="token operator">+</span> n2 <span class="token operator">+</span> <span class="token string">" = "</span>  <span class="token operator">+</span> <span class="token punctuation">(</span>n1 <span class="token operator">*</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> n1 <span class="token operator">*</span> n2<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">div</span><span class="token punctuation">(</span><span class="token keyword">int</span> n1<span class="token punctuation">,</span> <span class="token keyword">int</span> n2<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>n1 <span class="token operator">+</span> <span class="token string">" / "</span> <span class="token operator">+</span> n2 <span class="token operator">+</span> <span class="token string">" = "</span>  <span class="token operator">+</span> <span class="token punctuation">(</span>n1 <span class="token operator">/</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> n1 <span class="token operator">/</span> n2<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 代理类</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicProxy</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 真实服务对象</span>    <span class="token keyword">private</span> Object targetObj<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 绑定委托对象并返回一个代理类</span>    <span class="token keyword">public</span> Object <span class="token function">getProxyObject</span><span class="token punctuation">(</span>Object target<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>targetObj <span class="token operator">=</span> target<span class="token punctuation">;</span>        Class <span class="token class-name">clazz</span> <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Object proxy <span class="token operator">=</span> Proxy<span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>clazz<span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 通过代理对象调用方法时首先进入这个方法     * @param proxy 代理对象     * @param method 被调用方法     * @param args 方法参数     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 反射方法前调用</span>        <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 执行方法，相当与调用Math类中的add/sub/mut/div方法</span>        Object result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>targetObj<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 反射方法后调用</span>        <span class="token keyword">long</span> end <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共用时："</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        IMath math <span class="token operator">=</span> <span class="token punctuation">(</span>IMath<span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">DynamicProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProxyObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Math</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        math<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        math<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        math<span class="token punctuation">.</span><span class="token function">mut</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        math<span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：<span class="token number">100</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">102</span>共用时：<span class="token number">472</span><span class="token number">100</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">98</span>共用时：<span class="token number">181</span><span class="token number">100</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">200</span>共用时：<span class="token number">180</span><span class="token number">100</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">50</span>共用时：<span class="token number">366</span></code></pre><p><strong>CGLIB动态代理</strong>：JDK提供的动态代理存在一个缺陷，就是你必须提供接口才可以使用，为了克服这个缺陷，可以使用开源框架-CGLIB，它是一种流行的动态代理。</p><p>如何使用CGLIB动态代理，很简单，在我们创建代理类时实现net.sf.cglib.proxy.MethodInterceptor接口就行了, IMath接口和Math类都不需要改变。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// GLIB,动态代理类,实现一个方法拦截器接口</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicProxy</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//被代理对象</span>    <span class="token keyword">private</span> Object targetObj<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//动态生成一个新类</span>    <span class="token keyword">public</span> Object <span class="token function">getProxyObject</span><span class="token punctuation">(</span>Object object<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>targetObj <span class="token operator">=</span> object<span class="token punctuation">;</span>        Enhancer enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetObj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Object <span class="token function">intercept</span><span class="token punctuation">(</span>Object object<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> MethodProxy methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>        <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//Object result = methodProxy.invokeSuper(object, args);</span>        Object result <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetObj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//和上一行代码等价</span>        <span class="token keyword">long</span> end <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共用时："</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 测试</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Math math <span class="token operator">=</span> <span class="token punctuation">(</span>Math<span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">DynamicProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProxyObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Math</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        math<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        math<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        math<span class="token punctuation">.</span><span class="token function">mut</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        math<span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>代理模式总结</p><p>代理模式的主要优点有：</p><ul><li>代理模式在客户端与目标对象之间起到一个中介作用和保护目标对象的作用；</li><li>代理对象可以扩展目标对象的功能；</li><li>代理模式能将客户端与目标对象分离，在一定程度上降低了系统的耦合度；</li></ul><p>其主要缺点是：</p><ul><li>在客户端和目标对象之间增加一个代理对象，会造成请求处理速度变慢；</li><li>增加了系统的复杂度；</li></ul><p>代理模式一般适用于以下几种情况：</p><ul><li><p>当需要为一个对象在不同的地址空间提供局部的代表时；</p></li><li><p>当需要创建开销非常大的对象时；</p></li><li><p>当需要控制对原始对象的访问时；</p></li><li><p>当需要在访问对象时执行一些附加操作时，比如可通过代理对象计算访问实际对象的次数。</p></li></ul><h4 id="7-外观模式"><a href="#7-外观模式" class="headerlink" title="7.外观模式"></a>7.外观模式</h4><p>在现实的项目中，总会有一些遗留的难易维护的大型项目存在，但是这些存在的系统却能在某些场合发挥重要作用，所以在后续的开发人员不希望这种系统被废弃掉，一些新的开发需求就会依赖于这些难以维护的系统，在这种情况下，使用本外观模式将会极好地解决各种各样的可能会发生的问题。</p><p><strong>外观（Facade）模式的定义</strong>：为子系统中的一组接口提供一个一致的界面，此模式定义了一个高层接口，这个接口使得这一个子系统更加容易使用。该模式对外有一个统一接口，外部应用程序不用关心内部子系统的具体的细节，这样会大大降低应用程序的复杂度，提高了程序的可维护性。</p><p>外观（Facade）模式包含以下主要角色：</p><ol><li><strong>外观（Facade）角色</strong>：为多个子系统对外提供一个共同的接口；</li><li><strong>子系统（SubSystem）角色</strong>：实现系统的部分功能，客户可以通过外观角色访问它；</li><li><strong>客户（Client）角色</strong>：通过一个外观角色访问各个子系统的功能；</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/FacadePattern.png" alt></p><p>示例1</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FacadeDemo</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Client角色</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ServiceFacade serviceFacade <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceFacade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        serviceFacade<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// SubSystem角色</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServiceA</span><span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"save"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// SubSystem角色</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServiceB</span><span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"delete"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Facade角色</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServiceFacade</span><span class="token punctuation">{</span>        <span class="token keyword">private</span> ServiceA serviceA<span class="token punctuation">;</span>        <span class="token keyword">private</span> ServiceB serviceB<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token function">ServiceFacade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            serviceA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            serviceB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            serviceB<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            serviceA<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：deletesave</code></pre><p>示例2</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FacadeDemo2</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Client角色</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Facade facade <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Facade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        facade<span class="token punctuation">.</span><span class="token function">operation1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        facade<span class="token punctuation">.</span><span class="token function">operation2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// SubSystem角色</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SubSystemA</span><span class="token punctuation">{</span>        <span class="token keyword">public</span> String <span class="token function">operationA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"Subsystem A, Method A1\n"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> String <span class="token function">operationA2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"Subsystem A, Method A2\n"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// SubSystem角色</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SubSystemB</span><span class="token punctuation">{</span>        <span class="token keyword">public</span> String <span class="token function">operationB1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"Subsystem B, Method B1\n"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> String <span class="token function">operationB2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"Subsystem B, Method B2\n"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// SubSystem角色</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SubSystemC</span><span class="token punctuation">{</span>        <span class="token keyword">public</span> String <span class="token function">operationC1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"Subsystem C, Method C1\n"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> String <span class="token function">operationC2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"Subsystem C, Method C2\n"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Facade角色</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Facade</span><span class="token punctuation">{</span>        <span class="token keyword">private</span> SubSystemA a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubSystemA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> SubSystemB b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubSystemB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> SubSystemC c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubSystemC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"operation 1\n"</span> <span class="token operator">+</span>                    a<span class="token punctuation">.</span><span class="token function">operationA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>                    b<span class="token punctuation">.</span><span class="token function">operationB1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>                    c<span class="token punctuation">.</span><span class="token function">operationC1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"operation 2\n"</span> <span class="token operator">+</span>                    a<span class="token punctuation">.</span><span class="token function">operationA2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>                    b<span class="token punctuation">.</span><span class="token function">operationB2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>                    c<span class="token punctuation">.</span><span class="token function">operationC2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：operation <span class="token number">1</span>Subsystem A<span class="token punctuation">,</span> Method A1Subsystem B<span class="token punctuation">,</span> Method B1Subsystem C<span class="token punctuation">,</span> Method C1operation <span class="token number">2</span>Subsystem A<span class="token punctuation">,</span> Method A2Subsystem B<span class="token punctuation">,</span> Method B2Subsystem C<span class="token punctuation">,</span> Method C2</code></pre><p>示例3</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FacadeDemo3</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Client角色</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ComputerFacade computer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComputerFacade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        computer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// SubSystem角色</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CPU</span><span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CPU: freeze"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jump</span><span class="token punctuation">(</span><span class="token keyword">long</span> position<span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CPU: jump location "</span><span class="token operator">+</span> position<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CPU: execute"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// SubSystem角色</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HardDirve</span><span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">long</span> lba<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// SubSystem角色</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Memory</span><span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">long</span> position<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Facade角色</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ComputerFacade</span><span class="token punctuation">{</span>        <span class="token keyword">private</span> CPU processor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> Memory ram <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> HardDirve hd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HardDirve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> BOOT_ADDRESS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> BOOT_SECTOR <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> SECTOR_SIZE <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            processor<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ram<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>BOOT_ADDRESS<span class="token punctuation">,</span>hd<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>BOOT_SECTOR<span class="token punctuation">,</span>SECTOR_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            processor<span class="token punctuation">.</span><span class="token function">jump</span><span class="token punctuation">(</span>BOOT_ADDRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>            processor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：CPU<span class="token operator">:</span> freezeCPU<span class="token operator">:</span> jump location <span class="token number">1</span>CPU<span class="token operator">:</span> execute</code></pre><p>外观模式总结：</p><p>外观（Facade）模式是“迪米特法则”的典型应用，它有以下主要优点：</p><ul><li><p>降低了子系统与客户端之间的耦合度，使得子系统的变化不会影响调用它的客户类。</p></li><li><p>对客户屏蔽了子系统组件，减少了客户处理的对象数目，并使得子系统使用起来更加容易。</p></li><li><p>降低了大型软件系统中的编译依赖性，简化了系统在不同平台之间的移植过程，因为编译一个子系统不会影响其他的子系统，也不会影响外观对象。</p></li></ul><p>外观（Facade）模式的主要缺点如下：</p><ul><li><p>不能很好地限制客户使用子系统类。</p></li><li><p>增加新的子系统可能需要修改外观类或客户端的源代码，违背了“开闭原则”。</p></li></ul><h3 id="三、行为模式"><a href="#三、行为模式" class="headerlink" title="三、行为模式"></a>三、行为模式</h3><h4 id="1-模板方法模式"><a href="#1-模板方法模式" class="headerlink" title="1.模板方法模式"></a>1.模板方法模式</h4><p>在面向对象程序设计过程中，程序员常常会遇到这种情况：设计一个系统时知道了算法所需的关键步骤，而且确定了这些步骤的执行顺序，但某些步骤的具体实现还未知，或者说某些步骤的实现与具体的环境相关。</p><p>例如，去银行办理业务一般要经过以下4个流程：取号、排队、办理具体业务、对银行工作人员进行评分等，其中取号、排队和对银行工作人员进行评分的业务对每个客户是一样的，可以在父类中实现，但是办理具体业务却因人而异，它可能是存款、取款或者转账等，可以延迟到子类中实现。</p><p>这样的例子在生活中还有很多，例如，一个人每天会起床、吃饭、做事、睡觉等，其中“做事”的内容每天可能不同。我们把这些规定了流程或格式的实例定义成模板，允许使用者根据自己的需求去更新它，例如，简历模板、论文模板、Word 中模板文件等。</p><p><strong>模板方法（TemplateMethod）模式</strong>定义：定义一个操作中的算法的骨架，而将一些步骤延迟到子类中。它使得子类可以不改变一个算法的结构即可重新定义该算法的某些特定步骤。</p><p>模板方法模式包含以下主要角色：</p><p><strong>(1) 抽象类（AbstractClass）</strong>：负责给出一个算法的轮廓和骨架。它由一个模板方法和若干个基本方法构成。这些方法的定义如下：</p><ul><li><p>模板方法：定义了算法的骨架，按某种顺序调用其包含的基本方法。</p></li><li><p>基本方法：是整个算法中的一个步骤，包含以下几种类型：</p><ul><li>抽象方法：在抽象类中申明，由具体子类实现。</li><li>具体方法：在抽象类中已经实现，在具体子类中可以继承或重写它。</li><li>钩子方法：在抽象类中已经实现，包括用于判断的逻辑方法和需要子类重写的空方法两种。</li></ul></li></ul><p><strong>(2) 具体子类（ConcreteClass）</strong>：实现抽象类中所定义的抽象方法和钩子方法，它们是一个顶级逻辑的一个组成步骤。</p><p>结构图</p><p><img src="/2019/03/02/DesignPattern/TemplateMethodPattern.png" alt></p><p>示例1</p><p>抽象类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//抽象类</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractClass</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">TemplateMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//模板方法</span>    <span class="token punctuation">{</span>        <span class="token function">SpecificMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">abstractMethod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token function">abstractMethod2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">SpecificMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//具体方法</span>    <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"抽象类中的具体方法被调用..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>       <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">abstractMethod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//抽象方法1</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">abstractMethod2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//抽象方法2</span><span class="token punctuation">}</span></code></pre><p>具体子类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//具体子类</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteClass</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractClass</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">abstractMethod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"抽象方法1的实现被调用..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">abstractMethod2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"抽象方法2的实现被调用..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        AbstractClass tm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tm<span class="token punctuation">.</span><span class="token function">TemplateMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：抽象类中的具体方法被调用<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>抽象方法<span class="token number">1</span>的实现被调用<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>抽象方法<span class="token number">2</span>的实现被调用<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><p>示例2</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 抽象类：手机 */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MobilePhone</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 不同的手机厂商安装不同的操作系统     * @return 操作系统名称     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> String <span class="token function">installOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 安装电池     * @return 电池容量     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">int</span> <span class="token function">installBattary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">powerOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"开机..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"成功开机"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">calling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"手机开始通话"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">lowPowerChecking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"手机电量过低！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">powerOff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"手机开机"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 模版方法     */</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        String osName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">installOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"手机安装了"</span> <span class="token operator">+</span> osName <span class="token operator">+</span> <span class="token string">"操作系统"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> capacity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">installBattary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"手机安装了"</span> <span class="token operator">+</span> capacity <span class="token operator">+</span> <span class="token string">"毫安电池"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">powerOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lowPowerChecking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">powerOff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体类：华为荣耀手机 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HuaWeiHonor</span> <span class="token keyword">extends</span> <span class="token class-name">MobilePhone</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">HuaWeiHonor</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"手机名称 ["</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">installOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"Android系统"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">installBattary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token number">4000</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体类：iphone x 手机 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IPhoneX</span> <span class="token keyword">extends</span> <span class="token class-name">MobilePhone</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">IPhoneX</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"手机名称 ["</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">installOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"IOS系统"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">installBattary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token number">2000</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 客户端 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"富士康工厂开始生产手机了："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        MobilePhone phone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IPhoneX</span><span class="token punctuation">(</span><span class="token string">"IPhoneX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        phone<span class="token punctuation">.</span><span class="token function">installOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        phone<span class="token punctuation">.</span><span class="token function">installBattary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        phone<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"---------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        phone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HuaWeiHonor</span><span class="token punctuation">(</span><span class="token string">"Honor10"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        phone<span class="token punctuation">.</span><span class="token function">installOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        phone<span class="token punctuation">.</span><span class="token function">installBattary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        phone<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：富士康工厂开始生产手机了：手机名称 <span class="token punctuation">[</span>IPhoneX<span class="token punctuation">]</span>手机安装了IOS系统操作系统手机安装了<span class="token number">2000</span>毫安电池开机<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>成功开机手机开始通话手机电量过低！手机开机<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>手机名称 <span class="token punctuation">[</span>Honor10<span class="token punctuation">]</span>手机安装了Android系统操作系统手机安装了<span class="token number">4000</span>毫安电池开机<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>成功开机手机开始通话手机电量过低！手机开机</code></pre><p>模板方法模式总结</p><p>很多开发人员都发现其实自己在以前的编码中就已经使用过模板方法模式了。确实模板方法模式比较简单并且很常用，甚至在Java的类库中都有使用模板方法模式来提取公共行为至抽象类中。</p><p>该模式的主要优点如下：</p><ul><li><p>它封装了不变部分，扩展可变部分。它把认为是不变部分的算法封装到父类中实现，而把可变部分算法由子类继承实现，便于子类继续扩展。</p></li><li><p>它在父类中提取了公共的部分代码，便于代码复用。</p></li><li><p>部分方法是由子类实现的，因此子类可以通过扩展方式增加相应的功能，符合开闭原则。</p></li></ul><p>该模式的主要缺点如下：</p><ul><li><p>对每个不同的实现都需要定义一个子类，这会导致类的个数增加，系统更加庞大，设计也更加抽象。</p></li><li><p>父类中的抽象方法由子类实现，子类执行的结果会影响父类的结果，这导致一种反向的控制结构，它提高了代码阅读的难度。</p></li></ul><p>一般来说，下面几种情况可以考虑使用模板方法模式：</p><ul><li>一次性地实现一个算法不变的部分，而将可变的行为留给子类来实现；</li><li>当子类中有公共的行为可以提取到公共的父类中去，并且子类有自己的“个性化要求”时；</li><li>子类需要扩展的地方都是固定的，即仅允许在这些点进行扩展时；</li></ul><h4 id="2-策略模式"><a href="#2-策略模式" class="headerlink" title="2.策略模式"></a>2.策略模式</h4><p>在现实生活中常常遇到实现某种目标存在多种策略可供选择的情况，例如，出行旅游可以乘坐飞机、乘坐火车、骑自行车或自己开私家车等，超市促销可以釆用打折、送商品、送积分等方法。</p><p>在软件开发中也常常遇到类似的情况，当实现某一个功能存在多种算法或者策略，我们可以根据环境或者条件的不同选择不同的算法或者策略来完成该功能，如数据排序策略有冒泡排序、选择排序、插入排序、二叉树排序等。</p><p>如果使用多重条件转移语句实现（即硬编码），不但使条件语句变得很复杂，而且增加、删除或更换算法要修改原代码，不易维护，违背开闭原则。如果采用策略模式就能很好解决该问题。</p><p><strong>策略（Strategy）模式</strong>的定义：策略模式定义了算法家族，分别封装起来，让它们之间可以相互替换，此模式让算法的变化不会影响到使用算法的客户。</p><p>策略模式的主要角色如下：</p><ol><li><strong>抽象策略（Strategy）类</strong>：定义了一个公共接口，各种不同的算法以不同的方式实现这个接口，环境角色使用这个接口调用不同的算法，一般使用接口或抽象类实现；</li><li><strong>具体策略（ConcreteStrategy）类</strong>：实现了抽象策略定义的接口，提供具体的算法实现；</li><li><strong>环境（Context）类</strong>：持有一个策略类的引用，最终给客户端调用；</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/StrategyPattern.png" alt></p><p>示例</p><p>抽象策略类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> integerface Strategy <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">strategyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体策略类A</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//具体策略类A</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteStrategyA</span> <span class="token keyword">implements</span> <span class="token class-name">Strategy</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">strategyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"具体策略A的策略方法被访问！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体策略类B</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//具体策略类B</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteStrategyB</span> <span class="token keyword">implements</span> <span class="token class-name">Strategy</span><span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">strategyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"具体策略B的策略方法被访问！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>环境类（上下文）</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//环境类</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Context</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> Strategy strategy<span class="token punctuation">;</span>    <span class="token keyword">public</span> Strategy <span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> strategy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setStrategy</span><span class="token punctuation">(</span>Strategy strategy<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>strategy<span class="token operator">=</span>strategy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">strategyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        strategy<span class="token punctuation">.</span><span class="token function">strategyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        Context c<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Strategy s<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConcreteStrategyA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        c<span class="token punctuation">.</span><span class="token function">setStrategy</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        c<span class="token punctuation">.</span><span class="token function">strategyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        s<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConcreteStrategyB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        c<span class="token punctuation">.</span><span class="token function">setStrategy</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        c<span class="token punctuation">.</span><span class="token function">strategyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：具体策略A的策略方法被访问！<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>具体策略B的策略方法被访问！</code></pre><p>示例2</p><p>抽象策略类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//计算策略类</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CalculatorStrategy</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 计算接口     * @param a     * @param b     * @return     */</span>    <span class="token keyword">int</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体策略类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//加法</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AddCalculator</span> <span class="token keyword">implements</span> <span class="token class-name">CalculatorStrategy</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//减法</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubstractCalculator</span> <span class="token keyword">implements</span> <span class="token class-name">CalculatorStrategy</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> a <span class="token operator">-</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//乘法</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MultiplyCalculator</span> <span class="token keyword">implements</span> <span class="token class-name">CalculatorStrategy</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//除法</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DivideCalculator</span> <span class="token keyword">implements</span> <span class="token class-name">CalculatorStrategy</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> a <span class="token operator">/</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>环境（上下文）</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> CalculatorStrategy strategy<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//构造方法</span>    <span class="token keyword">public</span> <span class="token function">Context</span><span class="token punctuation">(</span>CalculatorStrategy strategy<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>strategy <span class="token operator">=</span> strategy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//上下文操作</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>strategy<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> CalculatorStrategy <span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> strategy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setStrategy</span><span class="token punctuation">(</span>CalculatorStrategy strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>strategy <span class="token operator">=</span> strategy<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>        Context context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span>CaculatorType<span class="token punctuation">.</span>ADD<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> r <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"a + b = "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">setStrategy</span><span class="token punctuation">(</span>CaculatorType<span class="token punctuation">.</span>SUBSTRACT<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        r <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"a - b = "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">setStrategy</span><span class="token punctuation">(</span>CaculatorType<span class="token punctuation">.</span>MULTIPLY<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        r <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"a * b = "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">setStrategy</span><span class="token punctuation">(</span>CaculatorType<span class="token punctuation">.</span>DIVIDE<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        r <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"a / b = "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：a <span class="token operator">+</span> b <span class="token operator">=</span> <span class="token number">15</span>a <span class="token operator">-</span> b <span class="token operator">=</span> <span class="token number">5</span>a <span class="token operator">*</span> b <span class="token operator">=</span> <span class="token number">50</span>a <span class="token operator">/</span> b <span class="token operator">=</span> <span class="token number">2</span></code></pre><p>策略模式总结</p><p>策略模式的主要优点如下：</p><ul><li><p>多重条件语句不易维护，而使用策略模式可以避免使用多重条件语句；</p></li><li><p>策略模式提供了一系列的可供重用的算法族，恰当使用继承可以把算法族的公共代码转移到父类里面，从而避免重复的代码；</p></li><li><p>策略模式可以提供相同行为的不同实现，客户可以根据不同时间或空间要求选择不同的；</p></li><li><p>策略模式提供了对开闭原则的完美支持，可以在不修改原代码的情况下，灵活增加新算法；</p></li><li><p>策略模式把算法的使用放到环境类中，而算法的实现移到具体策略类中，实现了二者的分离；</p></li></ul><p>其主要缺点如下：</p><ul><li><p>客户端必须理解所有策略算法的区别，以便适时选择恰当的算法类；</p></li><li><p>策略模式造成很多的策略类；</p></li></ul><p>策略模式适用于以下几种情况：</p><ul><li>很多相关的类只是在行为上有差异；</li><li>当需要使用一个算法的不同变体时；</li><li>使用算法的客户不应该知道算法的具体结构时；</li><li>当一个类定义了多种行为并且这些行为在这个类的操作中以多个条件语句的形式出现时；</li></ul><h4 id="3-状态模式"><a href="#3-状态模式" class="headerlink" title="3.状态模式"></a>3.状态模式</h4><p>在软件开发过程中，应用程序中的有些对象可能会根据不同的情况做出不同的行为，我们把这种对象称为<strong>有状态的对象</strong>，而把影响对象行为的一个或多个动态变化的属性称为<strong>状态</strong>。当有状态的对象与外部事件产生互动时，其内部状态会发生改变，从而使得其行为也随之发生改变。如人的情绪有高兴的时候和伤心的时候，不同的情绪有不同的行为，当然外界也会影响其情绪变化。</p><p>对这种有状态的对象编程，传统的解决方案是：将这些所有可能发生的情况全都考虑到，然后使用 if-else 语句来做状态判断，再进行不同情况的处理。但当对象的状态很多时，程序会变得很复杂。而且增加新的状态要添加新的 if-else 语句，这违背了“开闭原则”，不利于程序的扩展。</p><p>以上问题如果采用“状态模式”就能很好地得到解决。状态模式的解决思想是：当控制一个对象状态转换的条件表达式过于复杂时，把相关“判断逻辑”提取出来，放到一系列的状态类当中，这样可以把原来复杂的逻辑判断简单化。</p><p><strong>状态（State）模式</strong>的定义：当一个对象的内在状态改变时允许改变其行为，这个对象看起来像是改变了其类。</p><p>状态模式包含以下主要角色：</p><ol><li><strong>环境（Context）角色</strong>：也称为上下文，它定义了客户感兴趣的接口，维护一个当前状态，并将与状态相关的操作委托给当前状态对象来处理；</li><li><strong>抽象状态（State）角色</strong>：定义一个接口，用以封装环境对象中的特定状态所对应的行为；</li><li><strong>具体状态（ConcreteState）角色</strong>：实现抽象状态所对应的行为；</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/StatePattern.png" alt></p><p>示例</p><p>抽象状态类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 抽象状态类 */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> String stateName<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">Handle</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>环境类（上下文）</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 环境类（上下文） */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> State state<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Context</span><span class="token punctuation">(</span>State state<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> State <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> state<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span>State state<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前状态为："</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>stateName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"状态变更为："</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>stateName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体状态类A</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteStateA</span> <span class="token keyword">extends</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">ConcreteStateA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        stateName <span class="token operator">=</span> <span class="token string">"状态 A"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Handle</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        context<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcreteStateB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体状态类B</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteStateB</span> <span class="token keyword">extends</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">ConcreteStateB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        stateName <span class="token operator">=</span> <span class="token string">"状态 B"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Handle</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        context<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcreteStateA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Context context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcreteStateA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：当前状态为：状态 A状态变更为：状态 B<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>当前状态为：状态 B状态变更为：状态 A<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>当前状态为：状态 A状态变更为：状态 B</code></pre><p>示例2</p><p>抽象状态</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 抽象状态类：火车状态 */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">TrainState</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span>Train train<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>环境（上下文）</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 上下文：火车 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Train</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 火车行驶</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        state<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> TrainState state<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 车速度</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> speed<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 是否让行</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> giveWay <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Train</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StartState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> TrainState <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> state<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span>TrainState state<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> speed<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSpeed</span><span class="token punctuation">(</span><span class="token keyword">int</span> speed<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>speed <span class="token operator">=</span> speed<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isGiveWay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> giveWay<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setGiveWay</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> giveWay<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>giveWay <span class="token operator">=</span> giveWay<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体状态</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体状态类：火车加速状态 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FastState</span> <span class="token keyword">extends</span> <span class="token class-name">TrainState</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span>Train train<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>train<span class="token punctuation">.</span><span class="token function">getSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前时速为："</span> <span class="token operator">+</span> train<span class="token punctuation">.</span><span class="token function">getSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"列车正在加速"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            train<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SlowState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            train<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体状态：火车减速状态 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SlowState</span> <span class="token keyword">extends</span> <span class="token class-name">TrainState</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span>Train train<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>train<span class="token punctuation">.</span><span class="token function">getSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前时速为："</span> <span class="token operator">+</span> train<span class="token punctuation">.</span><span class="token function">getSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"列车正在减速"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            train<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RunState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            train<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体状态：火车匀速行驶状态 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunState</span> <span class="token keyword">extends</span> <span class="token class-name">TrainState</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span>Train train<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>train<span class="token punctuation">.</span><span class="token function">isGiveWay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            train<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StopState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            train<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前时速为："</span> <span class="token operator">+</span> train<span class="token punctuation">.</span><span class="token function">getSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"列车正在匀速行驶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体状态：火车停止让行状态 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StopState</span> <span class="token keyword">extends</span> <span class="token class-name">TrainState</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span>Train train<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前时速为："</span> <span class="token operator">+</span> train<span class="token punctuation">.</span><span class="token function">getSpeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"列车准备停止让行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Train train <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Train</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        train<span class="token punctuation">.</span><span class="token function">setSpeed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        train<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        train<span class="token punctuation">.</span><span class="token function">setSpeed</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        train<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        train<span class="token punctuation">.</span><span class="token function">setSpeed</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        train<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        train<span class="token punctuation">.</span><span class="token function">setSpeed</span><span class="token punctuation">(</span><span class="token number">210</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        train<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        train<span class="token punctuation">.</span><span class="token function">setSpeed</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        train<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        train<span class="token punctuation">.</span><span class="token function">setGiveWay</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        train<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：当前时速为：<span class="token number">0</span>列车开始启动当前时速为：<span class="token number">100</span>列车正在加速当前时速为：<span class="token number">150</span>列车正在加速当前时速为：<span class="token number">210</span>列车正在减速当前时速为：<span class="token number">200</span>列车正在匀速行驶当前时速为：<span class="token number">200</span>列车准备停止让行</code></pre><p>状态模式总结</p><p>状态模式主要优点如下：</p><ul><li><p>状态模式将与特定状态相关的行为局部化到一个状态中，并且将不同状态的行为分割开来，满足“单一职责原则”；</p></li><li><p>减少对象间的相互依赖。将不同的状态引入独立的对象中会使得状态转换变得更加明确，且减少对象间的相互依赖；</p></li><li><p>有利于程序的扩展。通过定义新的子类很容易地增加新的状态和转换；</p></li></ul><p>状态模式的主要缺点如下：</p><ul><li><p>状态模式的使用必然会增加系统的类与对象的个数；</p></li><li><p>状态模式的结构与实现都较为复杂，如果使用不当会导致程序结构和代码的混乱；</p></li></ul><p>通常在以下情况下可以考虑使用状态模式：</p><ul><li>当一个对象的行为取决于它的状态，并且它必须在运行时根据状态改变它的行为时，就可以考虑使用状态模式。</li><li>一个操作中含有庞大的分支结构，并且这些分支决定于对象的状态时。</li></ul><h4 id="4-观察者模式"><a href="#4-观察者模式" class="headerlink" title="4.观察者模式"></a>4.观察者模式</h4><p>在现实世界中，许多对象并不是独立存在的，其中一个对象的行为发生改变可能会导致一个或者多个其他对象的行为也发生改变。例如，某种商品的物价上涨时会导致部分商家高兴，而消费者伤心；还有，当我们开车到交叉路口时，遇到红灯会停，遇到绿灯会行。这样的例子还有很多，例如，股票价格与股民、微信公众号与微信用户、气象局的天气预报与听众、小偷与警察等。</p><p>在软件世界也是这样，例如，Excel 中的数据与折线图、饼状图、柱状图之间的关系；MVC 模式中的模型与视图的关系；事件模型中的事件源与事件处理者。所有这些，如果用观察者模式来实现就非常方便。</p><p><strong>观察者（Observer）模式</strong>定义：观察者模式定义了一种一对多的依赖关系，让多个观察者对象同时监听某一个主题对象。这个主题对象在状态发生改变时，会通知所有观察者对象，使它们能够自动更新自己。这种模式有时又称作发布-订阅模式、模型-视图模式，它是对象行为型模式。</p><p>观察者模式的主要角色如下：</p><ol><li><strong>抽象主题（Subject）角色</strong>：也叫抽象目标类，它提供了一个用于保存观察者对象的聚集类和增加、删除观察者对象的方法，以及通知所有观察者的抽象方法。</li><li><strong>具体主题（ConcreteSubject）角色</strong>：也叫具体目标类，它实现抽象目标中的通知方法，当具体主题的内部状态发生改变时，通知所有注册过的观察者对象。</li><li><strong>抽象观察者（Observer）角色</strong>：它是一个抽象类或接口，它包含了一个更新自己的抽象方法，当接到具体主题的更改通知时被调用。</li><li><strong>具体观察者（ConcreteObserver）角色</strong>：实现抽象观察者中定义的抽象方法，以便在得到目标的更改通知时更新自身的状态。</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/ObserverPattern.png" alt></p><p>示例</p><p>抽象观察者类</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体观察者</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteObserver</span> <span class="token keyword">implements</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String observerName<span class="token punctuation">;</span>    <span class="token keyword">private</span> String state<span class="token punctuation">;</span>    <span class="token keyword">private</span> ConcreteSubject concreteSubject<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ConcreteObserver</span><span class="token punctuation">(</span> String observerName<span class="token punctuation">,</span> ConcreteSubject concreteSubject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>concreteSubject <span class="token operator">=</span> concreteSubject<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>observerName <span class="token operator">=</span> observerName<span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token keyword">public</span> ConcreteSubject <span class="token function">getConcreteSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> concreteSubject<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setConcreteSubject</span><span class="token punctuation">(</span>ConcreteSubject concreteSubject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>concreteSubject <span class="token operator">=</span> concreteSubject<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        state <span class="token operator">=</span> concreteSubject<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String subName <span class="token operator">=</span> concreteSubject<span class="token punctuation">.</span><span class="token function">getSubjectName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"["</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>observerName <span class="token operator">+</span> <span class="token string">"]观察到["</span> <span class="token operator">+</span> subName <span class="token operator">+</span> <span class="token string">"]状态是："</span> <span class="token operator">+</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>抽象主题</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Subject</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 记录观察者列表</span>    <span class="token keyword">protected</span> ArrayList<span class="token operator">&lt;</span>Observer<span class="token operator">></span> observers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Observer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>Observer observer<span class="token punctuation">)</span><span class="token punctuation">{</span>        observers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>Observer observer<span class="token punctuation">)</span><span class="token punctuation">{</span>        observers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 通知</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">notifyObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体主题</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteSubject</span> <span class="token keyword">extends</span> <span class="token class-name">Subject</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> String subjectName<span class="token punctuation">;</span>    <span class="token keyword">private</span> String state<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ConcreteSubject</span><span class="token punctuation">(</span>String subjectName<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>subjectName <span class="token operator">=</span> subjectName<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getSubjectName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> subjectName<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSubjectName</span><span class="token punctuation">(</span>String subjectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>subjectName <span class="token operator">=</span> subjectName<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> state<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span>String state<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> observers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            observers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ConcreteSubject shenzhouX <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteSubject</span><span class="token punctuation">(</span><span class="token string">"神舟10号飞船"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shenzhouX<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcreteObserver</span><span class="token punctuation">(</span><span class="token string">"远望1号观测船"</span><span class="token punctuation">,</span>shenzhouX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shenzhouX<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcreteObserver</span><span class="token punctuation">(</span><span class="token string">"远望2号观测船"</span><span class="token punctuation">,</span>shenzhouX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shenzhouX<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcreteObserver</span><span class="token punctuation">(</span><span class="token string">"远望3号观测船"</span><span class="token punctuation">,</span>shenzhouX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shenzhouX<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token string">"飞船进入轨道"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shenzhouX<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token string">"姿态调整"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shenzhouX<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token string">"展开太阳能板"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：<span class="token punctuation">[</span>远望<span class="token number">1</span>号观测船<span class="token punctuation">]</span>观察到<span class="token punctuation">[</span>神舟<span class="token number">10</span>号飞船<span class="token punctuation">]</span>状态是：飞船进入轨道<span class="token punctuation">[</span>远望<span class="token number">2</span>号观测船<span class="token punctuation">]</span>观察到<span class="token punctuation">[</span>神舟<span class="token number">10</span>号飞船<span class="token punctuation">]</span>状态是：飞船进入轨道<span class="token punctuation">[</span>远望<span class="token number">3</span>号观测船<span class="token punctuation">]</span>观察到<span class="token punctuation">[</span>神舟<span class="token number">10</span>号飞船<span class="token punctuation">]</span>状态是：飞船进入轨道<span class="token punctuation">[</span>远望<span class="token number">1</span>号观测船<span class="token punctuation">]</span>观察到<span class="token punctuation">[</span>神舟<span class="token number">10</span>号飞船<span class="token punctuation">]</span>状态是：姿态调整<span class="token punctuation">[</span>远望<span class="token number">2</span>号观测船<span class="token punctuation">]</span>观察到<span class="token punctuation">[</span>神舟<span class="token number">10</span>号飞船<span class="token punctuation">]</span>状态是：姿态调整<span class="token punctuation">[</span>远望<span class="token number">3</span>号观测船<span class="token punctuation">]</span>观察到<span class="token punctuation">[</span>神舟<span class="token number">10</span>号飞船<span class="token punctuation">]</span>状态是：姿态调整<span class="token punctuation">[</span>远望<span class="token number">1</span>号观测船<span class="token punctuation">]</span>观察到<span class="token punctuation">[</span>神舟<span class="token number">10</span>号飞船<span class="token punctuation">]</span>状态是：展开太阳能板<span class="token punctuation">[</span>远望<span class="token number">2</span>号观测船<span class="token punctuation">]</span>观察到<span class="token punctuation">[</span>神舟<span class="token number">10</span>号飞船<span class="token punctuation">]</span>状态是：展开太阳能板<span class="token punctuation">[</span>远望<span class="token number">3</span>号观测船<span class="token punctuation">]</span>观察到<span class="token punctuation">[</span>神舟<span class="token number">10</span>号飞船<span class="token punctuation">]</span>状态是：展开太阳能板</code></pre><p>观察者模式总结</p><p>观察者模式主要优点如下：</p><ul><li><p>降低了目标与观察者之间的耦合关系，两者之间是抽象耦合关系；</p></li><li><p>目标与观察者之间建立了一套触发机制；</p></li></ul><p>它的主要缺点如下：</p><ul><li><p>目标与观察者之间的依赖关系并没有完全解除，而且有可能出现循环引用；</p></li><li><p>当观察者对象很多时，通知的发布会花费很多时间，影响程序的效率；</p></li></ul><p>观察者模式适用于以下几种情况：</p><ul><li>当一个抽象类型有两个方面，而其中一个方面必须依赖于另一个方面时；</li><li>当对一个对象的改变需要同时改变其他的对象但是却不知道具体有多少个对象等待改变时；</li><li>当一个对象必须通知其他对象但却不能与其他对象造成紧密耦合时；</li></ul><h4 id="5-备忘录模式"><a href="#5-备忘录模式" class="headerlink" title="5.备忘录模式"></a>5.备忘录模式</h4><p>备忘录模式是一种行为模式，在开发过程中，当我们需要执行一个取消操作从而使系统回滚到从前的一个状态，或者我们希望让一个处于暂停状态的工作继续运行时，就需要创建一个曾经在系统中出现过的对象。备忘录模式可以为一个对象听状态存储即状态恢复的方法。</p><p>其实很多应用软件都提供了这项功能，如 Word、记事本、Photoshop、Eclipse 等软件在编辑时按 Ctrl+Z 组合键时能撤销当前操作，使文档恢复到之前的状态；还有在 IE 中的后退键、数据库事务管理中的回滚操作、玩游戏时的中间结果存档功能、数据库与操作系统的备份操作、棋类游戏中的悔棋功能等都属于这类。</p><p><strong>备忘录（Memento）模式</strong>定义：在不破坏封装性的前提下，捕捉一个对象的内部状态，并在该对象之外保持这个状态。这样以后就可以将该对象恢复到原先保存的状态。</p><p>备忘录模式的主要角色如下：</p><ol><li><strong>发起人（Originator）角色</strong>：记录当前时刻的内部状态信息，提供创建备忘录和恢复备忘录数据的功能，实现其他业务功能，它可以访问备忘录里的所有信息。</li><li><strong>备忘录（Memento）角色</strong>：负责存储发起人的内部状态，在需要的时候提供这些内部状态给发起人。</li><li><strong>管理者（Caretaker）角色</strong>：对备忘录进行管理，提供保存与获取备忘录的功能，但其不能对备忘录的内容进行访问与修改。</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/MementoPattern.png" alt></p><p>示例</p><p>备忘录角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 备忘录 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Memento</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String state<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Memento</span><span class="token punctuation">(</span>String state<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span>String state<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> state<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>发起人角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 发起人 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Originator</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String state<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span>String state<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> state<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Memento <span class="token function">createMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Memento</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">restoreMemento</span><span class="token punctuation">(</span>Memento m<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>管理者</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 管理者 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Caretaker</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Memento memento<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMemento</span><span class="token punctuation">(</span>Memento m<span class="token punctuation">)</span> <span class="token punctuation">{</span>        memento <span class="token operator">=</span> m<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Memento <span class="token function">getMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> memento<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Originator originator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Originator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Caretaker caretaker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Caretaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        originator<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token string">"State1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"初始状态:"</span> <span class="token operator">+</span> originator<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        caretaker<span class="token punctuation">.</span><span class="token function">setMemento</span><span class="token punctuation">(</span>originator<span class="token punctuation">.</span><span class="token function">createMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//保存状态</span>        originator<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token string">"State2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"新的状态:"</span> <span class="token operator">+</span> originator<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        originator<span class="token punctuation">.</span><span class="token function">restoreMemento</span><span class="token punctuation">(</span>caretaker<span class="token punctuation">.</span><span class="token function">getMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//恢复状态</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"恢复状态:"</span> <span class="token operator">+</span> originator<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：初始状态<span class="token operator">:</span>State1新的状态<span class="token operator">:</span>State2恢复状态<span class="token operator">:</span>State1</code></pre><p>示例2（游戏进度归档）</p><p>备忘录角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 游戏状态（备忘录角色） */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GameState</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">GameState</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">int</span> coordinate<span class="token punctuation">,</span> <span class="token keyword">int</span> chapter<span class="token punctuation">,</span> <span class="token keyword">int</span> HP<span class="token punctuation">,</span> <span class="token keyword">int</span> MP<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>level <span class="token operator">=</span> level<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>coordinate <span class="token operator">=</span> coordinate<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>chapter <span class="token operator">=</span> chapter<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>HP <span class="token operator">=</span> HP<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>MP <span class="token operator">=</span> MP<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 角色等级     */</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> level<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 角色的地图坐标     */</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> coordinate<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 章节进度     */</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> chapter<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 生命值     */</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> HP<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 魔力值     */</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> MP<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> level<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLevel</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>level <span class="token operator">=</span> level<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCoordinate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> coordinate<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCoordinate</span><span class="token punctuation">(</span><span class="token keyword">int</span> coordinate<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>coordinate <span class="token operator">=</span> coordinate<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getChapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> chapter<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setChapter</span><span class="token punctuation">(</span><span class="token keyword">int</span> chapter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>chapter <span class="token operator">=</span> chapter<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getHP</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> HP<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setHP</span><span class="token punctuation">(</span><span class="token keyword">int</span> HP<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>HP <span class="token operator">=</span> HP<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMP</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> MP<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMP</span><span class="token punctuation">(</span><span class="token keyword">int</span> MP<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>MP <span class="token operator">=</span> MP<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>发起人角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 游戏角色（发起人角色） */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GameRole</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 角色等级     */</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> level<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 角色的地图坐标     */</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> coordinate<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 章节进度     */</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> chapter<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 生命值     */</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> HP<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 魔力值     */</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> MP<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 保存游戏状态     * @return     */</span>    <span class="token keyword">public</span> GameState <span class="token function">saveState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GameState</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> coordinate<span class="token punctuation">,</span> chapter<span class="token punctuation">,</span> HP<span class="token punctuation">,</span> MP<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 恢复存档     * @param gameState     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recover</span><span class="token punctuation">(</span>GameState gameState<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>level <span class="token operator">=</span> gameState<span class="token punctuation">.</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>coordinate <span class="token operator">=</span> gameState<span class="token punctuation">.</span><span class="token function">getCoordinate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>chapter <span class="token operator">=</span> gameState<span class="token punctuation">.</span><span class="token function">getChapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>HP <span class="token operator">=</span> gameState<span class="token punctuation">.</span><span class="token function">getHP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>MP <span class="token operator">=</span> gameState<span class="token punctuation">.</span><span class="token function">getMP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 显示游戏状态     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">showState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"游戏进度信息如下："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"角色级别："</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"角色坐标："</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>coordinate<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"角色生命值："</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>HP<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"角色魔力值："</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>MP<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"游戏章节："</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chapter <span class="token operator">+</span> <span class="token string">"章节"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 初始化     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>level <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>coordinate <span class="token operator">=</span> <span class="token number">1234</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>chapter <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>HP <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>MP <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 做任务失败     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doTaskFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>level <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>coordinate <span class="token operator">=</span> <span class="token number">1234</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>chapter <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>HP <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>MP <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>备忘录管理者角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 存档管理者 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GameStateCaretaker</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> GameState gameState<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setGameState</span><span class="token punctuation">(</span>GameState gameState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>gameState <span class="token operator">=</span> gameState<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> GameState <span class="token function">getGameState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> gameState<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//游戏初始状态</span>        GameRole  first <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GameRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        first<span class="token punctuation">.</span><span class="token function">initial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"做任务之前，"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        first<span class="token punctuation">.</span><span class="token function">showState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"===================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//进度保存</span>        GameStateCaretaker gameStateCaretaker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GameStateCaretaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        gameStateCaretaker<span class="token punctuation">.</span><span class="token function">setGameState</span><span class="token punctuation">(</span>first<span class="token punctuation">.</span><span class="token function">saveState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//做任务失败</span>        first<span class="token punctuation">.</span><span class="token function">doTaskFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"做任务失败后，"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        first<span class="token punctuation">.</span><span class="token function">showState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"===================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//恢复存档</span>        first<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>gameStateCaretaker<span class="token punctuation">.</span><span class="token function">getGameState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"恢复存档后，"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        first<span class="token punctuation">.</span><span class="token function">showState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：做任务之前，游戏进度信息如下：角色级别：<span class="token number">100</span>角色坐标：<span class="token number">1234</span>角色生命值：<span class="token number">1000</span>角色魔力值：<span class="token number">999</span>游戏章节：<span class="token number">10</span>章节<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>做任务失败后，游戏进度信息如下：角色级别：<span class="token number">100</span>角色坐标：<span class="token number">1234</span>角色生命值：<span class="token number">0</span>角色魔力值：<span class="token number">0</span>游戏章节：<span class="token number">10</span>章节<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>恢复存档后，游戏进度信息如下：角色级别：<span class="token number">100</span>角色坐标：<span class="token number">1234</span>角色生命值：<span class="token number">1000</span>角色魔力值：<span class="token number">999</span>游戏章节：<span class="token number">10</span>章节</code></pre><p>备忘录角色总结</p><p>备忘录模式是一种对象行为型模式，其主要优点如下：</p><ul><li>提供了一种可以恢复状态的机制。当用户需要时能够比较方便地将数据恢复到某个历史的状态；</li><li>实现了内部状态的封装。除了创建它的发起人之外，其他对象都不能够访问这些状态信息；</li><li>简化了发起人类。发起人不需要管理和保存其内部状态的各个备份，所有状态信息都保存在备忘录中，并由管理者进行管理，这符合单一职责原则；</li></ul><p>其主要缺点是：资源消耗大；如果要保存的内部状态信息过多或者特别频繁，将会占用比较大的内存资源。</p><p>备忘录模式适用于以下几种情况：</p><ul><li>当必须保存一个对象在某一时刻的全部或部分状态以便在需要时可以将其恢复到先前状态时；</li><li>当使用接口让其他对象直接得到自己的状态会暴露对象的实现细节继而破坏其封装性时；</li></ul><p>说人话，在以下场景可以考虑使用备忘录模式：</p><ul><li>需要保存与恢复数据的场景，如玩游戏时的中间结果的存档功能。</li><li>需要提供一个可回滚操作的场景，如 Word、记事本、Photoshop，Eclipse 等软件在编辑时按 Ctrl+Z 组合键，还有数据库中事务操作。</li></ul><h4 id="6-中介者模式"><a href="#6-中介者模式" class="headerlink" title="6.中介者模式"></a>6.中介者模式</h4><p>在现实生活中，常常会出现好多对象之间存在复杂的交互关系，这种交互关系常常是“网状结构”，它要求每个对象都必须知道它需要交互的对象。例如，每个人必须记住他（她）所有朋友的电话；而且，朋友中如果有人的电话修改了，他（她）必须告诉其他所有的朋友修改，这叫作“牵一发而动全身”，非常复杂。</p><p>如果把这种“网状结构”改为“星形结构”的话，将大大降低它们之间的“耦合性”，这时只要找一个“中介者”就可以了。如前面所说的“每个人必须记住所有朋友电话”的问题，只要在网上建立一个每个朋友都可以访问的“通信录”就解决了。这样的例子还有很多，例如，你刚刚参加工作想租房，可以找“房屋中介”；或者，自己刚刚到一个陌生城市找工作，可以找“人才交流中心”帮忙。</p><p>在软件的开发过程中，这样的例子也很多，例如，在 MVC 框架中，控制器（C）就是模型（M）和视图（V）的中介者；还有大家常用的 QQ 聊天程序的“中介者”是 QQ 服务器。所有这些，都可以采用“中介者模式”来实现，它将大大降低对象之间的耦合性，提高系统的灵活性。</p><p><strong>中介者（Mediator）模式</strong>定义：用一个中介对象来封装一系列的对象交互。中介者使各个对象不需要显示的相互引用，从而使器耦合松散，而且可以独立的改变它们之间的交互。中介者模式又叫调停模式，它是迪米特法则的典型应用。</p><p>中介者模式包含以下主要角色：</p><ol><li><strong>抽象中介者（Mediator）角色</strong>：它是中介者的接口，提供了同事对象注册与转发同事对象信息的抽象方法。</li><li><strong>具体中介者（ConcreteMediator）角色</strong>：实现中介者接口，定义一个 List 来管理同事对象，协调各个同事角色之间的交互关系，因此它依赖于同事角色。</li><li><strong>抽象同事类（Colleague）角色</strong>：定义同事类的接口，保存中介者对象，提供同事对象交互的抽象方法，实现所有相互影响的同事类的公共功能。</li><li><strong>具体同事类（ConcreteColleague）角色</strong>：是抽象同事类的实现者，当需要与其他同事对象交互时，由中介者对象负责后续的交互。</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/MediatorPattern.png" alt></p><p>示例</p><p>抽象中介者角色</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Mediator</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 注册     * @param colleague     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span>Colleague colleague<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 转发     * @param msg     * @param c     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">forward</span><span class="token punctuation">(</span>String msg<span class="token punctuation">,</span> Colleague c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体中介者角色</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteMediator</span> <span class="token keyword">extends</span> <span class="token class-name">Mediator</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>Colleague<span class="token operator">></span> colleagueList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span>Colleague colleague<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>colleagueList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>colleague<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>colleagueList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>colleague<span class="token punctuation">)</span><span class="token punctuation">;</span>            colleague<span class="token punctuation">.</span><span class="token function">setMediator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">forward</span><span class="token punctuation">(</span>String msg<span class="token punctuation">,</span> Colleague c<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>Colleague colleague <span class="token operator">:</span> colleagueList<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>colleague<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                colleague<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>抽象同事类角色</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Colleague</span> <span class="token punctuation">{</span>    <span class="token keyword">protected</span> Mediator mediator<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMediator</span><span class="token punctuation">(</span>Mediator mediator<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>mediator <span class="token operator">=</span> mediator<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 接收信息     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span>String msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 发送信息     * @param msg     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span>String msg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体同事类角色A</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteColleagueA</span> <span class="token keyword">extends</span> <span class="token class-name">Colleague</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span>String msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Colleague A got a message: "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span>String msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mediator<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体同事类角色B</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteColleagueB</span> <span class="token keyword">extends</span> <span class="token class-name">Colleague</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span>String msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Colleague B got a message: "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span>String msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mediator<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ConcreteMediator concreteMediator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteMediator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ConcreteColleagueA ca <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteColleagueA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ca<span class="token punctuation">.</span><span class="token function">setMediator</span><span class="token punctuation">(</span>concreteMediator<span class="token punctuation">)</span><span class="token punctuation">;</span>        ConcreteColleagueB cb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteColleagueB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        cb<span class="token punctuation">.</span><span class="token function">setMediator</span><span class="token punctuation">(</span>concreteMediator<span class="token punctuation">)</span><span class="token punctuation">;</span>        concreteMediator<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>ca<span class="token punctuation">)</span><span class="token punctuation">;</span>        concreteMediator<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>        ca<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Hello, I am A!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        cb<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Hello, I am B!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：Colleague B got a message<span class="token operator">:</span> Hello<span class="token punctuation">,</span> I am A<span class="token operator">!</span>Colleague A got a message<span class="token operator">:</span> Hello<span class="token punctuation">,</span> I am B<span class="token operator">!</span></code></pre><p>中介者模式总结</p><p>中介者模式是一种对象行为型模式，其主要优点如下：</p><ul><li><p>降低了对象之间的耦合性，使得对象易于独立地被复用；</p></li><li><p>将对象间的一对多关联转变为一对一的关联，提高系统的灵活性，使得系统易于维护和扩展；</p></li></ul><p>其主要缺点是：当同事类太多时，中介者的职责将很大，它会变得复杂而庞大，以至于系统难以维护。</p><p>前面分析了中介者模式的结构与特点，下面分析其以下应用场景：</p><ul><li>当对象之间存在复杂的网状结构关系而导致依赖关系混乱且难以复用时。</li><li>当想创建一个运行于多个类之间的对象，又不想生成新的子类时。</li></ul><h4 id="7-命令模式"><a href="#7-命令模式" class="headerlink" title="7.命令模式"></a>7.命令模式</h4><p>在软件开发中，为了执行一个方法，开发人员统筹会去调用这个方法。有这么一种情况并不适用域直接去调用方法，那就是为了执行某个方法系统必须满足一个特定的执行顺序或者语境，但是开发人员设法去控制这个特定的顺序或语境时，解决这个问题的一个方法就是把方法封装在一个对象当中，这就是命令模式。</p><p>在现实生活中，这样的例子也有很多。例如，电视遥控器(命令发送者)通过按钮(具体命令)来遥控电视机(命令的接收者)。</p><p><strong>命令模式（Command）</strong>定义：将一个请求封装为一个对象，从而使用户可以用不同的请求对客户进行参数化；对请求排队或记录请求日志，并支持可撤销的操作。</p><p>命令模式包含以下主要角色：</p><ol><li><strong>抽象命令类（Command）角色</strong>：声明执行命令的接口，拥有执行命令的抽象方法 execute()。</li><li><strong>具体命令角色（ConcreteCommand）角色</strong>：是抽象命令类的具体实现类，它拥有接收者对象，并通过调用接收者的功能来完成命令要执行的操作。</li><li><strong>实现者/接收者（Receiver）角色</strong>：执行命令功能的相关操作，是具体命令对象业务的真正实现者。</li><li><strong>调用者/请求者（Invoker）角色</strong>：是请求的发送者，它通常拥有很多的命令对象，并通过访问命令对象来执行相关请求，它不直接访问接收者。</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/CommandPattern.png" alt></p><p>示例1</p><p>抽象命令角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 抽象命令角色 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体命令角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体命令角色 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Receiver receiver<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ConcreteCommand</span><span class="token punctuation">(</span>Receiver receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>receiver <span class="token operator">=</span> receiver<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        receiver<span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>接收者角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 命令接收者角色 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Receiver</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收者: execute the request!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>调用者角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 命令调用者角色 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Invoker</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Command command<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCommand</span><span class="token punctuation">(</span>Command command<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>command <span class="token operator">=</span> command<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用者发出命令..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 客户端 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Receiver receiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Receiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Command command <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteCommand</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>        Invoker invoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Invoker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        invoker<span class="token punctuation">.</span><span class="token function">setCommand</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//客户端调用调用者的call方法</span>        invoker<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：调用者发出命令<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>接收者<span class="token operator">:</span> execute the request<span class="token operator">!</span></code></pre><p>示例2</p><p>抽象命令角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 抽象命令角色 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体命令角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 开灯（具体命令角色） * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwitchOnCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> Light light<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">SwitchOnCommand</span><span class="token punctuation">(</span>Light light<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>light <span class="token operator">=</span> light<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        light<span class="token punctuation">.</span><span class="token function">turnOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体命令角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 关灯（具体命令角色） * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwitchOffCommand</span> <span class="token keyword">implements</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> Light light<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">SwitchOffCommand</span><span class="token punctuation">(</span>Light light<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>light <span class="token operator">=</span> light<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        light<span class="token punctuation">.</span><span class="token function">turnOff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>接收者角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 灯（命令接收者角色） * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Light</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">turnOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"The light is on"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">turnOff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"The light is off"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>调用者角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 控制开关（调用者角色） * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Switch</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> HashMap<span class="token operator">&lt;</span>String <span class="token punctuation">,</span>Command<span class="token operator">></span> commandMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span>String cname<span class="token punctuation">,</span> Command command<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>commandMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cname<span class="token punctuation">,</span> command<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>String cname<span class="token punctuation">)</span><span class="token punctuation">{</span>        Command command <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commandMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cname<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"no command registered for "</span> <span class="token operator">+</span> cname<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Light lamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Light</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Command switchOn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SwitchOnCommand</span><span class="token punctuation">(</span>lamp<span class="token punctuation">)</span><span class="token punctuation">;</span>        Command switchOff <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SwitchOffCommand</span><span class="token punctuation">(</span>lamp<span class="token punctuation">)</span><span class="token punctuation">;</span>        Switch mySwitch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mySwitch<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"on"</span><span class="token punctuation">,</span> switchOn<span class="token punctuation">)</span><span class="token punctuation">;</span>        mySwitch<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"off"</span><span class="token punctuation">,</span> switchOff<span class="token punctuation">)</span><span class="token punctuation">;</span>        mySwitch<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"on"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mySwitch<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"off"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：The light is onThe light is off</code></pre><p>命令模式总结</p><p>命令模式的主要优点如下：</p><ul><li><p>降低系统的耦合度。命令模式能将调用操作的对象与实现该操作的对象解耦。</p></li><li><p>增加或删除命令非常方便。采用命令模式增加与删除命令不会影响其他类，它满足“开闭原则”，对扩展比较灵活。</p></li><li><p>可以实现宏命令。命令模式可以与<strong>组合模式</strong>结合，将多个命令装配成一个组合命令，即宏命令。</p></li><li><p>方便实现 Undo 和 Redo 操作。命令模式可以与前面介绍的<strong>备忘录模式</strong>结合，实现命令的撤销与恢复。</p></li></ul><p>其缺点是：可能产生大量具体命令类。因为计对每一个具体操作都需要设计一个具体命令类，这将增加系统的复杂性。</p><p>命令模式通常适用于以下场景：</p><ul><li><p>当系统需要将请求调用者与请求接收者解耦时，命令模式使得调用者和接收者不直接交互。</p></li><li><p>当系统需要随机请求命令或经常增加或删除命令时，命令模式比较方便实现这些功能。</p></li><li><p>当系统需要执行一组操作时，命令模式可以定义宏命令来实现该功能。</p></li><li><p>当系统需要支持命令的撤销（Undo）操作和恢复（Redo）操作时，可以将命令对象存储起来，采用备忘录模式来实现。</p></li></ul><h4 id="8-访问者模式"><a href="#8-访问者模式" class="headerlink" title="8.访问者模式"></a>8.访问者模式</h4><p>在现实生活中，有些集合元素对象中存在很多种不同的元素且每种元素也存在许多种不同的访问者和处理方式。例如，公园中存在多个景点，也存在多个游客，不同的游客对同一个景点的评价可能不同；电影或电视剧中的人物角色，不同的观众对它们的评价也不同，”一千个读者心中有一千个哈姆雷特”。</p><p>这些被处理的数据元素相对稳定而访问方式多种多样的数据结构，如果用”访问者模式”来处理比较方便。访问者模式是23种设计模式种最复杂也是最难理解的一个，访问者模式能把处理数据方法从数据结构中分离出来，并可以根据需要增加新的处理方法，且不用修改原理的程序代码与数据结构，这样提高了程序的扩展性和灵活性。</p><p><strong>访问者模式（Visitor）</strong>定义：将作用于某种数据结构中的元素的操作分离出来封装成独立的类，使其在不改变数据结构的前提下可以添加作用于这些元素的新的操作，为数据结构中的每个元素提供多种访问方式。</p><p>访问者模式包含以下主要角色：</p><ol><li><p><strong>抽象访问者（Visitor）角色</strong>：定义一个访问具体元素的接口，为每个具体元素类对应一个访问操作 visit() ，该操作中的参数类型标识了被访问的具体元素。</p></li><li><p><strong>具体访问者（ConcreteVisitor）角色</strong>：实现抽象访问者角色中声明的各个访问操作，确定访问者访问一个元素时该做什么。</p></li><li><p><strong>抽象元素（Element）角色</strong>：声明一个包含接受操作 accept() 的接口，被接受的访问者对象作为 accept() 方法的参数。</p></li><li><p><strong>具体元素（ConcreteElement）角色</strong>：实现抽象元素角色提供的 accept() 操作，其方法体通常都是 visitor.visit(this) ，另外具体元素中可能还包含本身业务逻辑的相关操作。</p></li><li><p><strong>对象结构（ObjectStructure）角色</strong>：是一个包含元素角色的容器，提供让访问者对象遍历容器中的所有元素的方法，通常由 List、Set、Map 等聚合类实现。</p><p>结构图</p><p><img src="/2019/03/02/DesignPattern/VisitorPattern.png" alt></p><p>示例1</p><p>抽象访问者</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 抽象访问者类 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Visitor</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>ConcreteElementA elementA<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>ConcreteElementB elementB<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体访问者A</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体访问者A * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteVisitorA</span> <span class="token keyword">implements</span> <span class="token class-name">Visitor</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>ConcreteElementA elementA<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"具体访问者A："</span> <span class="token operator">+</span> elementA<span class="token punctuation">.</span><span class="token function">operationA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>ConcreteElementB elementB<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"具体访问者A："</span> <span class="token operator">+</span> elementB<span class="token punctuation">.</span><span class="token function">operationB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体访问者B</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体访问者B * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteVisitorB</span> <span class="token keyword">implements</span> <span class="token class-name">Visitor</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>ConcreteElementA elementA<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"具体访问者B："</span> <span class="token operator">+</span> elementA<span class="token punctuation">.</span><span class="token function">operationA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>ConcreteElementB elementB<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"具体访问者B："</span> <span class="token operator">+</span> elementB<span class="token punctuation">.</span><span class="token function">operationB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>抽象元素类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 抽象元素类 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>Visitor visitor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体元素类A</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体元素A * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteElementA</span> <span class="token keyword">implements</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>Visitor visitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        visitor<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">operationA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"具体元素A的操作。"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体元素类B</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体元素B * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteElementB</span> <span class="token keyword">implements</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>Visitor visitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        visitor<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">operationB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"具体元素B的操作。"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>对象结构</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 对象结构类 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectStructure</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>Element<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Element<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>Visitor visitor<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        Iterator<span class="token operator">&lt;</span>Element<span class="token operator">></span> i<span class="token operator">=</span>list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            Element element <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            element<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>visitor<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>Element element<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>Element element<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 客户端 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ObjectStructure objectStructure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectStructure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        objectStructure<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcreteElementA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        objectStructure<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcreteElementB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Visitor visitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteVisitorA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        objectStructure<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>visitor<span class="token punctuation">)</span><span class="token punctuation">;</span>        visitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteVisitorB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        objectStructure<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>visitor<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：具体访问者A：具体元素A的操作。具体访问者A：具体元素B的操作。具体访问者B：具体元素A的操作。具体访问者B：具体元素B的操作。</code></pre><p>示例2</p><p>抽象访问类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 抽象访问类 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CarElementVisitor</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>Body body<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>Car car<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>Engine engine<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>Wheel wheel<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体访问类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体访问类 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CarElementDoVisitor</span> <span class="token keyword">implements</span> <span class="token class-name">CarElementVisitor</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>Body body<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Moving my body"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>Car car<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Starting my car"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>Engine engine<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Starting my engine"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>Wheel wheel<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Kicking my "</span> <span class="token operator">+</span> wheel<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" wheel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体访问类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体访问类 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CarElementPrintVisitor</span> <span class="token keyword">implements</span> <span class="token class-name">CarElementVisitor</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>Body body<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Visiting body"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>Car car<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Visiting car"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>Engine engine<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Visiting engine"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span>Wheel wheel<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Visiting "</span> <span class="token operator">+</span> wheel<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" wheel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>抽象元素类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 抽象元素类 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CarElement</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>CarElementVisitor visitor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体元素类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * （车轮）具体元素类 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Wheel</span> <span class="token keyword">implements</span> <span class="token class-name">CarElement</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> String name<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Wheel</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>CarElementVisitor visitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        visitor<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体元素类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * （发动机）具体元素类 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Engine</span> <span class="token keyword">implements</span> <span class="token class-name">CarElement</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>CarElementVisitor visitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        visitor<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体元素类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * （车身）具体元素类 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Body</span> <span class="token keyword">implements</span> <span class="token class-name">CarElement</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>CarElementVisitor visitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        visitor<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>对象结构类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 对象结构类 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Car</span> <span class="token keyword">implements</span> <span class="token class-name">CarElement</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>CarElement<span class="token operator">></span> elements<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Car</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>CarElement<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token string">"front left"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token string">"front right"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token string">"back left"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token string">"back right"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Engine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>elements <span class="token operator">=</span> list<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>CarElementVisitor visitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>CarElement element <span class="token operator">:</span> elements<span class="token punctuation">)</span><span class="token punctuation">{</span>            element<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>visitor<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        visitor<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 客户端类 * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Car car <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        car<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CarElementPrintVisitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        car<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CarElementDoVisitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：Visiting front left wheelVisiting front right wheelVisiting back left wheelVisiting back right wheelVisiting bodyVisiting engineVisiting carKicking my front left wheelKicking my front right wheelKicking my back left wheelKicking my back right wheelMoving my bodyStarting my engineStarting my car</code></pre><p>访问者模式总结</p><p>访问者（Visitor）模式是一种对象行为型模式，其主要优点如下：</p><ul><li><p>扩展性好：能够在不修改对象结构中的元素的情况下，为对象结构中的元素添加新的功能。</p></li><li><p>复用性好：可以通过访问者来定义整个对象结构通用的功能，从而提高系统的复用程度。</p></li><li><p>灵活性好：访问者模式将数据结构与作用于结构上的操作解耦，使得操作集合可相对自由地演化而不影响系统的数据结构。</p></li><li><p>符合单一职责原则：访问者模式把相关的行为封装在一起，构成一个访问者，使每一个访问者的功能都比较单一。</p></li></ul><p>访问者（Visitor）模式的主要缺点如下：</p><ul><li><p>增加新的元素类很困难：在访问者模式中，每增加一个新的元素类，都要在每一个具体访问者类中增加相应的具体操作，这违背了“开闭原则”。</p></li><li><p>破坏封装：访问者模式中具体元素对访问者公布细节，这破坏了对象的封装性。</p></li><li><p>违反了依赖倒置原则：访问者模式依赖了具体类，而没有依赖抽象类。</p></li></ul><p>访问者模式适用于以下几种情况：</p><ul><li><p>当一个对象结构包含很多类对象，但是它梦有不同的接口，并且开发人员希望对这些对象实施一些依赖于其具体类的操作时；</p></li><li><p>当需要对一个对象结构中的对象进行很多不同的并且不相关的操作时；</p></li><li><p>当该对象结构被很多应用共享时。</p></li></ul></li></ol><h4 id="9-职责链模式"><a href="#9-职责链模式" class="headerlink" title="9.职责链模式"></a>9.职责链模式</h4><p>在现实生活中，有这样的一些例子：一个申请有多个对象可以处理，但是每个对象的处理的条件或权限不同。例如，公司员工请假，可以批假的领导有部门负责人、副总经理、总经理，但每个领导能批准的天数不同，员工必须根据自己要请假的天数去找不同的领导签名，就是说员工必须记住每个领导的姓名、电话和地址等信息，这增加了难度。</p><p>在计算机软件中也有相关的例子，Struts2的拦截器、JSP和Servlet的Filter等，所有这些都是职责链模式的体现。</p><p><strong>职责链（Chain Of Responsibility）模式</strong>定义：为了避免请求发送者与多个请求处理者耦合在一起，将请求的所有处理者连成一条链，并沿着这条链传递该请求，直到有一个对象处理它为止。</p><p>职责链模式主要包含以下角色：</p><ol><li><strong>抽象处理者（Handler）角色</strong>：定义一个处理请求的接口，包含抽象处理方法和一个后继连接。</li><li><strong>具体处理者（ConcreteHandler）角色</strong>：实现抽象处理者的处理方法，判断能否处理本次请求，如果可以处理请求则处理，否则将该请求转给它的后继者。</li><li><strong>客户类（Client）角色</strong>：创建处理链，并向链头的具体处理者对象提交请求，它不关心处理细节和请求的传递过程。</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/ChainOfResponsibilityPattern.png" alt></p><p>示例1</p><p>抽象处理者角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** *  处理请求接口 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>    <span class="token keyword">protected</span> Handler next<span class="token punctuation">;</span>    <span class="token keyword">public</span> Handler <span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> next<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNext</span><span class="token punctuation">(</span>Handler next<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 抽象处理请求方法     * @param request     */</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span>String request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体处理者角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体处理者1 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteHandler1</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span>String request<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"具体处理者1负责处理该请求！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"自身无法满足请求，转给下一个处理者！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"没有人处理该请求！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span></code></pre><p>具体处理者角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * * 具体处理者1 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteHandler2</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span>String request<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"second"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"具体处理者2负责处理该请求！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"自身无法满足请求，转给下一个处理者！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"没有人处理该请求！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 客户端 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Handler handler1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteHandler1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Handler handler2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteHandler2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        handler1<span class="token punctuation">.</span><span class="token function">setNext</span><span class="token punctuation">(</span>handler2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//提交请求</span>        handler1<span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token string">"second"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：com<span class="token punctuation">.</span>lancq<span class="token punctuation">.</span>behaviorpattern<span class="token punctuation">.</span>chainofresponsibility<span class="token punctuation">.</span>ConcreteHandler1自身无法满足请求，转给下一个处理者！具体处理者<span class="token number">2</span>负责处理该请求！</code></pre><p>示例2：日志打印</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">enum</span> LogLevel <span class="token punctuation">{</span>    INFO<span class="token punctuation">,</span> DEBUG<span class="token punctuation">,</span> WARNING<span class="token punctuation">,</span> ERROR<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>抽象处理者角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**抽象处理者角色 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Logger</span> <span class="token punctuation">{</span>    <span class="token keyword">protected</span> LogLevel logMask<span class="token punctuation">;</span>    <span class="token keyword">protected</span> Logger next<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Logger</span><span class="token punctuation">(</span>LogLevel mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>logMask <span class="token operator">=</span> mask<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Logger <span class="token function">setNext</span><span class="token punctuation">(</span>Logger nextLogger<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> nextLogger<span class="token punctuation">;</span>        <span class="token keyword">return</span> nextLogger<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">message</span><span class="token punctuation">(</span>String msg<span class="token punctuation">,</span> LogLevel severity<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>logMask <span class="token operator">==</span> severity<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">writeMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            next<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> severity<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">abstract</span> <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">writeMessage</span><span class="token punctuation">(</span>String msg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体处理者角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体处理请求角色 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsoleLogger</span> <span class="token keyword">extends</span> <span class="token class-name">Logger</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">ConsoleLogger</span><span class="token punctuation">(</span>LogLevel mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">writeMessage</span><span class="token punctuation">(</span>String msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Writing to console: "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体处理者角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体处理请求角色 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EmailLogger</span> <span class="token keyword">extends</span> <span class="token class-name">Logger</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">EmailLogger</span><span class="token punctuation">(</span>LogLevel mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">writeMessage</span><span class="token punctuation">(</span>String msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Sending via email: "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体处理者角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体处理请求角色 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileLogger</span> <span class="token keyword">extends</span> <span class="token class-name">Logger</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">FileLogger</span><span class="token punctuation">(</span>LogLevel mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">writeMessage</span><span class="token punctuation">(</span>String msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Writing to Log File: "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 客户端 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Logger logger<span class="token punctuation">,</span> logger1<span class="token punctuation">,</span> logger2<span class="token punctuation">;</span>        logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsoleLogger</span><span class="token punctuation">(</span>LogLevel<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">;</span>        logger1 <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">setNext</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EmailLogger</span><span class="token punctuation">(</span>LogLevel<span class="token punctuation">.</span>WARNING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        logger2 <span class="token operator">=</span> logger1<span class="token punctuation">.</span><span class="token function">setNext</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileLogger</span><span class="token punctuation">(</span>LogLevel<span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        logger<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">"Entering function ProcessOrder()."</span><span class="token punctuation">,</span> LogLevel<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">;</span>        logger<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">"Customer Address details missing in Branch DataBase."</span><span class="token punctuation">,</span> LogLevel<span class="token punctuation">.</span>WARNING<span class="token punctuation">)</span><span class="token punctuation">;</span>        logger<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">"Customer Address details missing in Organization DataBase."</span><span class="token punctuation">,</span> LogLevel<span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：Writing to console<span class="token operator">:</span> Entering function <span class="token function">ProcessOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Sending via email<span class="token operator">:</span> Customer Address details missing in Branch DataBase<span class="token punctuation">.</span>Writing to Log File<span class="token operator">:</span> Customer Address details missing in Organization DataBase<span class="token punctuation">.</span></code></pre><p>职责链模式总结</p><p>责任链模式是一种对象行为型模式，其主要优点如下：</p><ul><li>降低了对象之间的耦合度。该模式使得一个对象无须知道到底是哪一个对象处理其请求以及链的结构，发送者和接收者也无须拥有对方的明确信息。</li><li>增强了系统的可扩展性。可以根据需要增加新的请求处理类，满足开闭原则。</li><li>增强了给对象指派职责的灵活性。当工作流程发生变化，可以动态地改变链内的成员或者调动它们的次序，也可动态地新增或者删除责任。</li><li>责任链简化了对象之间的连接。每个对象只需保持一个指向其后继者的引用，不需保持其他所有处理者的引用，这避免了使用众多的 if 或者 if···else 语句。</li><li>责任分担。每个类只需要处理自己该处理的工作，不该处理的传递给下一个对象完成，明确各类的责任范围，符合类的单一职责原则。</li></ul><p>其主要缺点如下：</p><ul><li>不能保证每个请求一定被处理。由于一个请求没有明确的接收者，所以不能保证它一定会被处理，该请求可能一直传到链的末端都得不到处理。</li><li>对比较长的职责链，请求的处理可能涉及多个处理对象，系统性能将受到一定影响。</li><li>职责链建立的合理性要靠客户端来保证，增加了客户端的复杂性，可能会由于职责链的错误设置而导致系统出错，如可能会造成循环调用。</li></ul><p>责任链模式通常在以下几种情况使用：</p><ul><li><p>有多个对象可以处理一个请求，哪个对象处理该请求由运行时刻自动确定。</p></li><li><p>可动态指定一组对象处理请求，或添加新的处理者。</p></li><li><p>在不明确指定请求处理者的情况下，向多个处理者中的一个提交请求。</p></li></ul><h4 id="10-迭代器模式"><a href="#10-迭代器模式" class="headerlink" title="10.迭代器模式"></a>10.迭代器模式</h4><p>迭代器模式曾经是一种最常见、最简单的设计模式，它提供一种顺序访问某个集合中所有元素的解决方案，而不用了解集合底层的操作。虽然现在信息的语言当中都将迭代器集成了进去，但是讨论迭代器模式的实现对于我们理解面向对象开发而言任然有器学习价值存在。</p><p>将遍历聚合对象中数据的行为提取出来，并把其封装到一个迭代器中，通过转入的迭代器去遍历聚合对象的内部数据，这是迭代器模式的本质。迭代器模式是”单一职责”的完美体现。在Java中，List、Set、Map都包含了迭代器。</p><p><strong>迭代器（Iterator）模式</strong>定义：提供一种方法顺序访问一个聚合对象中的各个元素，而又不保留该对象的内部表示。</p><p>迭代器模式主要包含以下角色：</p><ol><li><strong>抽象聚合（Aggregate）角色</strong>：定义存储、添加、删除聚合对象以及创建迭代器对象的接口。</li><li><strong>具体聚合（ConcreteAggregate）角色</strong>：实现抽象聚合类，返回一个具体迭代器的实例。</li><li><strong>抽象迭代器（Iterator）角色</strong>：定义访问和遍历聚合元素的接口，通常包含 hasNext()、first()、next() 等方法。</li><li><strong>具体迭代器（Concretelterator）角色</strong>：实现抽象迭代器接口中所定义的方法，完成对聚合对象的遍历，记录遍历的当前位置。</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/IteratorPattern.png" alt></p><p>示例</p><p>抽象聚合角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 抽象聚合角色 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Aggregate</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    Iterator <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体聚合角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体聚合角色 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteAggregate</span> <span class="token keyword">implements</span> <span class="token class-name">Aggregate</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>Object<span class="token operator">></span> items <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>        items<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>        items<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Iterator <span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteIterator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Object<span class="token operator">></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> items<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>抽象迭代器角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 抽象迭代器角色 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Iterator</span> <span class="token punctuation">{</span>    Object <span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>具体迭代器角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 具体迭代器角色 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteIterator</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> ConcreteAggregate aggregate<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ConcreteIterator</span><span class="token punctuation">(</span>ConcreteAggregate concreteAggregate<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>aggregate <span class="token operator">=</span> concreteAggregate<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Object <span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> aggregate<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Object <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Object obj <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aggregate<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aggregate<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> index <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aggregate<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 客户端 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ConcreteAggregate aggregate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteAggregate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            aggregate<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"【"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"】号求职者"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        Iterator iterator <span class="token operator">=</span> aggregate<span class="token punctuation">.</span><span class="token function">createIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"请"</span> <span class="token operator">+</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"到第"</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"会议室参加面试！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：请【<span class="token number">1</span>】号求职者到第<span class="token number">3</span>会议室参加面试！请【<span class="token number">2</span>】号求职者到第<span class="token number">5</span>会议室参加面试！请【<span class="token number">3</span>】号求职者到第<span class="token number">4</span>会议室参加面试！请【<span class="token number">4</span>】号求职者到第<span class="token number">3</span>会议室参加面试！请【<span class="token number">5</span>】号求职者到第<span class="token number">4</span>会议室参加面试！请【<span class="token number">6</span>】号求职者到第<span class="token number">3</span>会议室参加面试！请【<span class="token number">7</span>】号求职者到第<span class="token number">5</span>会议室参加面试！请【<span class="token number">8</span>】号求职者到第<span class="token number">4</span>会议室参加面试！请【<span class="token number">9</span>】号求职者到第<span class="token number">5</span>会议室参加面试！请【<span class="token number">10</span>】号求职者到第<span class="token number">2</span>会议室参加面试！</code></pre><p>迭代器模式总结</p><p>主要优点：</p><ul><li><p>访问一个聚合对象的内容而无须暴露它的内部表示；</p></li><li><p>遍历任务交由迭代器完成，这简化了聚合类；</p></li><li><p>它支持以不同方式遍历一个聚合，甚至可以自定义迭代器的子类以支持新的遍历；</p></li><li><p>增加新的聚合类和迭代器类都很方便，无须修改原有代码；</p></li><li><p>封装性良好，为遍历不同的聚合结构提供一个统一的接口；</p></li></ul><p>其主要缺点是：增加了类的个数，这在一定程度上增加了系统的复杂性。</p><p>迭代器适用于以下几种情况：</p><ul><li>当需要访问一个聚合对象的内容而又不想暴露它的内部表示时；</li><li>当希望支持对聚合对象的多种遍历方式时；</li><li>当需要为遍历不同的聚合解雇提供统一的对外接口时；</li></ul><h4 id="11-解释器模式"><a href="#11-解释器模式" class="headerlink" title="11.解释器模式"></a>11.解释器模式</h4><p>在软件开发中，当一种特定类型的问题发生至足够高的频率后，那么就值得将此问题的各个实例表述为一个简单语言中的句子，以此来构建一个解释器，这个解释器通过解释这些语句来处理问题。</p><p><strong>解释器（Interpreter）模式</strong>定义：给定一个语言，定义它的文法的一种表示，并定义一个解释器，这个解释器使用该表示来解释语言中的句子。</p><p>解释器模式包含以下主要角色：</p><ol><li><strong>抽象表达式（AbstractExpression）角色</strong>：定义解释器的接口，约定解释器的解释操作，主要包含解释方法 interpret()。</li><li><strong>终结符表达式（TerminalExpression）角色</strong>：是抽象表达式的子类，用来实现文法中与终结符相关的操作，文法中的每一个终结符都有一个具体终结表达式与之相对应。</li><li><strong>非终结符表达式（NonterminalExpression）角色</strong>：也是抽象表达式的子类，用来实现文法中与非终结符相关的操作，文法中的每条规则都对应于一个非终结符表达式。</li><li><strong>环境（Context）角色</strong>：通常包含各个解释器需要的数据或是公共的功能，一般用来传递被所有解释器共享的数据，后面的解释器可以从这里获取这些值。</li><li><strong>客户端（Client）</strong>：主要任务是将需要分析的句子或表达式转换成使用解释器对象描述的抽象语法树，然后调用解释器的解释方法，当然也可以通过环境角色间接访问解释器的解释方法。</li></ol><p>结构图</p><p><img src="/2019/03/02/DesignPattern/InterpreterPattern.png" alt></p><p>示例</p><p>抽象表达式角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 抽象表达式 *  * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractExpression</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">interpret</span><span class="token punctuation">(</span>Context info<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>终端表达式角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 终端表达式 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TerminalExpression</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractExpression</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">interpret</span><span class="token punctuation">(</span>Context info<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getInputString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"终端解释器"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>非终端表达式角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 非终端表达式 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NonterminalExpression</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractExpression</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">interpret</span><span class="token punctuation">(</span>Context info<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getInputString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"非终端解释器"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>环境角色</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 环境 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String inputString<span class="token punctuation">;</span>    <span class="token keyword">private</span> String outputString<span class="token punctuation">;</span>    <span class="token keyword">public</span> String <span class="token function">getInputString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> inputString<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setInputString</span><span class="token punctuation">(</span>String inputString<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>inputString <span class="token operator">=</span> inputString<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getOutputString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> outputString<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOutputString</span><span class="token punctuation">(</span>String outputString<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>outputString <span class="token operator">=</span> outputString<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>客户端</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 客户端 * * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Context context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">setInputString</span><span class="token punctuation">(</span><span class="token string">"输入的文字"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>AbstractExpression<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TerminalExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NonterminalExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TerminalExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：输入的文字终端解释器输入的文字非终端解释器输入的文字终端解释器</code></pre><p>示例2</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * @author lancq */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Interpreter</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@FunctionalInterface</span>    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Expr</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> <span class="token function">interpret</span><span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">static</span> Expr <span class="token function">number</span><span class="token punctuation">(</span><span class="token keyword">int</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> context <span class="token operator">-</span><span class="token operator">></span> number<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">static</span> Expr <span class="token function">plus</span><span class="token punctuation">(</span>Expr left<span class="token punctuation">,</span> Expr right<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> context <span class="token operator">-</span><span class="token operator">></span> left<span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">+</span> right<span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">static</span> Expr <span class="token function">minus</span><span class="token punctuation">(</span>Expr left<span class="token punctuation">,</span> Expr right<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> context <span class="token operator">-</span><span class="token operator">></span> left<span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">-</span> right<span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">static</span> Expr <span class="token function">variable</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> context <span class="token operator">-</span><span class="token operator">></span> context<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Expr <span class="token function">parseToken</span><span class="token punctuation">(</span>String token<span class="token punctuation">,</span> ArrayDeque<span class="token operator">&lt;</span>Expr<span class="token operator">></span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Expr left<span class="token punctuation">,</span> right<span class="token punctuation">;</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token string">"+"</span><span class="token operator">:</span>                <span class="token comment" spellcheck="true">// it's necessary to remove first the right operand from the stack</span>                right <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// ..and then the left one</span>                left <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> Expr<span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"-"</span><span class="token operator">:</span>                right <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                left <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> Expr<span class="token punctuation">.</span><span class="token function">minus</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token operator">:</span>                <span class="token keyword">return</span> Expr<span class="token punctuation">.</span><span class="token function">variable</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Expr <span class="token function">parse</span><span class="token punctuation">(</span>String expression<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ArrayDeque<span class="token operator">&lt;</span>Expr<span class="token operator">></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>String token <span class="token operator">:</span> expression<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">parseToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Expr expr <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"w x z - +"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"z"</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> result <span class="token operator">=</span> expr<span class="token punctuation">.</span><span class="token function">interpret</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// -27</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>输出结果：<span class="token operator">-</span><span class="token number">27</span></code></pre><p>解释器模式总结:</p><p>解释器模式是一种类行为型模式，其主要优点如下:</p><ul><li><p>扩展性好：由于在解释器模式中使用类来表示语言的文法规则，因此可以通过继承等机制来改变或扩展文法；</p></li><li><p>容易实现：在语法树中的每个表达式节点类都是相似的，所以实现其文法较为容易；</p></li></ul><p>解释器模式的主要缺点如下：</p><ul><li><p>执行效率较低：解释器模式中通常使用大量的循环和递归调用，当要解释的句子较复杂时，其运行速度很慢，且代码的调试过程也比较麻烦；</p></li><li><p>会引起类膨胀：解释器模式中的每条规则至少需要定义一个类，当包含的文法规则很多时，类的个数将急剧增加，导致系统难以管理与维护；</p></li><li><p>可应用的场景比较少：在软件开发中，需要定义语言文法的应用实例非常少，所以这种模式很少被使用到。</p></li></ul><p>面介绍了解释器模式的结构与特点，下面分析它的应用场景：</p><ul><li><p>当语言的文法较为简单，且执行效率不是关键问题时；</p></li><li><p>当问题重复出现，且可以用一种简单的语言来进行表达时；</p></li><li><p>当一个语言需要解释执行，并且语言中的句子可以表示为一个抽象语法树的时候，如 XML 文档解释。</p></li></ul><h2 id="TO-BE-CONTINUE"><a href="#TO-BE-CONTINUE" class="headerlink" title="TO BE CONTINUE!"></a>TO BE CONTINUE!</h2>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何将一个单链表逆置？</title>
      <link href="/2019/02/28/ListReverseDemo/"/>
      <url>/2019/02/28/ListReverseDemo/</url>
      
        <content type="html"><![CDATA[<h2 id="如何将一个单链表逆置？"><a href="#如何将一个单链表逆置？" class="headerlink" title="如何将一个单链表逆置？"></a>如何将一个单链表逆置？</h2><p><img src="/2019/02/28/ListReverseDemo/image-20190302002632947.png" alt></p><p>链表的节点</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ListNode</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>    <span class="token keyword">public</span> ListNode next<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ListNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> value <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><h4 id="普通解法"><a href="#普通解法" class="headerlink" title="普通解法"></a>普通解法</h4><p>链表的逆置最容易想到是利用一个栈的结构，该算法的时间复杂度为o(n)，空间复杂度同样为o(n)。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> ListNode <span class="token function">reverseListByStack</span><span class="token punctuation">(</span>ListNode head<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>head <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    Stack<span class="token operator">&lt;</span>Integer<span class="token operator">></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>head <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>        stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        head <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    ListNode newHead <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span>stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ListNode p <span class="token operator">=</span> newHead<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 取出栈中的元素，构造新链表</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        ListNode node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span>stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>        p <span class="token operator">=</span> node<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> newHead<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    ListNode node1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ListNode node2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ListNode node3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ListNode node4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    node1<span class="token punctuation">.</span>next <span class="token operator">=</span> node2<span class="token punctuation">;</span>    node2<span class="token punctuation">.</span>next <span class="token operator">=</span> node3<span class="token punctuation">;</span>    node3<span class="token punctuation">.</span>next <span class="token operator">=</span> node4<span class="token punctuation">;</span>    node1 <span class="token operator">=</span> <span class="token function">reverseListByStack</span><span class="token punctuation">(</span>node1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>node1 <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>node1<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        node1 <span class="token operator">=</span> node1<span class="token punctuation">.</span>next<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="高级解法"><a href="#高级解法" class="headerlink" title="高级解法"></a>高级解法</h4><p>只额外使用了两个只针，这种解法的空间复杂度能达到o(1)，时间复杂度同样为o(n)。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> ListNode <span class="token function">reverseList</span><span class="token punctuation">(</span>ListNode head<span class="token punctuation">)</span> <span class="token punctuation">{</span>    ListNode pre <span class="token operator">=</span> null<span class="token punctuation">;</span>    ListNode next <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>head <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>        next <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        head<span class="token punctuation">.</span>next <span class="token operator">=</span> pre<span class="token punctuation">;</span>        pre <span class="token operator">=</span> head<span class="token punctuation">;</span>        head <span class="token operator">=</span> next<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> pre<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    ListNode node1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ListNode node2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ListNode node3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ListNode node4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListNode</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    node1<span class="token punctuation">.</span>next <span class="token operator">=</span> node2<span class="token punctuation">;</span>    node2<span class="token punctuation">.</span>next <span class="token operator">=</span> node3<span class="token punctuation">;</span>    node3<span class="token punctuation">.</span>next <span class="token operator">=</span> node4<span class="token punctuation">;</span>    node1 <span class="token operator">=</span> <span class="token function">reverse</span><span class="token punctuation">(</span>node1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>node1 <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>node1<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        node1 <span class="token operator">=</span> node1<span class="token punctuation">.</span>next<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>具体步骤，如下图：</p><p><img src="/2019/02/28/ListReverseDemo/image-20190302003014433.png" alt></p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 算法 </tag>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2019/02/28/hello-world/"/>
      <url>/2019/02/28/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class=" language-bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class=" language-bash"><code class="language-bash">$ hexo server</code></pre><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class=" language-bash"><code class="language-bash">$ hexo generate</code></pre><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class=" language-bash"><code class="language-bash">$ hexo deploy</code></pre><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>JVM原理</title>
      <link href="/2017/03/03/jvm-principle/"/>
      <url>/2017/03/03/jvm-principle/</url>
      
        <content type="html"><![CDATA[<p>对于Java程序员来说，在虚拟机自动内存管理机制的帮助下，不再需要为每一个创建对象操作去写配对的delete/free代码，不容易出现内存泄漏和内存溢出问题，由于虚拟机管理内存这一切看起来很美好。不过，也正是因为Java程序员把内存控制权交给了Java虚拟机，一旦出现内存泄漏和溢出方面的问题，如果不了解虚拟机是怎样使用内存的，那么排查错误将成为一项异常艰辛的工作。后面讲从概念上介绍Java虚拟机内存的各个区域。</p><h2 id="一、运行时数据区域"><a href="#一、运行时数据区域" class="headerlink" title="一、运行时数据区域"></a>一、运行时数据区域</h2><p>Java虚拟机在执行Java程序的过程中会把它所管理的内存划分成若干个不同的数据区域。这些区域都有各自的用途，以及创建和销毁的时间，有的区域随着虚拟机进程的启动而存在，有些区域则依赖用户线程的启动和结束而创建和销毁。根据<a href="https://docs.oracle.com/javase/specs/jvms/se7/html/index.html" target="_blank" rel="noopener">《Java虚拟机规范（Java SE 7 版）》</a>的规定，Java虚拟机所管理的内存包括以下几个运行时数据区域，如下图：</p><p><img src="/2017/03/03/jvm-principle/JavaRuntimeDataArea.png" alt></p><p>运行时数据区域包括：方法区、堆、虚拟机栈、本地方法栈、程序计数器；</p><h3 id="1-程序计数器"><a href="#1-程序计数器" class="headerlink" title="1.程序计数器"></a>1.程序计数器</h3><p><strong>程序计数器</strong>是一块较小的内存空间，它可以看作是<strong>当前线程</strong>所执行的字节码的行号指示器。字节码指令中的分支、循环、跳转、异常处理、线程恢复等功能都需要依赖这个计数器来完成。</p><p>由于Java虚拟机的多线程是通过线程轮流切换并分配处理器执行时间的方式来实现的，在任何一个确定的时刻，一个处理器（多核处理器的一个核心）都只会执行一条线程中的指令。因此，为了线程切换后能恢复到正确的执行位置，每条线程都需要一个独立的程序计数器，各个线程之间的计数器互不影响，独立存储，所以程序计数器为“线程私有”的内存。</p><p>此内存区域是唯一一个在Java虚拟机规范只能够没有规定任何OutOfMemoryError情况的区域。</p><h3 id="2-虚拟机栈"><a href="#2-虚拟机栈" class="headerlink" title="2.虚拟机栈"></a>2.虚拟机栈</h3><p><strong>虚拟机栈</strong>也是线程私有的内存区域，它的生命周期与线程相同。虚拟机栈描述的是Java方法执行的内存模型：每个方法在执行的同时都会创建一个栈帧用于存储<strong>局部变量表</strong>、<strong>操作数栈</strong>、<strong>动态链接</strong>、<strong>方法出口</strong>等信息。每个方法从调用直至执行完成的过程，就时对应着一个栈帧在虚拟机栈总入栈到出栈的过程。</p><p>局部变量表存放了在编译期可知的各种基本数据类型（boolean、byte、char、short、int、float、long、double）和对象引用（reference类型）。局部变量表所需要的内存空间在编译期间完成分配，当进入一个方法时，这个方法需要在栈帧中分配多大的局部变量空间是完全确定的，在方法运行期间不会改变局部变量表的大小。</p><p>在Java虚拟机规范中，对这个区域规定了2种异常情况：</p><ul><li>如果线程请求的栈深度大于虚拟机所允许的深度，将抛出StackOverflowError异常；</li><li>如果虚拟机栈可以动态扩展（当前大部分的虚拟机都可以动态扩展，只不过Java虚拟机规范中也允许固定长度的虚拟机栈），如果扩展时无法申请到足够的内存，就会跑出OutOfMemoryError异常。</li></ul><h3 id="3-本地方法栈"><a href="#3-本地方法栈" class="headerlink" title="3.本地方法栈"></a>3.本地方法栈</h3><p><strong>本地方法栈</strong>与虚拟机栈的作用非常类似，它们之间的区别不过是虚拟机栈是为虚拟机执行Java方法服务，而本地方法栈则为虚拟机使用到的native方法服务。与虚拟机栈一样，本地方法栈区域也会抛出StackOverflowError和OutOfMemoryError异常。</p><h3 id="4-堆"><a href="#4-堆" class="headerlink" title="4.堆"></a>4.堆</h3><p><strong>堆</strong>是Java虚拟机所管理的内存中最大的一块。堆是被所以线程所共享的一块内存区域，在虚拟机启动时创建。此内存区域的唯一目的就是存放对象实例，几乎所有的对象实例和数组都在这里分配内存。</p><p>堆是垃圾收集器管理的主要区域。</p><p>从内存的回收角度来看，由于现在的收集器基采用了分代收集算法，所以堆还可以化分为：新生代和老年代。新生代可以再分为Eden空间、From Survivor空间、To Survivor空间。</p><p>从内存分配的角度来看，线程共享的堆中可能划分出多个线程私有分配缓冲区（Thread Local Allocation Buffer，TLAB）。</p><p>无论如何划分，都与存放内容无关，无论哪个区域，存储的都是对象实例，进一步划分的目的是为了更好的回收内存，或者更快的分配内存。</p><p>根据Java虚拟机规范的规定，堆可以处在物理上不连续的内存空间中，只要逻辑上是连续的即可，就像磁盘空间一样。既可以是固定大小的，也可以是扩展的，具体可以通过-Xmx和-Xms控制。如果堆中没有内存完成实例分配，并且也无法扩展时，将会抛出OutOfMemoryError异常。</p><h3 id="5-方法区"><a href="#5-方法区" class="headerlink" title="5.方法区"></a>5.方法区</h3><p><strong>方法区</strong>与堆一样是所有线程共享的内存区域，它用于存储已经被虚拟机加载的<strong>类信息</strong>、<strong>常量</strong>、<strong>静态变量</strong>、<strong>即时编译后的代码</strong>等数据。理论上属于运行时数据区的一部分，为了和堆（Heap）区分，它有一个别名叫做非堆（Non-Heap）。</p><p>这个区域可以选择不进行内存回收，该区域回收的目标主要是针对常量池回收和对类型的卸载。内存不足时会抛出OutOfMemoryError异常。</p><p><strong>运行时常量池</strong>：它是方法区的一部分。Class的版本、字段、方法、接口等，以及编译期生成的各种字面量、符号引用，这部分内容将在类加载后存放到运行时常量池中。</p><h2 id="二、直接内存"><a href="#二、直接内存" class="headerlink" title="二、直接内存"></a>二、直接内存</h2><p><strong>直接内存（Direct Memory）</strong>并不是虚拟机运行时数据区的一部分，也不是Java虚拟机规范中定义的内存区域，但也会抛出OutOfMemoryError异常。</p><p>在JDK1.4中新加入了NIO（New Input/Output），引入了一种基于通道（Channel）与缓冲区（Buffer）的IO方式，它可以使用Native函数库直接分配堆外内存，然后通过一个存储在Java堆中的DirectByteBuffer对象作为这块内存的引用进行操作。这样能在一些场景中显著提高性能，因此避免了Java堆和Native堆中来回复制数据。</p><p>直接内存的分配不受Java堆大小的限制，但是会受到本机总内存大小和处理器寻址空间的限制。</p><h2 id="三、对象的内存布局"><a href="#三、对象的内存布局" class="headerlink" title="三、对象的内存布局"></a>三、对象的内存布局</h2><p>在HotSpot虚拟机中，对象在内存中存储的布局可以分为3块区域：<strong>对象头（Header）</strong>、<strong>实例数据（Instance Data）</strong>、<strong>对齐填充（Padding）</strong>。</p><h3 id="1-对象头（Header）"><a href="#1-对象头（Header）" class="headerlink" title="1.对象头（Header）"></a>1.对象头（Header）</h3><p>对象头包括两部分信息：</p><ul><li><p>第一部分为Mark Word，用于存储对象自身的运行时数据，如哈希码（HashCode）、GC分代年龄、锁状态标志、线程吃药的锁、偏向线程ID、偏向时间戳等。Mark Word在32位JVM中的长度是32bit，在64位JVM中长度是64bit。例如，在32位的HotSpot虚拟机中，如果对象处于未被锁定的状态下，那么MarkWord的32位空间中的25位用于存储对象哈希码，4位用于存储对象分代年龄，2位用于存储锁标志位，1位固定为0。</p><p><img src="/2017/03/03/jvm-principle/MarkWord.png" alt></p><p>其中<strong>无锁</strong>和<strong>偏向锁</strong>的锁标志位都是01，只是在前面的1bit区分了这是无锁状态还是偏向锁状态。</p><p>JDK1.6对锁进行了优化，以后的版本在处理同步锁时存在锁升级的概念，JVM对于同步锁的处理是从<strong>偏向锁</strong>开始的，随着竞争越来越激烈，处理方式从<strong>偏向锁</strong>升级到<strong>轻量级锁</strong>，最终升级到<strong>重量级锁</strong>。</p><p>JVM一般是这样使用锁和Mark Word的：</p><ul><li><p>（1）当没有被当成锁时，这就是一个普通的对象，Mark Word记录对象的HashCode，锁标志位是01，是否偏向锁那一位是0，表示<strong>无锁</strong>。</p></li><li><p>（2）当对象被当做同步锁并有一个线程A抢到了锁时，锁标志位还是01，但是否偏向锁那一位改成1，前23bit记录抢到锁的线程ID，表示进入<strong>偏向锁</strong>状态。</p></li><li><p>（3）当线程A再次试图来获得锁时，JVM发现同步锁对象的标志位是01，是否偏向锁是1，也就是偏向状态，Mark Word中记录的线程ID就是线程A自己的ID，表示线程A已经获得了这个偏向锁，可以执行同步锁的代码。</p></li><li><p>（4）当另一个线程B试图获得这个锁时，JVM发现同步锁处于偏向状态，但是Mark Word中的线程ID记录的不是B，那么线程B会先用CAS操作试图获得锁，这里的获得锁操作是有可能成功的，因为线程A一般不会自动释放偏向锁。如果抢锁成功，就把Mark Word里的线程ID改为线程B的ID，代表线程B获得了这个偏向锁，可以执行同步锁代码。如果抢锁失败，则继续执行步骤（5）。</p></li><li><p>（5）偏向锁状态抢锁失败，代表当前锁有一定的竞争，偏向锁将升级为<strong>轻量级锁</strong>。JVM会在当前线程的线程栈中开辟一块单独的空间，里面保存指向对象锁Mark Word的指针，同时在对象锁Mark Word中保存指向这片空间的指针。上述两个保存操作都是CAS操作，如果保存成功，代表线程抢到了同步锁，就把Mark Word中的锁标志位改成00，可以执行同步锁代码。如果保存失败，表示抢锁失败，竞争太激烈，继续执行步骤（6）。</p></li><li><p>（6）轻量级锁抢锁失败，JVM会使用自旋锁，自旋锁不是一个锁状态，只是代表不断的重试，尝试抢锁。从JDK1.7开始，自旋锁默认启用，自旋次数由JVM决定。如果抢锁成功则执行同步锁代码，如果失败则继续执行步骤（7）。</p></li><li><p>（7）自旋锁重试之后如果抢锁依然失败，同步锁会升级至<strong>重量级锁</strong>，锁标志位改为10。在这个状态下，未抢到锁的线程都会被阻塞。</p></li></ul></li><li><p>第二部分是类型指针，它是指向<strong>方法区</strong>对象类型数据的指针，如果是数组对象的话，还会有一个额外的部分存储数组长度。</p></li></ul><p>###2.实例数据（Instance Data）</p><p>实例数据是对象真正存储的有效信息，也是在程序代码中所定义的各种类型的字段内容。</p><h3 id="3-对齐填充（Padding）"><a href="#3-对齐填充（Padding）" class="headerlink" title="3.对齐填充（Padding）"></a>3.对齐填充（Padding）</h3><p>对齐填充并不是必然存在的，也没有特别的含义，它仅仅起着占位符的作用。</p><h2 id="四、对象的访问定位"><a href="#四、对象的访问定位" class="headerlink" title="四、对象的访问定位"></a>四、对象的访问定位</h2><p>建立对象是为了使用对象，Java程序需要通过栈上的reference数据来操作堆上的具体对象。由于reference类型在Java虚拟机规范中规定了一个指向对象的引用，并没有定义这个引用应该通过何种方式去定位、访问堆中的对象的具体位置。所以对象的访问方式也是取决于虚拟机实现而定的。目前主流的访问方式有<strong>使用句柄</strong>和<strong>直接指针</strong>两种。</p><h3 id="1-句柄方式访问"><a href="#1-句柄方式访问" class="headerlink" title="1.句柄方式访问"></a>1.句柄方式访问</h3><p>如果使用句柄访问的话，那么Java堆中将会划分出一块内存来作为<strong>句柄池</strong>，reference中存储的就是对象的句柄地址，而句柄中包含了对象实例数据与类型数据各自的具体地址信息。</p><p><img src="/2017/03/03/jvm-principle/ObjectHandlerAccess.png" alt></p><p>使用句柄来访问的最大好处就是reference中存储的是稳定的句柄地址，在对象被移动（垃圾收集时移动对象时非常普遍的行为）时只会改变句柄中的实例数据指针，而reference本身不需要改变。</p><h3 id="2-直接指针式访问"><a href="#2-直接指针式访问" class="headerlink" title="2.直接指针式访问"></a>2.直接指针式访问</h3><p>如果使用直接指针访问，那么Java堆对象的布局中就必须考虑如何放置访问类型数据的地址信息，而reference存储的直接就是对象地址。</p><p><img src="/2017/03/03/jvm-principle/ObjectDirectPointerAccess.png" alt></p><p>使用直接地址访问方式的最大好处就是速度快，它节省了一次指针定位的时间开销，由于对象的访问在Java中非常频繁，因此这类开销积少成多后也是一项非常可观的指向成本。就Hotspot虚拟机而言，它是使用的第二种方式进行访问的。</p><h2 id="五、内存区域控制参数及对应溢出异常"><a href="#五、内存区域控制参数及对应溢出异常" class="headerlink" title="五、内存区域控制参数及对应溢出异常"></a>五、内存区域控制参数及对应溢出异常</h2><p>在Java虚拟机规范的描述中，除了程序计数器外，虚拟机内存的其他几个运行时数据区域都有可能发生OutOfMemoryError异常（以下简称OOM）。</p><p>在开发过程中或程序运行过程中每次遇到OOM异常或StackOverflowError异常或GC异常时，我们需要根据异常信息来快速判断时哪个区域的异常，知道怎样的代码可能会导致这些区域的异常，以及出现这些异常后改怎么处理。下面就来介绍一下每个区域可能抛出的异常类型、发生异常的场景以及内存区域对象的参数。</p><h3 id="1-堆内存"><a href="#1-堆内存" class="headerlink" title="1.堆内存"></a>1.堆内存</h3><p>常用参数：</p><ul><li><p>-Xms：堆最小值</p></li><li><p>-Xmx：堆最大值</p></li><li><p>其他：-XX:+HeapDumpOnOutOfMemoeryError可以让虚拟机在出现内存溢出异常时Dump当前的内存堆转储快照一般事后进行分析。</p></li></ul><p>例：-Xms128M -Xmx=128M</p><p>通常将-Xmx和-Xms设置为一样的大小来减少gc的次数，堆内存不足时抛出OOM异常。</p><p>Java堆内存的OOM异常时实际应用中常见的内存溢出异常情况。当出现Java堆内存溢出时，异常堆栈信息“java.lang.OutOfMemoryError”会跟着进一步提示“Java heap space”。</p><p>要解决着区域的异常，一般的手段是先通过内存映像分析工具（如Eclipse Memory Analyzer）对Dump出来的堆转储快照进行分析，重点是确认内存中的对象是否必要的，也就要先分清楚到底是出现了内存泄漏还是内存溢出。</p><h3 id="2-栈内存（虚拟机栈和本地方法栈）"><a href="#2-栈内存（虚拟机栈和本地方法栈）" class="headerlink" title="2.栈内存（虚拟机栈和本地方法栈）"></a>2.栈内存（虚拟机栈和本地方法栈）</h3><p>常用参数：-Xss，例如：-Xss128K。</p><p>关于虚拟机栈和本地方法栈，在虚拟机规范中描述了两种异常：</p><ul><li><p>如果线程请求的栈深度大于虚拟机所允许最大深度，将抛出StackOverflowError异常；</p></li><li><p>如果虚拟机栈在扩展栈是无法申请足够的内存空间，则抛出OutOfMemoryError异常；</p></li></ul><h3 id="3-方法区内存"><a href="#3-方法区内存" class="headerlink" title="3.方法区内存"></a>3.方法区内存</h3><p>常用参数：</p><ul><li><p>-XX:PermSize方法区内存最小值</p></li><li><p>-XX:MaxPermSize方法区内存最大值</p></li></ul><p>例：-XX:PermSize=200M -XX:MaxPermSize=200M</p><p>异常类型：OutOfMemoryError</p><p>因为方法区用于存放加载的类信息、常量、静态变量、即时编译后的代码等数据，所以产生类过多就可能出方法区异常异常。当前的很多框架，例如Spring、Hibernate，在多类进行增强时，都会使用CGLib字节码技术，增强的类越多，就需要越大的方法区来保证动态生成的Class可以加载入内存。</p><h3 id="4-直接内存"><a href="#4-直接内存" class="headerlink" title="4.直接内存"></a>4.直接内存</h3><p>常用参数：-XX:MaxDirectMemorySize，例如：-XX:MaxDirectMemorySize=100M。如果不指定则与堆的最大值相同。</p><p>异常：OutOfMemoryError</p><h2 id="六、垃圾收集算法"><a href="#六、垃圾收集算法" class="headerlink" title="六、垃圾收集算法"></a>六、垃圾收集算法</h2><h3 id="1-怎么确定对象可被回收"><a href="#1-怎么确定对象可被回收" class="headerlink" title="1.怎么确定对象可被回收"></a>1.怎么确定对象可被回收</h3><p>在堆里面存放Java中几乎所有的对象实例。垃圾收集器在对堆进行回收之前，第一件事情就是要确定这些对象之中哪些还“存活”着，哪些已经“死去”。</p><h4 id="引用计数算法"><a href="#引用计数算法" class="headerlink" title="引用计数算法"></a>引用计数算法</h4><p>给对象添加一个引用计数器，每当有一个地方引用它时，计数器就加1；当引用失效时，计数器值就减1；任何时刻计数器为0的对象就是不能在使用的。</p><p>客观地说，引用计数算法的实现很简单，判断效率也很高，在大部分情况下它都是一个不错的算法，也有一些著名的应用案例。但是，至少主流的Java虚拟机里面没有选用引用计数器算法来管理内存，其中主要的原因时它很难解决对象之间循环引用的问题。</p><p>举个简单的例子：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReferenceCountingGC</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span>  Object instance <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> _1MB <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 这个成员属性的唯一意义就是占点内存，以便在GC日志中看情况是否内回收过     */</span>    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bigSize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> _1MB<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testGC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        ReferenceCountingGC objA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceCountingGC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ReferenceCountingGC objB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceCountingGC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        objA<span class="token punctuation">.</span>instance <span class="token operator">=</span> objB<span class="token punctuation">;</span>        objB<span class="token punctuation">.</span>instance <span class="token operator">=</span> objA<span class="token punctuation">;</span>        objA <span class="token operator">=</span> null<span class="token punctuation">;</span>        objB <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//假设这行发生GC，objA和objB是否能被回收？</span>        System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">testGC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>在idea设置vm参数，让程序运行后打印GC日志，“-Xms50M -Xmx100M -XX:+PrintGCDetails -Xloggc:./gc.log”</p><p><img src="/2017/03/03/jvm-principle/idea-vm-params.png" alt></p><p>在输出的GC日志中可以看到“6679K-&gt;704K”，意味着虚拟机并没有因为这两个对象互相引用就不回收它们，这也从侧面说明虚拟机并不是通过引用计数算法来判断对象是否存活的。</p><pre><code>0.188: [GC (System.gc()) [PSYoungGen: 6679K-&gt;704K(14848K)] 6679K-&gt;712K(49152K), 0.0010985 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 0.189: [Full GC (System.gc()) [PSYoungGen: 704K-&gt;0K(14848K)] [ParOldGen: 8K-&gt;596K(34304K)] 712K-&gt;596K(49152K), [Metaspace: 3074K-&gt;3074K(1056768K)], 0.0053940 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] Heap PSYoungGen      total 14848K, used 256K [0x00000007bdf00000, 0x00000007bef80000, 0x00000007c0000000)  eden space 12800K, 2% used [0x00000007bdf00000,0x00000007bdf40190,0x00000007beb80000)  from space 2048K, 0% used [0x00000007beb80000,0x00000007beb80000,0x00000007bed80000)  to   space 2048K, 0% used [0x00000007bed80000,0x00000007bed80000,0x00000007bef80000) ParOldGen       total 34304K, used 596K [0x00000007b9c00000, 0x00000007bbd80000, 0x00000007bdf00000)  object space 34304K, 1% used [0x00000007b9c00000,0x00000007b9c953c8,0x00000007bbd80000) Metaspace       used 3086K, capacity 4496K, committed 4864K, reserved 1056768K  class space    used 335K, capacity 388K, committed 512K, reserved 1048576K</code></pre><h4 id="可达性分析算法"><a href="#可达性分析算法" class="headerlink" title="可达性分析算法"></a>可达性分析算法</h4><p>在主流的商用程序语言（Java、C#）的主流实现中，都是通过可达性分析来判定对象是否存活的。可达性分析算法的基本思路就是通过一些列的称为“GC Roots”的对象作为起始点，从这些节点开始向下搜索，搜索所走的路径称为引用链（Reference Chain），当一个对象到GC Roots没有任何引用链相连（用图伦的话来说，就是从GC Roots 到这个对象不可达）时，则证明此对象时不可用的。ReachabilityAnalysis</p><p><img src="/2017/03/03/jvm-principle/ReachabilityAnalysis.png" alt></p><p>在Java语言中，可作为GC Roots的对象包括下面4种：</p><ul><li><p>虚拟机栈（栈帧中的本地变量表）中引用的对象；</p></li><li><p>方法区中类静态属性引用的对象；</p></li><li><p>方法区中常量引用的对象；</p></li><li><p>本地方法栈中（即一般说的Native方法）引用的对象。</p></li></ul><p>在JDK1.2之后，Java对引用的概念进行了扩充，将引用分为<strong>强引用（Strong Reference）</strong>、<strong>软引用（Soft Reference）</strong>、<strong>弱引用（Weak Reference）</strong>、<strong>虚引用（Phantom Reference）</strong>4种，这4种引用强度依次逐渐减弱。</p><ul><li><p><strong>强引用</strong>就是指在程序代码中普遍存在的，类似“Object obj = new Object()”这类的引用，只要强引用还存在，垃圾收集器永远不会回收掉被引用的对象。</p></li><li><p><strong>软引用</strong>是用来描述一些还有用但并非必需的对象。对于软引用关联着的对象，在系统将要发生内存溢出异常之前，将会把这些对象列进回收范围之中进行第二次回收。如果这次回收还没有足够的内存，才会抛出内存溢出异常。在JDK1.2之后，提供了SoftReference来实现软引用。</p></li><li><p><strong>弱引用</strong>也是用来描述非必需对象的，但是它的强度比软引用还要弱一些，被弱引用关联的对象只能生存到下一次垃圾收集之前。当垃圾收集器工作时，无论当前内存是否足够，都会回收掉只被弱引用关联的对象。在JDK1.2之后，提供了WeakReference类来实现弱引用。</p></li><li><p><strong>虚引用</strong>也成为幽灵引用或虚幻引用，它是最弱的一种引用关系。一个对象是否有虚引用的存在，完全不会对其生存时间构成影响，也无法通过虚引用来取得一个对象实例。为一个对象设置虚引用关联的唯一目的就是能在这个对象被收集器回收时收到一个系统通知。在JDK1.2之后，提供了PhantomReference类来实现虚引用。</p></li></ul><h3 id="2-垃圾收集算法"><a href="#2-垃圾收集算法" class="headerlink" title="2.垃圾收集算法"></a>2.垃圾收集算法</h3><h4 id="标记-清除算法"><a href="#标记-清除算法" class="headerlink" title="标记-清除算法"></a>标记-清除算法</h4><p>最基础的收集算法是<strong>“标记-清除”（Mark-Sweep）</strong>算法，算法分为“标记”和“清除”两个阶段：标记阶段：首先标记出所有需要回收的对象，在标记完成后统一回收所有标记的对象。其他的收集算法都是基于标记清除算法基础上进行改进得到的。</p><p>主要缺点：</p><p>一个是效率问题，标记和清除两个过程的效率都不高；</p><p>另一个是空间问题，标记清除之后会产生大量不连续的内存碎片。</p><p><img src="/2017/03/03/jvm-principle/MarkSweep.png" alt></p><h4 id="复制算法"><a href="#复制算法" class="headerlink" title="复制算法"></a>复制算法</h4><p>为了解决效率问题，一种称为<strong>“复制”（Copying）</strong>的收集算法出现了，它将可用的内存容量划分大小相等的两块，每次只使用其中的一块。当着一块的内存用完了，就将还存活着的对象复制到另一块上面，然后再把已经使用过的内存空间一次清理掉。这种算法的代价就是将内存缩小为原理的一半，未免也太高了一点。</p><p><img src="/2017/03/03/jvm-principle/Copying.png" alt></p><p>在商用的虚拟中使用该算法回收新生代，由研究表明，新生代中的对象98%是“朝生夕死”的，并不需要按照1:1的比例来划分内存，而是将内存分为一块较大的<strong>Eden空间</strong>和两块小的<strong>Survivor空间</strong>，每次使用Eden和其中一块Survivor。当回收时，将Eden和Survivor中还存活着的对象一次性地复制到另一块Survivor空间上，最后清理掉Eden和刚才用过的Survivor空间。HotSpot虚拟机默认Eden和Survivor的大小比例是8:1，也就是每次新生代中可用内存空间为整个新生代容量的90%（80%+10%），只有10%的内存会被“浪费”。</p><p>当然98%的对象可以回收这只是一般场景下的数据，我们没有办法保证每次回收都只有不到10%的对象存活，当Survivor空间不够用时，需要依赖其他内存（这里指老年代）进行分配担保（Handle Promotion）。</p><p>优点：</p><p>比较标记清除算法，避免了回收造成的内存碎片；</p><p>缺点：</p><p>以牺牲空间为代价，复制也有一定的效率和空间成本。</p><h4 id="标记整理算法"><a href="#标记整理算法" class="headerlink" title="标记整理算法"></a>标记整理算法</h4><p>前面的讲解的复制算法在对象存活率较高时就需要进行多次的复制操作，效率将会降低，更关键的是如果不想浪费50%的空间，就需要有额外的空间进行分配担保，以应对被使用的的内存中所以对象都100%存活的极端情况，所以在<strong>老年代</strong>一般不直接采用这种算法。</p><p>更加老年代对象存活率高的特点，有人提出了另外一种“标记-整理”（Mark-Compact）算法，标记过程任然与“标记-清除”算法一样，但后面步骤不在是直接对可回收对象进行清理，而是让所以存活的对象都向一端移动，然后直接清理掉端边界以外的内存。</p><p><img src="/2017/03/03/jvm-principle/MarkCompact.png" alt></p><h4 id="分代收集算法"><a href="#分代收集算法" class="headerlink" title="分代收集算法"></a>分代收集算法</h4><p>当前商业虚拟机的懒觉收集都采用“分代收集”（Generational Collection）算法，这种算法并没有什么新的思想，只是根据对象存活周期的不同将内存划分为几块。一般把内存划分为新生代和老年代2块，这样就可以根据各个年代的特点采用最合适的收集算法。在新生代中，每次垃圾收集时都发现有大量的对象死去，只有少量存活，那就选用户<strong>复制算法</strong>。而老年代中因为对象存活率高，没有额外的空间对它进行分配担保，就必须使用“标记-清理”或“标记-整理”算法来进行回收。</p><h2 id="七、垃圾收集器"><a href="#七、垃圾收集器" class="headerlink" title="七、垃圾收集器"></a>七、垃圾收集器</h2><p>Java虚拟机规范中对垃圾收集器应该如何实现并没有任何规定，因此不同的厂商、不同版本的虚拟机所提供的垃圾收集器都可能会有很大差别，并且一般都会提供参数供用户根据自己的应用特点和要求组合出各个年代所使用的收集器。</p><p><img src="/2017/03/03/jvm-principle/GarbageCollector.png" alt></p><h3 id="1-Serial-收集器"><a href="#1-Serial-收集器" class="headerlink" title="1.Serial 收集器"></a>1.Serial 收集器</h3><p>特点：</p><p>（1）新生代收集器，可以和Serial Old、CMS组合使用；</p><p>（2）采用复制算法；</p><p>（3）使用单线程进行垃圾回收，回收时会导致Stop The World，用户进程停止；</p><p>（4）Client模式新生代收集器；</p><p><img src="/2017/03/03/jvm-principle/Serial.png" alt></p><h3 id="2-ParNew-收集器"><a href="#2-ParNew-收集器" class="headerlink" title="2.ParNew 收集器"></a>2.ParNew 收集器</h3><p>特点：</p><p>（1）新生代收集器，可以和Serial Old、CMS组合使用；</p><p>（2）采用复制算法；</p><p>（3）使用多线程进行垃圾回收，回收时会导致Stop The World，其它策略和Serial一样；</p><p>（4）许多虚拟机Server模式的新生代收集器；</p><p><img src="/2017/03/03/jvm-principle/ParNew.png" alt></p><h3 id="3-Parallel-Scavenge-收集器"><a href="#3-Parallel-Scavenge-收集器" class="headerlink" title="3.Parallel Scavenge 收集器"></a>3.Parallel Scavenge 收集器</h3><p>特点：</p><p>（1）新生代收集器，可以和Serial Old、Parallel组合使用，不能和CMS组合使用；</p><p>（2）采用复制算法；</p><p>（3）使用多线程进行垃圾回收，回收时会导致Stop The World；</p><p>（4）关注吞吐量，吞吐量=运行用户代码时间/（运行用户代码时间+垃圾收集时间）；</p><p><img src="/2017/03/03/jvm-principle/ParallelScavenge.png" alt></p><h3 id="4-Serial-Old-收集器"><a href="#4-Serial-Old-收集器" class="headerlink" title="4.Serial Old 收集器"></a>4.Serial Old 收集器</h3><p>特点：</p><p>（1）老年代收集器，可以和所有的年轻代收集器组合使用，Serial收集器的老年代版本；</p><p>（2）标记-整理算法，会对垃圾回收导致的内存碎片进行整理；</p><p>（3）使用单线程进行垃圾回收，回收时会导致Stop The World，用户进程停止；</p><p><img src="/2017/03/03/jvm-principle/SerialOld.png" alt></p><h3 id="5-Parallel-Old-收集器"><a href="#5-Parallel-Old-收集器" class="headerlink" title="5.Parallel Old 收集器"></a>5.Parallel Old 收集器</h3><p>特点：</p><p>（1）年老代收集器，只能和Parallel Scavenge组合使用，Parallel Scavenge收集器的年老代版本，Stop The World；</p><p>（2）多线程，采用标记-整理算法，会对垃圾回收导致的内存碎片进行整理；</p><p>（3）关注吞吐量的系统可以将Parallel Scavenge + Parallel Old组合使用；</p><p><img src="/2017/03/03/jvm-principle/ParallelOld.png" alt></p><h3 id="6-CMS-收集器"><a href="#6-CMS-收集器" class="headerlink" title="6.CMS 收集器"></a>6.CMS 收集器</h3><p>特点：</p><p>（1）年老代收集器，可以和Serial、ParNew组合使用；</p><p>（2）采用标记-清除算法，可以通过设置参数在垃圾回收时进行内存碎片的整理；</p><p>（3）CMS是并发算法，表示垃圾回收和用户进行同时进行，但是不是所有阶段都同时进行，在初始标记、重新标记阶段还是需要Stop the World；</p><p>（4）CMS垃圾回收分这四个阶段，三次标记一次回收：</p><ul><li><p><strong>初始标记</strong>，Stop the World，标记一下GC Roots能直接关联到的对象，速度快；</p></li><li><p><strong>并发标记</strong>，GC Roots Tracing，时间长，不停止用户进程；</p></li><li><p><strong>重新标记</strong>，Stop the World，修正并发标记期间因用户程序继续运行导致标记变动的那一部分对象的标记记录，时间长，但远比并发标记时间短；</p></li><li><p><strong>并发清除</strong>，清除的同时用户进程会导致新的垃圾，时间长；</p></li></ul><p>5、适合于对响应时间要求高的系统，以最短回收停顿时间为目标；</p><p>缺点：</p><ul><li><p>对CPU资源非常敏感，并发且维护用户进程的代价；</p></li><li><p>无法处理浮动垃圾，清除时产生新垃圾；</p></li><li><p>由于使用标记清除，故有空间碎片；</p></li></ul><p><img src="/2017/03/03/jvm-principle/CMS.png" alt></p><h3 id="7-G1-收集器"><a href="#7-G1-收集器" class="headerlink" title="7.G1 收集器"></a>7.G1 收集器</h3><p>特点：</p><p>（1）并行并发，使用多个CPU缩短STW的时间；</p><p>（2）分代收集，不需要其他收集器配合也能独立管理堆；</p><p>（3）空间整合，整体基于标记整理算法，局部两个Region基于复制；</p><p>（4）可预测停顿，可以指定时间段M内GC过程时间不超过N；</p><p>（5）较低停顿，停顿时间更加可控可预测；</p><p>特殊点：</p><ul><li><p>新生代和老年代不再物理隔离，都是一部分Region的集合，将堆分为大小相等的Region；</p></li><li><p>G1跟踪各个Region垃圾的价值大小以及回收需要时间维护一个Region优先列表，每次先回收价值最大的Region，这是G1-Garbage First名字的由来；</p></li></ul><p>G1运作分四个阶段，三次标记一次回收：初始标记，并发标记，最终标记，筛选回收；</p><p><img src="/2017/03/03/jvm-principle/G1.png" alt></p><h3 id="垃圾收集器参数总结"><a href="#垃圾收集器参数总结" class="headerlink" title="垃圾收集器参数总结"></a>垃圾收集器参数总结</h3><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>-XX:+UseSerialGC</td><td>虚拟机运行在Client模式下的默认值，添加此配置后，使用Serial+Serial Old收集器组合进行内存回收。</td></tr><tr><td>-XX:+UseParNewGC</td><td>添加此配置后，使用ParNew+SerialOld收集器组合进行内存回收。</td></tr><tr><td>-XX:+UseConcMarkSweepGC</td><td>添加此配置后，使用ParNew+CMS+SerialOld收集器组合进行内存回收。Serial Old手机器作为CMS收集器Concurrent Mode Failure失败后的备用手机器。</td></tr><tr><td>-XX:+UseParallelGC</td><td>虚拟机运行在Sever模式下的默认值，添加此配置后，使用Parallel  Scavenge  + Serial Old（PS MarkSweep）收集器组合进行内存回收</td></tr><tr><td>-XX:+UseParallelOldGC</td><td>添加此配置后，使用Parallel Scavenge + Parallel Old收集器进行内存回收。</td></tr><tr><td>-XX:SurvivorRatio</td><td>新生代中Eden区域与Survivor区域的容量比值，默认为8，代表Eden:Survivor = 8:1</td></tr><tr><td>-XX:PretenureSizeThreshold</td><td>直接晋升到老年代的对象大小，设置这个参数后，大于这个参数的对象将直接在老年代分配</td></tr><tr><td>-XX:MaxTenuringThreshold</td><td>晋升到老年代的对象年龄。每个对象在坚持过一次MinorGC之后，年龄就增加1，当超过这个参数值是就进入老年代</td></tr><tr><td>-XX:UseAdaptiveSizePolicy</td><td>动态调整Java堆中各个区域的大小以及进入老年代的年龄</td></tr><tr><td>-XX:HandlePromotionFailure</td><td>是否允许分配担保失败，即老年代的剩余空间不足以应对新生代的整个Eden和Survivor区的所有对象都存活的极端情况</td></tr><tr><td>-XX:ParalelGCThreads</td><td>设置并行GC时进行内存回收的线程数</td></tr><tr><td>-XX:GCTimeRatio</td><td>GC时间占总时间的比率，默认值为99，即允许1%的GC时间。仅在使用Parallel Scavenge收集器时生效</td></tr><tr><td>-XX:MaxGCPauseMillis</td><td>设置GC的最大停顿时间。仅在使用Parallel Scavenge收集器时生效</td></tr><tr><td>-XX:CMSInitiatingOccupancyFraction</td><td>设置CMS收集器在老年代空间被使用多少后触发垃圾收集。默认值为68%，仅在使用CMS收集器时生效</td></tr><tr><td>-XX:UseCMSCompacatAtFullCollection</td><td>实质CMS收集器在完成垃圾收集后是否要进行一次内存碎片整理。仅在使用CMS收集器时生效</td></tr><tr><td>-XX:CMSFullGCsBeforeCompaction</td><td>设置CMS收集器在进行若干次垃圾收集后再启动一次内存碎片整理。仅在使用CMS收集器时生效</td></tr></tbody></table><p>其他参数：</p><p>-verbose:gc或者-XX:+PrintGC，获取gc信息</p><p>-XX:+PrintGCDetails，获取更加纤细的gc信息</p><p>-XX:+PrintGCTimeStamps， 获取GC的频率和间隔</p><p>-XX:+PrintHeapAtGC，获取堆的使用情况</p><p>-XXloggc:D:\gc.log，指定GC日志的保存路径</p><h3 id="调优策略"><a href="#调优策略" class="headerlink" title="调优策略"></a>调优策略</h3><ul><li><strong>对象优先在新生代Eden区域分配</strong>：由于FullGC/MajorGC（发生在老年代），成本远比MinorGC（发生在新生代）要大的多，所以给应用分配一个合理的新生代空，尽量将对象优先分配到新生代，减少Full GC的频率。</li><li><strong>大对象直接进入老年代</strong>：将大对象（例如长字符串以及数组）直接分配到老年代，保持新生代对象的结构的完整行，以提高GC效率。可以通过-XX:PretenureSizeThreshold参数设置对象进入老年代的阀值。</li><li><strong>长期存活的对象直接进入老年代</strong>：对象晋升老年代的年龄阀值，可以通过参数-XX:MaxTenuringThreshold来设置。</li><li><strong>稳定的堆大小</strong>：稳定的堆大小时对垃圾回收有利的，把-Xms和-Xmx的大小设置一致。</li><li><strong>更加情况选择合适的收集器</strong>：吞吐量优先，尽可能减少系统执行垃圾回收的总时间，故采用并行收集器；低停顿：使用CMS收集器，同时减少Full GC的次数。</li></ul><h2 id="八、监控工具"><a href="#八、监控工具" class="headerlink" title="八、监控工具"></a>八、监控工具</h2><h3 id="1-JDK命令行工具"><a href="#1-JDK命令行工具" class="headerlink" title="1.JDK命令行工具"></a>1.JDK命令行工具</h3><p>Sun JDK 监控与故障处理工具</p><table><thead><tr><th>名称</th><th>主要作用</th></tr></thead><tbody><tr><td>jps</td><td>JVM Process Status Tool，显示指定系统内所有的虚拟机进程</td></tr><tr><td>jstat</td><td>JVM Statistics Monitoring Tool，用于收集虚拟机各方面的运行数据</td></tr><tr><td>jinfo</td><td>Configuration Info for Java，显示虚拟机配置信息</td></tr><tr><td>jmap</td><td>Memory Map for Java，生成虚拟机的内存转储快照（heapdump文件）</td></tr><tr><td>jhat</td><td>JVM Heap Dump Browser，用于分析heap dump文件，它会生成一个http服务器，让用户可以在浏览器上查看分析结果</td></tr><tr><td>jstack</td><td>Stack Trace for Java，显示虚拟机线程栈快照</td></tr></tbody></table><h4 id="（1）jps"><a href="#（1）jps" class="headerlink" title="（1）jps"></a>（1）jps</h4><p>JDK的很多小工具的名字都是参考了UNIX命令的命名方式，<strong>jps（JVM Process Status Tool）</strong>是其中的典型。它的功能和ps命令类似，可以列出正在运行的虚拟机进程，并显示虚拟机执行主类（Main Class，main()函数所在的类）名称以及这些进程的唯一ID（Local Virtual Machine Identifier，LVMID）。</p><p><strong>命令格式：jps [options] [hostid]</strong></p><p><strong>jps工具主要选项</strong></p><table><thead><tr><th>选项</th><th>作用</th></tr></thead><tbody><tr><td>-q</td><td>只输出LVMID，省略主类的名称</td></tr><tr><td>-m</td><td>输出虚拟机进程启动时传递给主类main()方法的参数</td></tr><tr><td>-l</td><td>输出主类的全名，如果进程执行的是Jar包，输出Jar路径</td></tr><tr><td>-v</td><td>输出虚拟机进程启动时JVM参数</td></tr></tbody></table><h4 id="（2）jstat"><a href="#（2）jstat" class="headerlink" title="（2）jstat"></a>（2）jstat</h4><p>jstat（JVM Statistics Monitoring Tool）是用于监控虚拟机各种运行状态信息的命令行工具。它可以显示本地或原创虚拟机中的类装载、内存、垃圾收集、JIT编译等运行数据，在没有GUI图形界面的服务器上，它是首选的一款监控工具。</p><p>命令格式：jstat [ option  vmid  [interval  [s|ms]  [count]] ]</p><p>命令格式解释：jstat 监控内容 线程号 时间间隔 次数</p><p>例如：jstat -gc 2045 1 20，每1秒查询一次进程2045的垃圾收集状况，一共执行20次。</p><p>jstat工具主要选项</p><table><thead><tr><th>选项</th><th>作用</th></tr></thead><tbody><tr><td>-class</td><td>监视类装载、卸载数量以及类的装载总空间和耗费时间</td></tr><tr><td>-gc</td><td>监视Java堆状况，包括Eden区、两个Survivor区、老年代、永久代等的容量、已用空间、GC时间和机等信息</td></tr><tr><td>-gccapacity</td><td>监视内容与-gc基本相同，但输出主要关注Java堆各个区域使用到的最大和最小空间</td></tr><tr><td>-gcutil</td><td>监视内容与-gc基本相同，但输出主要关注已使用空间占总空间的百分比</td></tr><tr><td>-gccause</td><td>与-gcutil功能一样，但是会额外输出导致上一次GC产生的原因</td></tr><tr><td>-gcnew</td><td>监控新生代GC状况</td></tr><tr><td>-gcnewcapacity</td><td>监视内容与-gcnew基本相同，输出主要关注使用到的最大和最小空间</td></tr><tr><td>-gcold</td><td>监控老年代GC状况</td></tr><tr><td>-gcoldcapacity</td><td>监视内容与-gcold基本相同，输出主要关注使用到的最大和最小空间</td></tr><tr><td>-gcpermcapacity</td><td>输出永久代使用的最大和最小空间</td></tr><tr><td>-compiler</td><td>输出JIT编译器编译过的方法、耗时信息</td></tr><tr><td>-printcompilation</td><td>输出已经被JIT编译的方法</td></tr></tbody></table><h4 id="（3）jinfo"><a href="#（3）jinfo" class="headerlink" title="（3）jinfo"></a>（3）jinfo</h4><p>jinfo（Configuration Info for Java）的作用是实时地查看和调整虚拟机各项参数信息。使用jinfo -v 可以查看虚拟机启动时显式指定的参数列表，但是如果想知道未被显式指定的参数的系统默认值，可以使用”jinfo -flag 参数名 线程ID”  进行查询。</p><p>命令格式：</p><p>jinfo [ option ] pid</p><p>例如：jinfo -flag CMSInitiatingOccupancyFraction 9668，输出 -XX:CMSInitiatingOccupancyFraction=-1</p><h4 id="（4）jmap"><a href="#（4）jmap" class="headerlink" title="（4）jmap"></a>（4）jmap</h4><p>jmap（Memory Map for Java）命令用于生成转储快照（heapdump）。如果不使用jmap命令，要想获取Java堆转储快照，还有一些比较“暴力”的方式，譬如：</p><ul><li><p>通过JVM启动时加入启动参数-XX:HeapDumpOutOfMemoryError参数，可以让JVM在出现内存溢出异常时自动生成dump文件；</p></li><li><p>也可以通过-XX:HeapDumpOnCtrlBreak参数，则在运行时可以使用ctrl + break键让虚拟机 生成dump文件；</p></li><li><p>又或者在Linux系统下通过Kill -3命令发送进程退出信号“吓唬”一下虚拟机也能获取dump文件。    </p></li></ul><p>jmap作用不仅仅是为了获取dump文件，还可以用于查询finalize执行队列、Java堆和永久代的详细信息，如空间使用率、当前使用的是哪种垃圾收集器。</p><p>命令格式：</p><p>jmap [ option ] vmid</p><p>例如：jmap -dump:format=b,file=eclipse.dum 1234</p><p>jmap工具主要选项</p><table><thead><tr><th>选项</th><th>作用</th></tr></thead><tbody><tr><td>-dump</td><td>生成Java堆转储快照，格式为：-dump:[live, ]format=b, file=<filename>,其中live子参数说明是否只dump出存活的对象</filename></td></tr><tr><td>-finalizerinfo</td><td>显示在F-Queue中等待的Finalizer线程执行finalize方法的对象（只在Linux/Solaris平台下有效）</td></tr><tr><td>-heap</td><td>显示Java堆详细信息，乳沟使用哪种回收器、参数配置、分代详情等（只在Linux/solaris平台下有效）</td></tr><tr><td>-histo</td><td>显示堆栈中的对象的统计信息，包含类、实例数量和合计容量</td></tr><tr><td>-permstat</td><td>以ClassLoader为统计口径显示永久代内存状态（只在Linux/Solaris平台下有效）</td></tr><tr><td>-F</td><td>当虚拟机进程对-dump选项没有响应时，可以用这个选项强制生成dump快照（只在Linux/Solaris平台下有效）</td></tr></tbody></table><h4 id="（5）jstack"><a href="#（5）jstack" class="headerlink" title="（5）jstack"></a>（5）jstack</h4><p>jstack（Stack Trace for Java）命令用于身材虚拟机当前时间的线程快照（一般称为threaddump或者javacore文件）。线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈的集合，生成线程快照主要目的是定位线程出现长时间停顿的原因，如线程间死锁、死循环、请求外部资源导致的长时间等待都是导致线程长时间停顿的常见原因。通过jstack我们就可以知道哪些进程在后台做些什么，在等待什么资源。</p><p>命令格式：</p><p>jstack [ option ] vmid</p><p>jstack工具主要选项</p><table><thead><tr><th>选项</th><th>作用</th></tr></thead><tbody><tr><td>-F</td><td>当正常输出的请求不被响应时，强制输出线程堆栈</td></tr><tr><td>-l</td><td>除堆栈外，显示关于锁的附加信息</td></tr><tr><td>-m</td><td>显示native方法的堆栈信息</td></tr></tbody></table><h4 id="（6）jhat"><a href="#（6）jhat" class="headerlink" title="（6）jhat"></a>（6）jhat</h4><p>Sun JDK提供jhat(JVM Heap Analysis Tool)命令与jmap搭配使用，来分析jmap生成的堆栈转储快照。jhat内置了一个微型的HTTP/HTML服务器，生成dump文件的分析结果后，可以在浏览器中查看。</p><h3 id="2-JDK可视化工具"><a href="#2-JDK可视化工具" class="headerlink" title="2.JDK可视化工具"></a>2.JDK可视化工具</h3><h4 id="（1）jconsole"><a href="#（1）jconsole" class="headerlink" title="（1）jconsole"></a>（1）jconsole</h4><h4 id="（2）jvisualvm"><a href="#（2）jvisualvm" class="headerlink" title="（2）jvisualvm"></a>（2）jvisualvm</h4><p><em>文章内容主要摘自《深入理解Java虚拟机-JVM高级特性与最佳实践》</em></p>]]></content>
      
      
      <categories>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JVM </tag>
            
            <tag> Java虚拟机 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
